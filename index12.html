<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  
  <link rel='stylesheet' href='http://www.softwaremeadows.com/css/default.css' />
<link rel='stylesheet' href='http://www.softwaremeadows.com/css/tango.css' />

  <title>Home | Software Meadows</title>
</head>

<body>
  <nav>
    <div id="menu">
      <ol>
<li><a href="http://www.softwaremeadows.com/">Home</a></li>
<li><a href="http://www.softwaremeadows.com/about">About</a></li>
</ol>

    </div>
    <div id="recent">
      <h2>Recent</h2>
      <a href='http://www.softwaremeadows.com/posts/announcing_deftconfig'>Announcing DeftConfig</a><a href='http://www.softwaremeadows.com/posts/tfs_2015_publish_asp_net_using_robocopy'>TFS 2015: Publish ASP.NET Using Robocopy</a><a href='http://www.softwaremeadows.com/posts/combining_veracrypt_google_backup_sync_sql_server_part_2'>Combining VeraCrypt, Google Backup & Sync, and Sql Server Part 2</a><a href='http://www.softwaremeadows.com/posts/combining_veracrypt_google_backup_sync_sql_server_part_1'>Combining VeraCrypt, Google Backup & Sync, and Sql Server Part 1</a><a href='http://www.softwaremeadows.com/posts/new-blog-engine'>New Blog Engine</a>
    </div>
    <div id="history">
      <h2>History</h2>
      <ol class='tree'><li class='history-year'><label for='2018'>2018</label><input type='checkbox'  id='2018' /><ol><li class='history-month'><label for='2018-3'>March</label><input type='checkbox'  id='2018-3' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/announcing_deftconfig'>Announcing DeftConfig</a></li></ol></li><li class='history-month'><label for='2018-1'>January</label><input type='checkbox'  id='2018-1' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs_2015_publish_asp_net_using_robocopy'>TFS 2015: Publish ASP.NET Using Robocopy</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/combining_veracrypt_google_backup_sync_sql_server_part_2'>Combining VeraCrypt, Google Backup & Sync, and Sql Server Part 2</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/combining_veracrypt_google_backup_sync_sql_server_part_1'>Combining VeraCrypt, Google Backup & Sync, and Sql Server Part 1</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/new-blog-engine'>New Blog Engine</a></li></ol></li></ol></li><li class='history-year'><label for='2017'>2017</label><input type='checkbox'  id='2017' /><ol><li class='history-month'><label for='2017-8'>August</label><input type='checkbox'  id='2017-8' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/dont-use-data-prefix-in-angularjs'>Don't use "data" prefix in AngularJS</a></li></ol></li><li class='history-month'><label for='2017-7'>July</label><input type='checkbox'  id='2017-7' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/angularjs-service-with-var-declarations'>AngularJS service with var declarations instead of this. assignments</a></li></ol></li><li class='history-month'><label for='2017-6'>June</label><input type='checkbox'  id='2017-6' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/factory-resetting-android-without'>Factory Resetting Android Without Losing Your Life (Metaphorically)</a></li></ol></li><li class='history-month'><label for='2017-5'>May</label><input type='checkbox'  id='2017-5' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-4'>IdentityServer3 with PKCE Part 4 - Persisting User Data</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-3'>IdentityServer3 with PKCE Part 3 - Persist IdentityServer Configuration</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-2'>IdentityServer3 with PKCE Part 2 - Protected Resource Server</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-1-simple'>IdentityServer3 with PKCE Part 1 - Simple OAuth2 Server</a></li></ol></li><li class='history-month'><label for='2017-3'>March</label><input type='checkbox'  id='2017-3' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through'>TFS Continuous Integration Walk Through Part 5c - Multiple Solutions: Dependencies</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/sane-database-schema-conventions'>Sane Database Schema Conventions</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-agent'>TFS Continuous Integration - Agent Installation and Visual Studio Licensing</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-clickonce'>TFS Continuous Integration - ClickOnce Apps</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-and-private'>TFS Continuous Integration and Private NuGet Package Sources</a></li></ol></li><li class='history-month'><label for='2017-2'>February</label><input type='checkbox'  id='2017-2' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_22'>TFS Continuous Integration Walk Through Part 5b - Multiple Solutions: Simple Project References</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_20'>TFS Continuous Integration Walk Through Part 5a - Multiple Solutions: Overview</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_24'>TFS Continuous Integration Walk Through Part 4b - Problems With Traits</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_6'>TFS Continuous Integration Walk Through Part 4a - Filtering Tests</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_63'>TFS Continuous Integration Walk Through Part 3 - Notifications</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_5'>TFS Continuous Integration Walk Through Part 2 - Create an Automated Build</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through'>TFS Continuous Integration Walk Through Part 1 - Installing TFS and Checking In a Test Project</a></li></ol></li><li class='history-month'><label for='2017-1'>January</label><input type='checkbox'  id='2017-1' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/what-else-programmers-do-text'>What Else Programmers Do: A Text Manipulation Example</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/what-does-this-code-do-extended'>What does this code do? Extended explanation</a></li></ol></li></ol></li><li class='history-year'><label for='2016'>2016</label><input type='checkbox'  id='2016' /><ol><li class='history-month'><label for='2016-12'>December</label><input type='checkbox'  id='2016-12' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/nexus-5-gps-lock-problem-and-two'>Nexus 5 GPS Lock Problem and Three--or More!--Solutions</a></li></ol></li><li class='history-month'><label for='2016-11'>November</label><input type='checkbox'  id='2016-11' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/how-to-bypass-new-microsoft-office'>How to Bypass the New Microsoft Office Startup and Save Screens</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/google-tasks-vs-reminders-in-desktop'>Google Tasks vs Reminders in Desktop and Phone</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/catching-up-on-coding-claims-based-identity-part-1_6'>Catching Up on Coding - Claims-Based Identity Part 1</a></li></ol></li><li class='history-month'><label for='2016-10'>October</label><input type='checkbox'  id='2016-10' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/creating-forms-authentication'>Creating Forms Authentication Membership Tables in LocalDB–Right and Wrong Ways</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/windows-10-complaint-1-auto-update'>Windows 10 Complaint #1: Auto Update State Loss</a></li></ol></li><li class='history-month'><label for='2016-9'>September</label><input type='checkbox'  id='2016-9' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/disable-windows-10-photo-automatic'>Disable Windows 10 Photo Automatic Albums</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/a-laymans-explanation-of-mocking-and'>A Layman’s Explanation of Mocking and Dependency Injection</a></li></ol></li><li class='history-month'><label for='2016-8'>August</label><input type='checkbox'  id='2016-8' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-3'>Catching Up on Coding - TDD Part 3</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-2'>Catching Up on Coding - TDD Part 2</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-1'>Catching Up on Coding - TDD Part 1</a></li></ol></li><li class='history-month'><label for='2016-7'>July</label><input type='checkbox'  id='2016-7' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/writing-to-current-users-registry-when'>Writing to the Current User(s) Registry When Running as System</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/catching-up-on-coding-syllabus'>Catching Up on Coding - The Syllabus</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/quickly-enable-mercurial-keyring-for'>Quickly Enable Mercurial Keyring for BitBucket</a></li></ol></li><li class='history-month'><label for='2016-6'>June</label><input type='checkbox'  id='2016-6' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/create-easily-debuggable-windows-service'>Create an Easily Debuggable Windows Service</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/underrated-work-skills'>(Underrated) Work Skills</a></li></ol></li><li class='history-month'><label for='2016-5'>May</label><input type='checkbox'  id='2016-5' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/vbnet-windows-project-to-c-conversion'>VB.Net Windows Project to C# Conversion Tools Quick Review</a></li></ol></li><li class='history-month'><label for='2016-2'>February</label><input type='checkbox'  id='2016-2' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/scroll-bars-in-blogger-tags'>Scroll bars in Blogger &lt;pre&gt; Tags</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/google-keep-changes-taking-to-forums'>Google Keep Changes: Taking to the Forums</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/backward-step-for-google-keep'>Backward Step for Google Keep</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/recover-virtualbox-snapshots'>Recover VirtualBox Snapshots</a></li></ol></li><li class='history-month'><label for='2016-1'>January</label><input type='checkbox'  id='2016-1' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/auto-updating-new-windows-7-installation'>Auto Updating a New Windows 7 Installation</a></li></ol></li></ol></li><li class='history-year'><label for='2015'>2015</label><input type='checkbox'  id='2015' /><ol><li class='history-month'><label for='2015-8'>August</label><input type='checkbox'  id='2015-8' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/shoretel-brilliantly-simple'>ShoreTel - Brilliantly Simple?</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/the-google-photos-management-problems'>The Google Photos Management Problem(s)</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/creating-long-lasting-clickonce'>Creating a Long-Lasting ClickOnce Certificate</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/more-encrypted-config-filesclickonce'>More Encrypted Config Files–ClickOnce Complications</a></li></ol></li><li class='history-month'><label for='2015-7'>July</label><input type='checkbox'  id='2015-7' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/encrypting-appconfig'>Encrypting app.config</a></li></ol></li><li class='history-month'><label for='2015-3'>March</label><input type='checkbox'  id='2015-3' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/better-google-sites-designthe-notched'>Better Google Sites Design–The Notched Page</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/removing-unremovable-bluetooth-device'>Removing Unremovable Bluetooth Device: FAIL!</a></li></ol></li></ol></li><li class='history-year'><label for='2014'>2014</label><input type='checkbox'  id='2014' /><ol><li class='history-month'><label for='2014-11'>November</label><input type='checkbox'  id='2014-11' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/how-to-remove-savernet-and-similar'>How to remove Savernet (and similar) Chrome extension</a></li></ol></li><li class='history-month'><label for='2014-9'>September</label><input type='checkbox'  id='2014-9' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/prevent-word-from-restoring-minimized'>Prevent Word from Restoring Minimized Documents</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/clever-phish'>Clever Phish</a></li></ol></li><li class='history-month'><label for='2014-8'>August</label><input type='checkbox'  id='2014-8' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/enable-synaptics-touchpad-2-finger-tap'>Enable Synaptics touchpad 2-finger tap context menu</a></li></ol></li><li class='history-month'><label for='2014-5'>May</label><input type='checkbox'  id='2014-5' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/installing-fcm-flow-cytrometry-library'>Installing fcm flow cytrometry library on Windows 8.1</a></li></ol></li><li class='history-month'><label for='2014-4'>April</label><input type='checkbox'  id='2014-4' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/windows-81-update-1-driver-problem-dtmb'>Windows 8.1 Update 1 Driver Problem DTMB BDA TV USB</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/windows-81-window-key-s-search-from'>Windows 8.1: Window Key + S = Search from Desktop</a></li></ol></li><li class='history-month'><label for='2014-3'>March</label><input type='checkbox'  id='2014-3' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/whs-2011-windows-update-one-or-more'>WHS 2011 Windows Update “One or more services are no running” alert</a></li></ol></li><li class='history-month'><label for='2014-2'>February</label><input type='checkbox'  id='2014-2' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/lenovo-u530-touch-wifi-problem-continued'>Lenovo U530 Touch WiFi Problem Continued</a></li></ol></li><li class='history-month'><label for='2014-1'>January</label><input type='checkbox'  id='2014-1' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/lenovo-u530-touch-wifi-problem'>Lenovo U530 Touch WiFi Problem</a></li></ol></li></ol></li><li class='history-year'><label for='2013'>2013</label><input type='checkbox'  id='2013' /><ol><li class='history-month'><label for='2013-12'>December</label><input type='checkbox'  id='2013-12' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/whs-connector-restart-error-in-windows'>WHS Connector Restart Error in Windows 8.0/8.1</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/how-to-remove-apps-from-google-play-my'>How to Remove Apps from Google Play My Apps Site</a></li></ol></li><li class='history-month'><label for='2013-11'>November</label><input type='checkbox'  id='2013-11' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/windows-81-hidden-opt-ins-opt-outs'>Windows 8.1 Hidden Opt Ins/ Opt Outs</a></li></ol></li><li class='history-month'><label for='2013-9'>September</label><input type='checkbox'  id='2013-9' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-epilogue'>Edward Farley and the Fantastic Library Epilogue</a></li></ol></li><li class='history-month'><label for='2013-7'>July</label><input type='checkbox'  id='2013-7' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/a-week-or-more-of-jolicloud-day-2-end'>A Week (or More!) of JoliCloud - Day 2: THE END</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/a-week-or-more-of-jolicloud-day-1'>A Week (or More!) of JoliCloud - Day 1</a></li></ol></li><li class='history-month'><label for='2013-5'>May</label><input type='checkbox'  id='2013-5' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-12'>Edward Farley and the Fantastic Library Part 12</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-1019'>Edward Farley and the Fantastic Library Part 11</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-10'>Edward Farley and the Fantastic Library Part 10</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-9'>Edward Farley and the Fantastic Library Part 9</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-8'>Edward Farley and the Fantastic Library Part 8</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-7'>Edward Farley and the Fantastic Library Part 7</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-6'>Edward Farley and the Fantastic Library Part 6</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-5'>Edward Farley and the Fantastic Library Part 5</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-4'>Edward Farley and the Fantastic Library Part 4</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-3'>Edward Farley and the Fantastic Library Part 3</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-2'>Edward Farley and the Fantastic Library Part 2</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-1'>Edward Farley and the Fantastic Library Part 1</a></li></ol></li><li class='history-month'><label for='2013-4'>April</label><input type='checkbox'  id='2013-4' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/clean-up-orphaned-sql-users'>Clean Up Orphaned SQL Users</a></li></ol></li><li class='history-month'><label for='2013-3'>March</label><input type='checkbox'  id='2013-3' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/t-sql-one-to-one-cant-be-done'>T-SQL One to One Can't Be Done</a></li></ol></li><li class='history-month'><label for='2013-1'>January</label><input type='checkbox'  id='2013-1' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/test-post-with-code'>Migrating Google Drive</a></li></ol></li></ol></li><li class='history-year'><label for='1'>1</label><input type='checkbox'  id='1' /><ol><li class='history-month'><label for='1-1'>January</label><input type='checkbox'  id='1-1' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/announcing_deepshadow'>Announcing DeepShadow</a></li></ol></li></ol></li></ol>
    </div>
  </nav>
  <header>
    <div id="site-image">
      <img src="http://www.softwaremeadows.com/images/header.png" alt="" />
    </div>
    <h1 id="site-name"></h1>
    <div id="site-subtitle">A pleasant walk through computing</div>
  </header>
  <section id="content">
    <h1 id="home">Home</h1>

  </section>
  <!-- posts only appear in home index -->
  <section id="posts">
    
              <div class='post'>
                <h2 class='post-title'><a href='http://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-1'>Catching Up on Coding - TDD Part 1</a></h2>
                <p class='post-info'><span class='posted-on'>2016-08-18 16:56</span></p>
                <div class='post-content'><p><img src="https://i.ytimg.com/vi/tfeeeaEmDtM/hqdefault.jpg">I’ve been a software developer for twenty years, but am behind in some skills. This series chronicles my self-improvement.</p>
<p>There are some pretty high-tech tools out there, but nothing that matches the inspiration provided in the 70s TV show “<a href="https://en.wikipedia.org/wiki/Search_(TV_series)">Search</a>” (originally “Probe”). I don’t have Burgess Meredith, a Probe Scanner or a <a href="https://www.youtube.com/watch?v=Axb1EiJdbCg">catchy theme song</a> to help me out, so, like Hugh O’Brian, I’ll have to rely on my wits and <a href="https://en.wikipedia.org/wiki/Test-driven_development">Test Driven Development (TDD)</a>.</p>
<p>Previously, on CUOC: <a href="http://www.softwaremeadows.com/2016/07/catching-up-on-coding-syllabus.html">The Syllabus</a>. Next Episode: <a href="http://www.softwaremeadows.com/2016/08/catching-up-on-coding-tdd-part-2.html">TDD Part 2</a></p>
<h1 id="teaser">Teaser</h1>
<p>I’m not truly new to TDD. I <em>wrote</em> a (not very good) unit testing framework for Visual Basic 6 back in 2000. I’ve used TDD in professional projects. But now it’s time to make it a habit. To do that, I need a crash coarse, then retrofit my EduAgent code (applying “Test Eventually Development”) before writing new code.</p>
<h1 id="act-1--the-elemental-education">Act 1 – The Elemental Education</h1>
<p>Let’s give primary credit where it’s due. I read James Bender’s blog <a href="http://www.telerik.com/blogs/30-days-tdd-day-one-what-is-tdd">30 Days of TDD</a>. Bender’s series is very good overall. He does—frustratingly--have sloppy grammar and punctuation errors in every post. But his information is otherwise clear and solid. In fact, his description of SOLID is one of the best I’ve read. Thanks, James!</p>
<p>But first things first: what problem was TDD trying to solve?</p>
<p>Programmers, being human, don’t like to test our work. Most of us find it as hard as writers self-editing or composers checking for wrong notes. We <em>like</em> QA departments because they find our (careless) mistakes for us. We <em>pretend</em> to hate QA, because we pretend we’re egotistical Greek gods incapable of flaw.</p>
<p>Unit testing frameworks allowed testing the public interface of our classes. But that wasn’t enough. Kent Beck encouraged an upside-down approach to writing code, where we write a failing test first, then make it pass. This naturally builds up a library of tests that can be run quickly, reducing the chance of new features breaking the application, and building developer confidence. It also turned out that creating easily testable methods led to generally more maintainable code. Thus, some people revised TDD to mean test-driven <em>design</em>.</p>
<p>What are the elements of TDD? What’s needed to build testable code?</p>
<h1></h1>
<h2 id="elements">Elements</h2>
<ul>
<li>Test framework such as <a href="http://nunit.org/index.php?p=home">NUnit</a> and <a href="https://xunit.github.io/docs/getting-started-desktop.html">xUnit.net</a></li>
<li><a href="https://xunit.github.io/docs/getting-started-desktop.html#run-tests-visualstudio">Test runner</a>, for executing tests and viewing results.</li>
<li>Dependency Inversion (depend on abstractions) and Dependency Injection (decouple dependencies). Both are covered pretty well in <a href="http://www.codeproject.com/Articles/615139/An-Absolute-Beginners-Tutorial-on-Dependency-Inver">this article</a>.</li>
<li><a href="http://www.telerik.com/blogs/30-days-of-tdd-day-11-what-s-the-deal-with-mocking">Mocking</a> (control results from external resources, such as databases)</li>
<li><a href="http://www.telerik.com/blogs/30-days-of-tdd-day-nine-refactoring-basics">Refactoring</a> (improving code maintainability without changing the public interface)</li>
</ul>
<h1 id="act-2--some-code-a-test">Act 2 – Some Code, a Test</h1>
<p>Here’s a simple example of TDD, creating code that needs to be tested, and problems with it. I’m using xUnit.Net because I’ve always liked it. I won’t go into how to set up your environment; you can learn that at <a href="https://xunit.github.io/docs/getting-started-desktop.html">Getting Started with xUnit.net</a>. However, I do have three tips for using the VS Test Runner (which you open via Test &gt; Windows &gt; Test Explorer).</p>
<ul>
<li><p>Tear off the Test Explorer into its own window, so that you can easily resize and see all the tests. <a href="images/image_3.png"><img src="http://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-1/images/image_3.png" title="image" alt="image"></a></p></li>
<li><p>Group the test results by class <a href="images/image_5.png"><img src="http://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-1/images/image_5.png" title="image" alt="image"></a></p></li>
<li><p>In your unit test project, add an app.config file with the following setting. This causes the result to display only the method name instead of the fully qualified name.</p></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb1-1" data-line-number="1">&lt;?xml version=<span class="st">"1.0"</span> encoding=<span class="st">"utf-8"</span> ?&gt;</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">&lt;configuration&gt;</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">&lt;appSettings&gt;</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">&lt;add key=<span class="st">"xunit.methodDisplay"</span> value=<span class="st">"method"</span>/&gt;</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">&lt;/appSettings&gt;</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">&lt;/configuration&gt;</a></code></pre></div>
<p>Our contrived application helps teachers grade coursework. We’re writing a class dealing with the coursework, and we’re consuming a third-party service—GradeMark—that returns a grade. One challenge, however, is we don’t control the grade that GradeMark returns given a set of scores. It depends on however the school has configured it. So, today 90% or higher could be an “A,” but tomorrow 93% or higher could be an “A.”</p>
<p>Our CourseWork class will have two methods. One that returns a percentage, and the other that returns a grade message. The grade in the message will come from the GradeMark “service,” and we’ll eventually have to mock that service.</p>
<p>First, in CourseWork, create a GetPercent function that doesn’t work. We want a failing test.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> CourseWork</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">public</span> <span class="dt">decimal</span> <span class="fu">GetPercent</span>(<span class="dt">decimal</span> actual, <span class="dt">decimal</span> maximum)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">{</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="kw">throw</span> <span class="kw">new</span> <span class="fu">NotImplementedException</span>();</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">}</a></code></pre></div>
<p>In the unit tests project, create the test. Notice the naming convention I’m using along with nested classes; this will help make the test results readable. There are <a href="https://dzone.com/articles/7-popular-unit-test-naming">lots of naming conventions</a> out there. Consistency and clarity are the big deals.</p>
<p>Our first test checks that we get back a percent in a particular format. We want “a hundred percent” to return as 100.00.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> BasicTdd</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">public</span> <span class="kw">class</span> CourseWork_GetPercent_Should</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">{</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">[Fact]</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">Return100PercentAs100PointZero</span>()</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">{</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="dt">var</span> cw = <span class="kw">new</span> <span class="fu">CourseWork</span>();</a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="dt">decimal</span> percent = cw.<span class="fu">GetPercent</span>(<span class="dv">100</span>, <span class="dv">100</span>);</a>
<a class="sourceLine" id="cb3-10" data-line-number="10">Assert.<span class="fu">Equal</span>(100m, percent);</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">}</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb3-13" data-line-number="13">}</a></code></pre></div>
<p>Run it and it fails.</p>
<p><a href="images/image.png"><img src="http://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-1/images/image.png" title="image" alt="image"></a></p>
<p>Write enough code for the test to pass.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">public</span> <span class="dt">decimal</span> <span class="fu">GetPercent</span>(<span class="dt">decimal</span> actual, <span class="dt">decimal</span> maximum)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="dt">decimal</span> result = (actual / maximum) * 100m;</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="kw">return</span> result;</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">}</a></code></pre></div>
<p>Run the test and it passes.</p>
<p><a href="images/image-001.png"><img src="http://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-1/images/image-001.png" title="image" alt="image"></a></p>
<p>Our next test will check if the result is rounded. This does <em>not</em> depend on the first test; they could be run in reverse order.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> BasicTdd</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="kw">public</span> <span class="kw">class</span> CourseWork_GetPercent_Should</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">{</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">[Fact]</a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">RoundPercentToTwoDecimalPlaces</span>()</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">{</a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="dt">var</span> cw = <span class="kw">new</span> <span class="fu">CourseWork</span>();</a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="dt">var</span> percent = cw.<span class="fu">GetPercent</span>(<span class="dv">1</span>, <span class="dv">7</span>);</a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="dt">var</span> roundedPercent = Math.<span class="fu">Round</span>(percent, <span class="dv">2</span>);</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">Assert.<span class="fu">Equal</span>(roundedPercent, percent);</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">}</a></code></pre></div>
<p>Run it, and it fails.</p>
<p><a href="images/image-002.png"><img src="http://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-1/images/image-002.png" title="image" alt="image"></a></p>
<p>Update the code to make it pass.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">public</span> <span class="dt">decimal</span> <span class="fu">GetPercent</span>(<span class="dt">decimal</span> actual, <span class="dt">decimal</span> maximum)</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="dt">decimal</span> result = Math.<span class="fu">Round</span>((actual / maximum) * 100m,<span class="dv">2</span>);</a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="kw">return</span> result;</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">}</a></code></pre></div>
<p><a href="images/image-003.png"><img src="http://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-1/images/image-003.png" title="image" alt="image"></a></p>
<p>That’s enough to demonstrate a basic test. Now, on to something that will require mocking.</p>
<h1 id="act-3--mocu-mental-grades">Act 3 – Mocu-mental Grades</h1>
<p>Let’s create a class that represents our fictional third-party service, GradeMark. Remember, it returns a grade when supplied a percent, but we can’t depend on what that grade will be. For our dummy service, we won’t even use the percent parameter.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> GradeMarkService</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="kw">public</span> <span class="dt">string</span> <span class="fu">GetGrade</span>(<span class="dt">decimal</span> percent)</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">{</a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="dt">var</span> rnd = <span class="kw">new</span> <span class="fu">Random</span>();</a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="dt">int</span> code = rnd.<span class="fu">Next</span>(<span class="dv">65</span>, <span class="dv">70</span>);</a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="kw">return</span> ((<span class="dt">char</span>)code).<span class="fu">ToString</span>();</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">}</a></code></pre></div>
<p>We’re just returning a random letter A-D (no failures in our courses!). Back in our CourseWork class, we’ll start a function that returns a grade, and write a test for it that will fail. Here’s the test.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> CourseWork_GetGradeMessage_Should</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">[Fact]</a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ReturnTheCorrectlyFormattedMessage</span>()</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">{</a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="dt">var</span> cw = <span class="kw">new</span> <span class="fu">CourseWork</span>();</a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="dt">string</span> msg = cw.<span class="fu">GetGradeMessage</span>(<span class="dv">4</span>, <span class="dv">15</span>); <span class="co">//these values don't matter</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="dt">string</span> expected = <span class="st">"The grade is B"</span>;</a>
<a class="sourceLine" id="cb8-9" data-line-number="9">Assert.<span class="fu">Equal</span>(expected, msg);</a>
<a class="sourceLine" id="cb8-10" data-line-number="10">}</a>
<a class="sourceLine" id="cb8-11" data-line-number="11">}</a></code></pre></div>
<p>What we’re testing is getting the expected message text. We’re <em>not</em> testing if GetPercent works, and we’re <em>not</em> testing if the GradeMark service works. When we run the test, it fails, so we write this code to try to make it pass. Some people would say that we shouldn’t bother with the GradeMark service yet, but let’s assume we’re at that point.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">public</span> <span class="dt">string</span> <span class="fu">GetGradeMessage</span>(<span class="dt">decimal</span> actual, <span class="dt">decimal</span> maximum)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="dt">var</span> service = <span class="kw">new</span> <span class="fu">GradeMarkService</span>();</a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="kw">return</span> <span class="st">"The grade is "</span> + service.<span class="fu">GetGrade</span>(<span class="fu">GetPercent</span>(actual, maximum));</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">}</a></code></pre></div>
<p>We got lucky; it failed. But, remember, we can’t guarantee what letter grade will be returned. It could have passed. Run the tests enough times and it <em>will</em> pass.</p>
<p><a href="images/image-004.png"><img src="http://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-1/images/image-004.png" title="image" alt="image"></a></p>
<p>Our GetGradeMessage function has a dependency on the GradeMark service, and is tightly coupled to it. We need to loosely couple that dependency by injecting it. We could do that at the method level, like this:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">public</span> <span class="dt">string</span> <span class="fu">GetGradeMessage</span>(<span class="dt">decimal</span> actual, <span class="dt">decimal</span> maximum, GradeMarkService gradeService)</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="kw">return</span> <span class="st">"The grade is "</span> + gradeService.<span class="fu">GetGrade</span>(<span class="fu">GetPercent</span>(actual, maximum));</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">}</a></code></pre></div>
<p>But, typically, a service like this is consumed by the class. So, we’ll inject it in the class’s constructor.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> CourseWork</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">GradeMarkService _gradeService;</a>
<a class="sourceLine" id="cb11-4" data-line-number="4"></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="kw">public</span> <span class="fu">CourseWork</span>(GradeMarkService gradeService)</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">{</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">_gradeService = gradeService;</a>
<a class="sourceLine" id="cb11-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb11-9" data-line-number="9"></a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="kw">public</span> <span class="dt">string</span> <span class="fu">GetGradeMessage</span>(<span class="dt">decimal</span> actual, <span class="dt">decimal</span> maximum)</a>
<a class="sourceLine" id="cb11-11" data-line-number="11">{</a>
<a class="sourceLine" id="cb11-12" data-line-number="12"><span class="kw">return</span> <span class="st">"The grade is "</span> + _gradeService.<span class="fu">GetGrade</span>(<span class="fu">GetPercent</span>(actual, maximum));</a>
<a class="sourceLine" id="cb11-13" data-line-number="13">}</a></code></pre></div>
<p>Great, but that doesn’t really help us, does it? We still need a GradeMarkService to pass in during our test, <em>and</em> control the letter grade it returns. Using some mocking frameworks, it’s possible to mock a legacy object. But in this case, we’re hoping for one of two things from our vendor to make our lives easier.</p>
<p><strong>An Interface</strong></p>
<p>Ideally, our vendor has programmed to an interface, using the Dependency Inversion Principle. We’ll simulate that in our fictional service class.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">public</span> <span class="kw">interface</span> IGrader</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="dt">string</span> <span class="fu">GetGrade</span>(<span class="dt">decimal</span> percent);</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb12-5" data-line-number="5"></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="kw">public</span> <span class="kw">class</span> GradeMarkService: IGrader</a>
<a class="sourceLine" id="cb12-7" data-line-number="7">{</a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="kw">public</span> <span class="dt">string</span> <span class="fu">GetGrade</span>(<span class="dt">decimal</span> percent)</a>
<a class="sourceLine" id="cb12-9" data-line-number="9">{</a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="dt">var</span> rnd = <span class="kw">new</span> <span class="fu">Random</span>();</a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="dt">int</span> code = rnd.<span class="fu">Next</span>(<span class="dv">65</span>, <span class="dv">70</span>);</a>
<a class="sourceLine" id="cb12-12" data-line-number="12"><span class="kw">return</span> ((<span class="dt">char</span>)code).<span class="fu">ToString</span>();</a>
<a class="sourceLine" id="cb12-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb12-14" data-line-number="14">}</a></code></pre></div>
<p>Next, we update our class to inject the <em>interface we’re testing</em>, instead of the concrete instance.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> CourseWork</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">{   IGrader _gradeService;</a>
<a class="sourceLine" id="cb13-3" data-line-number="3"></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="kw">public</span> <span class="fu">CourseWork</span>(IGrader gradeService)</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">{</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">_gradeService = gradeService;</a>
<a class="sourceLine" id="cb13-7" data-line-number="7">}</a></code></pre></div>
<p>Our class is now ready for testing. We don’t need the GradeMarkService. We just need our own mock class implementing the required interface. Back in our test project, we’ll create that.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> GradeMarkServiceMock: IGrader</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="kw">public</span> <span class="dt">string</span> <span class="fu">GetGrade</span>(<span class="dt">decimal</span> percent)</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">{</a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="kw">return</span> <span class="st">"B"</span>;</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">}</a></code></pre></div>
<p>And, update our tests to accept the mock object.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb15-1" data-line-number="1">[Fact]</a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">Return100PercentAs100PointZero</span>()</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">{</a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="dt">var</span> cw = <span class="kw">new</span> <span class="fu">CourseWork</span>(<span class="kw">new</span> <span class="fu">GradeMarkServiceMock</span>());</a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="dt">decimal</span> percent = cw.<span class="fu">GetPercent</span>(<span class="dv">1</span>, <span class="dv">1</span>);</a>
<a class="sourceLine" id="cb15-6" data-line-number="6">Assert.<span class="fu">Equal</span>(100m, percent);</a>
<a class="sourceLine" id="cb15-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb15-8" data-line-number="8">[Fact]</a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">RoundPercentToTwoDecimalPlaces</span>()</a>
<a class="sourceLine" id="cb15-10" data-line-number="10">{</a>
<a class="sourceLine" id="cb15-11" data-line-number="11"><span class="dt">var</span> cw = <span class="kw">new</span> <span class="fu">CourseWork</span>(<span class="kw">new</span> <span class="fu">GradeMarkServiceMock</span>());</a>
<a class="sourceLine" id="cb15-12" data-line-number="12"><span class="dt">var</span> percent = cw.<span class="fu">GetPercent</span>(<span class="dv">1</span>, <span class="dv">7</span>);</a>
<a class="sourceLine" id="cb15-13" data-line-number="13"><span class="dt">var</span> roundedPercent = Math.<span class="fu">Round</span>(percent, <span class="dv">2</span>);</a>
<a class="sourceLine" id="cb15-14" data-line-number="14">Assert.<span class="fu">Equal</span>(roundedPercent, percent);</a>
<a class="sourceLine" id="cb15-15" data-line-number="15">}</a>
<a class="sourceLine" id="cb15-16" data-line-number="16">}</a>
<a class="sourceLine" id="cb15-17" data-line-number="17"></a>
<a class="sourceLine" id="cb15-18" data-line-number="18"><span class="kw">public</span> <span class="kw">class</span> CourseWork_GetGradeMessage_Should</a>
<a class="sourceLine" id="cb15-19" data-line-number="19">{</a>
<a class="sourceLine" id="cb15-20" data-line-number="20">[Fact]</a>
<a class="sourceLine" id="cb15-21" data-line-number="21"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ReturnTheCorrectlyFormattedMessage</span>()</a>
<a class="sourceLine" id="cb15-22" data-line-number="22">{</a>
<a class="sourceLine" id="cb15-23" data-line-number="23"><span class="dt">var</span> cw = <span class="kw">new</span> <span class="fu">CourseWork</span>(<span class="kw">new</span> <span class="fu">GradeMarkServiceMock</span>());</a>
<a class="sourceLine" id="cb15-24" data-line-number="24"><span class="dt">string</span> msg = cw.<span class="fu">GetGradeMessage</span>(<span class="dv">4</span>, <span class="dv">15</span>); <span class="co">//these values don't matter</span></a>
<a class="sourceLine" id="cb15-25" data-line-number="25"><span class="dt">string</span> expected = <span class="st">"The grade is B"</span>;</a>
<a class="sourceLine" id="cb15-26" data-line-number="26">Assert.<span class="fu">Equal</span>(expected, msg);</a>
<a class="sourceLine" id="cb15-27" data-line-number="27">}</a>
<a class="sourceLine" id="cb15-28" data-line-number="28">}</a></code></pre></div>
<p>When we run our tests a few times, the GetGradeMessage test passes consistently.</p>
<p><strong>An overridable class</strong></p>
<p>Our vendor could also have made the GetGrade method overridable. In that case, we’d create a mock object, override GetGrade, and always return “B”. But with a significant object, there could be many problems doing that. It’s best if we can program against interfaces, because that way*&nbsp; we don’t have to use the original classes at all*.</p>
<p>What’s a real-world example? What about a shipping service that our application uses to calculate shipping rates? Several problems could exist in consuming that service instead of mocking it:</p>
<ul>
<li>It could be very slow to use that service in our tests.</li>
<li>It could return inconsistent results that affect our tests.</li>
<li>We might get charged every time we use the service.</li>
</ul>
<p>Databases are another example. Testing against a database is difficult because you want the data to always start in a consistent state. Database tests are slow. They are better left for <em>integration tests.</em></p>
<h2 id="refactoring">Refactoring</h2>
<p>The last step in TDD is making the code better, and also making the <em>tests</em> better. For example, we get an instance of the CourseWork class repeatedly. We can declare that as a class field. xUnit creates a new instance of the class for each test, so it will will always be a new instance of CourseWork.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> BasicTdd</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="kw">public</span> <span class="kw">class</span> CourseWork_GetPercent_Should</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">{</a>
<a class="sourceLine" id="cb16-5" data-line-number="5"><span class="kw">public</span> CourseWork _cw = <span class="kw">new</span> <span class="fu">CourseWork</span>(<span class="kw">new</span> <span class="fu">GradeMarkServiceMock</span>());</a>
<a class="sourceLine" id="cb16-6" data-line-number="6"></a>
<a class="sourceLine" id="cb16-7" data-line-number="7">[Fact]</a>
<a class="sourceLine" id="cb16-8" data-line-number="8"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">Return100PercentAs100PointZero</span>()</a>
<a class="sourceLine" id="cb16-9" data-line-number="9">{</a>
<a class="sourceLine" id="cb16-10" data-line-number="10"><span class="dt">decimal</span> percent = _cw.<span class="fu">GetPercent</span>(<span class="dv">1</span>, <span class="dv">1</span>);</a>
<a class="sourceLine" id="cb16-11" data-line-number="11">Assert.<span class="fu">Equal</span>(100m, percent);</a>
<a class="sourceLine" id="cb16-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb16-13" data-line-number="13">[Fact]</a>
<a class="sourceLine" id="cb16-14" data-line-number="14"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">RoundPercentToTwoDecimalPlaces</span>()</a>
<a class="sourceLine" id="cb16-15" data-line-number="15">{</a>
<a class="sourceLine" id="cb16-16" data-line-number="16"><span class="dt">var</span> percent = _cw.<span class="fu">GetPercent</span>(<span class="dv">1</span>, <span class="dv">7</span>);</a>
<a class="sourceLine" id="cb16-17" data-line-number="17"><span class="dt">var</span> roundedPercent = Math.<span class="fu">Round</span>(percent, <span class="dv">2</span>);</a>
<a class="sourceLine" id="cb16-18" data-line-number="18">Assert.<span class="fu">Equal</span>(roundedPercent, percent);</a>
<a class="sourceLine" id="cb16-19" data-line-number="19">}</a>
<a class="sourceLine" id="cb16-20" data-line-number="20">}</a>
<a class="sourceLine" id="cb16-21" data-line-number="21"></a>
<a class="sourceLine" id="cb16-22" data-line-number="22"><span class="kw">public</span> <span class="kw">class</span> CourseWork_GetGradeMessage_Should</a>
<a class="sourceLine" id="cb16-23" data-line-number="23">{</a>
<a class="sourceLine" id="cb16-24" data-line-number="24"><span class="kw">public</span> CourseWork _cw = <span class="kw">new</span> <span class="fu">CourseWork</span>(<span class="kw">new</span> <span class="fu">GradeMarkServiceMock</span>());</a>
<a class="sourceLine" id="cb16-25" data-line-number="25"></a>
<a class="sourceLine" id="cb16-26" data-line-number="26">[Fact]</a>
<a class="sourceLine" id="cb16-27" data-line-number="27"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ReturnTheCorrectlyFormattedMessage</span>()</a>
<a class="sourceLine" id="cb16-28" data-line-number="28">{</a>
<a class="sourceLine" id="cb16-29" data-line-number="29"><span class="dt">string</span> msg = _cw.<span class="fu">GetGradeMessage</span>(<span class="dv">4</span>, <span class="dv">15</span>); <span class="co">//these values don't matter</span></a>
<a class="sourceLine" id="cb16-30" data-line-number="30"><span class="dt">string</span> expected = <span class="st">"The grade is B"</span>;</a>
<a class="sourceLine" id="cb16-31" data-line-number="31">Assert.<span class="fu">Equal</span>(expected, msg);</a>
<a class="sourceLine" id="cb16-32" data-line-number="32">}</a>
<a class="sourceLine" id="cb16-33" data-line-number="33">}</a>
<a class="sourceLine" id="cb16-34" data-line-number="34">}</a></code></pre></div>
<p>Of course, rerun the tests and make sure they pass!</p>
<h1 id="tag">Tag</h1>
<p>Test-driven development isn’t natural at first. But it’s got a rat-hits-food-lever pleasure I can’t deny. Kind of like having Probe Control’s Angel Tompkins whispering in my ear.</p>
<p><img src="http://www.tvparty.com/bgifs/05Angel.jpg"></p>
<h1 id="references">References</h1>
<p><a href="http://www.telerik.com/blogs/30-days-tdd-day-one-what-is-tdd">30 Days of TDD</a></p>
<p><a href="https://xunit.github.io/docs/getting-started-desktop.html">Getting Started with xUnit.net</a></p>
<p><a href="http://stackoverflow.com/a/32402361/1628707">xUnit: display only method name</a></p>
<p><a href="https://xunit.github.io/docs/shared-context.html">xUnit: Shared Context Between Tests</a></p>
<p><a href="https://dzone.com/articles/7-popular-unit-test-naming">7 Popular Unit Test Naming Conventions</a></p>
<p><a href="http://osherove.com/blog/2005/4/3/naming-standards-for-unit-tests.html">Naming standards for unit tests</a></p>
<p><a href="https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;ved=0ahUKEwiUz9fXv8vOAhXF4iYKHfpFBewQFggeMAA&amp;url=http%3A%2F%2Fwww.codeproject.com%2FArticles%2F615139%2FAn-Absolute-Beginners-Tutorial-on-Dependency-Inver&amp;usg=AFQjCNFs-TENpoHA01eOYXRVZkYqEEIC9w&amp;sig2=Qp3Zq6b199xguue2bGLDEg">An Absolute Beginner's Tutorial on Dependency Inversion Principle</a></p>
</div>
              </div>
              

              <div class='post'>
                <h2 class='post-title'><a href='http://www.softwaremeadows.com/posts/writing-to-current-users-registry-when'>Writing to the Current User(s) Registry When Running as System</a></h2>
                <p class='post-info'><span class='posted-on'>2016-07-28 11:26</span></p>
                <div class='post-content'><p>In a project I’m working on, I need to change the Group Policy Object (GPO) registry settings, both for the computer and for the logged in user. Both of these present problems. This article addresses the logged in user scenario.</p>
<p>The actual application is a Windows service running on the client that accepts requests from a remote machine. The complication is that the service will need to run as System so that it can write to any part of the registry.</p>
<p>Below is prototyping and troubleshooting using a Console application.</p>
<h1 id="goal">Goal</h1>
<p>Run a Console application as the System user and write to the GPO that restricts running applications. Here’s the GPO if you want to look it up in Group Policy Editor (gpedit.msc).</p>
<p>User Configuration\Administrative Templates\System\<strong>Don't run specified Windows applications.</strong></p>
<h1 id="challengesissues">Challenges/Issues</h1>
<p>64-bit Windows has both logical and physical registry entries. This is a problem when updating keys that are used by other programs (in this case, Windows itself). You have to be sure you’re updating the right key. The problem really presents itself when writing to the LOCAL_MACHINE hive. The physical location—such as the Wow6432Node key—depends on whether the application is 64 or 32 bits.</p>
<p>The CURRENT_USER hive doesn’t care about 64/32 bits. But remember that a computer can have multiple users logged on. Also, where does the System user’s settings go? Finally, how will we find out who is logged in? What a mess!</p>
<h1 id="tools-and-environment">Tools and Environment</h1>
<p>I’m running Visual Studio 2015 Community on 64-bit Windows 10.</p>
<p>This is the registry key/value we’ll be creating throughout, setting its value to 1.</p>
<p>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\DisallowRun</p>
<h1 id="test-writing-to-the-registry">Test Writing to the Registry</h1>
<p>We first need to write to the registry and see the results. Create a Console Application with the following code.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">using</span> System;</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">using</span> Microsoft.<span class="fu">Win32</span>;</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">namespace</span> RegistryPrototyping</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">{</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw">class</span> Program</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">{</a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="kw">static</span> <span class="dt">void</span> <span class="fu">Main</span>(<span class="dt">string</span>[] args)</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">{</a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="kw">try</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11">{</a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="fu">WriteRegistry</span>();</a>
<a class="sourceLine" id="cb1-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="kw">catch</span> (Exception ex)</a>
<a class="sourceLine" id="cb1-15" data-line-number="15">{</a>
<a class="sourceLine" id="cb1-16" data-line-number="16">Console.<span class="fu">WriteLine</span>(ex.<span class="fu">GetBaseException</span>().<span class="fu">Message</span>);</a>
<a class="sourceLine" id="cb1-17" data-line-number="17">}</a>
<a class="sourceLine" id="cb1-18" data-line-number="18">Console.<span class="fu">WriteLine</span>(<span class="st">"Finished. Press any key to close."</span>);</a>
<a class="sourceLine" id="cb1-19" data-line-number="19">Console.<span class="fu">ReadLine</span>();</a>
<a class="sourceLine" id="cb1-20" data-line-number="20">}</a>
<a class="sourceLine" id="cb1-21" data-line-number="21"></a>
<a class="sourceLine" id="cb1-22" data-line-number="22"><span class="kw">static</span> <span class="dt">void</span> <span class="fu">WriteRegistry</span>()</a>
<a class="sourceLine" id="cb1-23" data-line-number="23">{</a>
<a class="sourceLine" id="cb1-24" data-line-number="24"><span class="dt">string</span> keyName = @<span class="st">"HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer"</span>;</a>
<a class="sourceLine" id="cb1-25" data-line-number="25"><span class="dt">string</span> valueName = <span class="st">"DisallowRun"</span>;</a>
<a class="sourceLine" id="cb1-26" data-line-number="26"><span class="dt">string</span> value = <span class="st">"1"</span>;</a>
<a class="sourceLine" id="cb1-27" data-line-number="27">RegistryValueKind dataType = RegistryValueKind.<span class="fu">DWord</span>;</a>
<a class="sourceLine" id="cb1-28" data-line-number="28">Registry.<span class="fu">SetValue</span>(keyName, valueName, value, dataType);</a>
<a class="sourceLine" id="cb1-29" data-line-number="29">}</a>
<a class="sourceLine" id="cb1-30" data-line-number="30">}</a>
<a class="sourceLine" id="cb1-31" data-line-number="31">}</a></code></pre></div>
<p>Run the application. You should get an error</p>
<blockquote>
<p>Access to the registry key 'HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer' is denied.</p>
</blockquote>
<p>This is our first problem. Our code needs permissions to write to the registry.</p>
<blockquote>
<p>For some developers, this problem will be hidden because they turn off UAC or <em>always</em> run Visual Studio as administrator. I don’t do either of these exactly because I’ll catch some permissions issue early.</p>
</blockquote>
<p>The obvious next step is to close our app, open Visual Studio using Run as Administrator, then reopen/run the app.</p>
<p><a href="images/image.png"><img src="http://www.softwaremeadows.com/posts/writing-to-current-users-registry-when/images/image.png" title="image" alt="image"></a></p>
<p>No error, and the key is written to the expected registry key (i.e. the currently logged in user).</p>
<p><a href="images/image_3.png"><img src="http://www.softwaremeadows.com/posts/writing-to-current-users-registry-when/images/image_3.png" title="image" alt="image"></a></p>
<p>Great! Next task, testing as Local System.</p>
<p><em><strong>But first, delete the DisallowRun key!</strong></em></p>
<h1 id="testing-as-local-system">Testing as Local System</h1>
<p>We need to run our app—either the .exe or Visual Studio—as Local System. I didn’t find a built-in Windows way to do this. The recommended method is to use Sysinternals’ psexec utility, which is normally used to execute commands on remote domain machines.</p>
<ol>
<li>Download <a href="https://technet.microsoft.com/en-us/sysinternals/bb897553.aspx">psexec</a>.</li>
<li>Open a command prompt As Administrator (you <em>must</em> do this), and navigate to the folder where you extracted psexec.exe.</li>
<li>Launch the desired application with the –i and –s switches. These run the application locally in interactive mode under the System account.</li>
</ol>
<p>I right-clicked on my Visual Studio icon &gt; Properties to get the path, and ended up with this command.</p>
<p>psexec –i –s “C:\Program Files (x86)\Microsoft Visual Studio 14.0\Common7\IDE\devenv.exe"</p>
<blockquote>
<p>When you launch this way, you’re running as if logged in under a different profile, so VS will go through its initial startup prompts.</p>
</blockquote>
<ol>
<li>Open your Console solution; you’ll need to navigate to its location via C:\Users\[username].</li>
<li>Run it. Check your registry key. Where the heck is the new value? Because we’re running as System, the registry value will be written to the .Default user key.</li>
</ol>
<p><a href="images/image_6.png"><img src="http://www.softwaremeadows.com/posts/writing-to-current-users-registry-when/images/image_6.png" title="image" alt="image"></a></p>
<p>Well, heck! This obviously isn’t what we want. We need to write to the currently logged on user’s profile. But this result gives us a clue how we’ll solve our problem later.</p>
<h1 id="impersonation--false-start">Impersonation – False Start</h1>
<p>At first, <a href="https://msdn.microsoft.com/en-us/library/w070t6ka(v=vs.110).aspx">impersonation</a> seems like the way to go. If I can just find out who’s currently logged on and working, I should be able to impersonate that user and write to the registry on that user’s behalf.</p>
<p>There are two problems with this.</p>
<ol>
<li>What if there are multiple users logged on? How do I find out which user is actively <em>working</em>?</li>
<li>Will I need to run with elevated privileges? (hint: yes, of course)</li>
</ol>
<p>If there are multiple users logged in, I didn’t find a way to determine who is actively using the computer. That seems like a poor requirement anyway. Don’t I care if, for instance, a scheduled task starts running as the logged in (but not active) user? Yes, because I might want my agent to prohibit it. What if it’s a headless system that’s always logged on? Worse, what if I want to run the client on a Windows server (which allows multiple simultaneous users via RDP)?</p>
<p>But maybe someone more clever than me wants to figure this out. There might be a way by looking at the active desktop(s).</p>
<p>The second problem is, for us, the impractical barrier to overcome. Writing to the registry requires elevation. The way we’d be impersonating the user would be to get a handle to a running process, then impersonating via that handle. But the user will <em>not</em> be running a known-elevated process. So, we’d be stuck. As soon as we tried to write to the registry, it would fail. And if we try to elevate the process (if we even could do that), the user would get prompted, defeating the goal of the program.</p>
<p>But we can still do what we want. After all, as System we can write to most parts of the physical registry.</p>
<h1 id="writing-to-the-users-key">Writing to the User’s Key</h1>
<p>When we wrote to the System user’s logical hive CURRENT_USER, we ended up in the physical hive USERS. That’s where all the user registry settings are. CURRENT_USER is a symbolic link, a redirection for the active user. Here’s my computer’s USERS hive:</p>
<p><a href="images/image_1.png"><img src="http://www.softwaremeadows.com/posts/writing-to-current-users-registry-when/images/image_1.png" title="image" alt="image"></a></p>
<p>Those long SIDs are the users. If I can get those, I can write to the user’s Group Policy setting.</p>
<p>Step one, revise the WriteRegistry method.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">static</span> <span class="dt">void</span> <span class="fu">WriteRegistry</span>(<span class="dt">string</span> sid)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="dt">string</span> keyName = @<span class="st">"HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer"</span>;</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="dt">string</span> valueName = <span class="st">"DisallowRun"</span>;</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="dt">string</span> value = <span class="st">"1"</span>;</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">keyName = keyName.<span class="fu">Replace</span>(<span class="st">"HKEY_CURRENT_USER"</span>, @<span class="st">"HKEY_USERS</span><span class="sc">\"</span><span class="st"> + sid);</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">RegistryValueKind dataType = RegistryValueKind.<span class="fu">DWord</span>;</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">Registry.<span class="fu">SetValue</span>(keyName, valueName, value, dataType);</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">}</a></code></pre></div>
<p>Step two, <strong>crazy lots of code!</strong></p>
<p>You’ll need these addtional references.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">using</span> System.<span class="fu">Runtime</span>.<span class="fu">InteropServices</span>;</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">using</span> System.<span class="fu">Security</span>;</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">using</span> System.<span class="fu">Security</span>.<span class="fu">Principal</span>;</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">using</span> System.<span class="fu">Diagnostics</span>;</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw">using</span> System.<span class="fu">Collections</span>.<span class="fu">Generic</span>;</a></code></pre></div>
<p>Use a Win32 API function to get the logged on users. This is some deeper stuff, and I didn’t write it. The most I did was put it in a class and make the function return all the users.</p>
<p>The meat of this—the cool part—is using Process.GetProcessesByName with an argument of “explorer”. This will return anyone logged on, because explorer is (typically) always running.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">class</span> WindowsIdentityHelper</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">[<span class="fu">DllImport</span>(<span class="st">"advapi32"</span>, SetLastError = <span class="kw">true</span>),</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">SuppressUnmanagedCodeSecurityAttribute]</a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="kw">static</span> <span class="kw">extern</span> <span class="dt">int</span> <span class="fu">OpenProcessToken</span>(</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">System.<span class="fu">IntPtr</span> ProcessHandle, <span class="co">// handle to process</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="dt">int</span> DesiredAccess, <span class="co">// desired access to process</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="kw">ref</span> IntPtr TokenHandle <span class="co">// handle to open access token</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10">);</a>
<a class="sourceLine" id="cb4-11" data-line-number="11"></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">[<span class="fu">DllImport</span>(<span class="st">"kernel32"</span>, SetLastError = <span class="kw">true</span>),</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">SuppressUnmanagedCodeSecurityAttribute]</a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="kw">static</span> <span class="kw">extern</span> <span class="dt">bool</span> <span class="fu">CloseHandle</span>(IntPtr handle);</a>
<a class="sourceLine" id="cb4-15" data-line-number="15">[<span class="fu">DllImport</span>(<span class="st">"advapi32.dll"</span>, CharSet = CharSet.<span class="fu">Auto</span>, SetLastError = <span class="kw">true</span>)]</a>
<a class="sourceLine" id="cb4-16" data-line-number="16"><span class="kw">public</span> <span class="kw">extern</span> <span class="kw">static</span> <span class="dt">bool</span> <span class="fu">DuplicateToken</span>(IntPtr ExistingTokenHandle,</a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="dt">int</span> SECURITY_IMPERSONATION_LEVEL, <span class="kw">ref</span> IntPtr DuplicateTokenHandle);</a>
<a class="sourceLine" id="cb4-18" data-line-number="18"></a>
<a class="sourceLine" id="cb4-19" data-line-number="19"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_ASSIGN_PRIMARY = <span class="bn">0x0001</span>;</a>
<a class="sourceLine" id="cb4-20" data-line-number="20"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_DUPLICATE = <span class="bn">0x0002</span>;</a>
<a class="sourceLine" id="cb4-21" data-line-number="21"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_IMPERSONATE = <span class="bn">0x0004</span>;</a>
<a class="sourceLine" id="cb4-22" data-line-number="22"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_QUERY = <span class="bn">0x0008</span>;</a>
<a class="sourceLine" id="cb4-23" data-line-number="23"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_QUERY_SOURCE = <span class="bn">0x0010</span>;</a>
<a class="sourceLine" id="cb4-24" data-line-number="24"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_ADJUST_PRIVILEGES = <span class="bn">0x0020</span>;</a>
<a class="sourceLine" id="cb4-25" data-line-number="25"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_ADJUST_GROUPS = <span class="bn">0x0040</span>;</a>
<a class="sourceLine" id="cb4-26" data-line-number="26"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_ADJUST_DEFAULT = <span class="bn">0x0080</span>;</a>
<a class="sourceLine" id="cb4-27" data-line-number="27"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_ADJUST_SESSIONID = <span class="bn">0x0100</span>;</a>
<a class="sourceLine" id="cb4-28" data-line-number="28"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_READ = <span class="bn">0x00020000</span> | TOKEN_QUERY;</a>
<a class="sourceLine" id="cb4-29" data-line-number="29"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_WRITE = <span class="bn">0x00020000</span> | TOKEN_ADJUST_PRIVILEGES | TOKEN_ADJUST_GROUPS | TOKEN_ADJUST_DEFAULT;</a>
<a class="sourceLine" id="cb4-30" data-line-number="30"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_EXECUTE = <span class="bn">0x00020000</span>;</a>
<a class="sourceLine" id="cb4-31" data-line-number="31"></a>
<a class="sourceLine" id="cb4-32" data-line-number="32"><span class="kw">public</span> <span class="kw">static</span> List <span class="fu">GetLoggedOnUsers</span>()</a>
<a class="sourceLine" id="cb4-33" data-line-number="33">{</a>
<a class="sourceLine" id="cb4-34" data-line-number="34">List users = <span class="kw">new</span> <span class="fu">List</span>();</a>
<a class="sourceLine" id="cb4-35" data-line-number="35"><span class="dt">string</span> errs = <span class="st">""</span>;</a>
<a class="sourceLine" id="cb4-36" data-line-number="36">IntPtr hToken = IntPtr.<span class="fu">Zero</span>;</a>
<a class="sourceLine" id="cb4-37" data-line-number="37"><span class="co">//Get a process that will always be available.</span></a>
<a class="sourceLine" id="cb4-38" data-line-number="38"><span class="kw">foreach</span> (Process proc <span class="kw">in</span> Process.<span class="fu">GetProcessesByName</span>(<span class="st">"explorer"</span>))</a>
<a class="sourceLine" id="cb4-39" data-line-number="39">{</a>
<a class="sourceLine" id="cb4-40" data-line-number="40"><span class="kw">try</span></a>
<a class="sourceLine" id="cb4-41" data-line-number="41">{</a>
<a class="sourceLine" id="cb4-42" data-line-number="42"><span class="kw">if</span> (<span class="fu">OpenProcessToken</span>(proc.<span class="fu">Handle</span>,</a>
<a class="sourceLine" id="cb4-43" data-line-number="43">TOKEN_QUERY | TOKEN_IMPERSONATE | TOKEN_DUPLICATE,</a>
<a class="sourceLine" id="cb4-44" data-line-number="44"><span class="kw">ref</span> hToken) != <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb4-45" data-line-number="45">{</a>
<a class="sourceLine" id="cb4-46" data-line-number="46">WindowsIdentity newId = <span class="kw">new</span> <span class="fu">WindowsIdentity</span>(hToken);</a>
<a class="sourceLine" id="cb4-47" data-line-number="47"><span class="fu">CloseHandle</span>(hToken);</a>
<a class="sourceLine" id="cb4-48" data-line-number="48">users.<span class="fu">Add</span>(newId);</a>
<a class="sourceLine" id="cb4-49" data-line-number="49">}</a>
<a class="sourceLine" id="cb4-50" data-line-number="50"><span class="kw">else</span></a>
<a class="sourceLine" id="cb4-51" data-line-number="51">{</a>
<a class="sourceLine" id="cb4-52" data-line-number="52">errs += String.<span class="fu">Format</span>(<span class="st">"OpenProcess Failed {0}, privilege not held</span><span class="sc">\r\n</span><span class="st">"</span>, Marshal.<span class="fu">GetLastWin32Error</span>());</a>
<a class="sourceLine" id="cb4-53" data-line-number="53">}</a>
<a class="sourceLine" id="cb4-54" data-line-number="54"></a>
<a class="sourceLine" id="cb4-55" data-line-number="55">}</a>
<a class="sourceLine" id="cb4-56" data-line-number="56"><span class="kw">catch</span> (Exception ex)</a>
<a class="sourceLine" id="cb4-57" data-line-number="57">{</a>
<a class="sourceLine" id="cb4-58" data-line-number="58">errs += String.<span class="fu">Format</span>(<span class="st">"OpenProcess Failed {0}</span><span class="sc">\r\n</span><span class="st">"</span>, ex.<span class="fu">Message</span>);</a>
<a class="sourceLine" id="cb4-59" data-line-number="59">}</a>
<a class="sourceLine" id="cb4-60" data-line-number="60">}</a>
<a class="sourceLine" id="cb4-61" data-line-number="61"><span class="kw">if</span> (errs.<span class="fu">Length</span> &gt; <span class="dv">0</span>) { <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">Exception</span>(errs); }</a>
<a class="sourceLine" id="cb4-62" data-line-number="62"><span class="kw">return</span> users;</a>
<a class="sourceLine" id="cb4-63" data-line-number="63">}</a></code></pre></div>
<p>And a method to write to the users’ registries.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">static</span> <span class="dt">void</span> <span class="fu">WriteToLoggedOnUsers</span>()</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="kw">foreach</span> (var user <span class="kw">in</span> WindowsIdentityHelper.<span class="fu">GetLoggedOnUsers</span>())</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">{</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="kw">try</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6">{</a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="fu">WriteRegistry</span>(user.<span class="fu">Owner</span>.<span class="fu">Value</span>);</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">Console.<span class="fu">WriteLine</span>(<span class="st">"Updated user "</span> + user.<span class="fu">Name</span> + <span class="st">"  SID "</span> + user.<span class="fu">Owner</span>.<span class="fu">Value</span>);</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="kw">catch</span> (Exception ex)</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">{</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">Console.<span class="fu">WriteLine</span>(ex.<span class="fu">GetBaseException</span>().<span class="fu">Message</span>);</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">}</a>
<a class="sourceLine" id="cb5-15" data-line-number="15">}</a></code></pre></div>
<blockquote>
<p>Notice we’re using WindowsIdentity.Owner.Value to return the SID. The property .Owner.AccountDomainSid doesn’t return the full, correct SID.</p>
</blockquote>
<p>Finally, change the Main method.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">static</span> <span class="dt">void</span> <span class="fu">Main</span>(<span class="dt">string</span>[] args)</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="kw">try</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">{</a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="fu">WriteToLoggedOnUsers</span>();</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="kw">catch</span> (Exception ex)</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">{</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">Console.<span class="fu">WriteLine</span>(ex.<span class="fu">GetBaseException</span>().<span class="fu">Message</span>);</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">}</a>
<a class="sourceLine" id="cb6-11" data-line-number="11">Console.<span class="fu">WriteLine</span>(<span class="st">"Finished. Press any key to close."</span>);</a>
<a class="sourceLine" id="cb6-12" data-line-number="12">Console.<span class="fu">ReadLine</span>();</a>
<a class="sourceLine" id="cb6-13" data-line-number="13">}</a></code></pre></div>
<p>One last thing before running the app. If you <em>really</em> want to test it, create a local user (named Test would be good), log that user on, leave it running and switch back to your regular user.</p>
<p>Now, run the application.</p>
<p><a href="images/image_14.png"><img src="http://www.softwaremeadows.com/posts/writing-to-current-users-registry-when/images/image_14.png" title="image" alt="image"></a></p>
<p>Check those User SIDs!</p>
<p><a href="images/image_9.png"><img src="http://www.softwaremeadows.com/posts/writing-to-current-users-registry-when/images/image_9.png" title="image" alt="image"></a></p>
<p><a href="images/image_11.png"><img src="http://www.softwaremeadows.com/posts/writing-to-current-users-registry-when/images/image_11.png" title="image" alt="image"></a></p>
<p>And finally, to prove the redirection, we’ll look at our CURRENT_USER hive.</p>
<p><a href="images/image_13.png"><img src="http://www.softwaremeadows.com/posts/writing-to-current-users-registry-when/images/image_13.png" title="image" alt="image"></a></p>
<p>(Remember, now, to delete those keys. You might also log off and delete the test user.)</p>
<h1 id="wrap-up">Wrap Up</h1>
<p>Our goal was to write to the logged on users’ Group Policy keys, with the future intention of preventing them from running certain applications. We need to do this running as System, and found that impersonation wouldn’t work because we had use an elevated process. Instead, we wrote to the running users’ physical registry keys.</p>
<p>One interesting aspect of this session is that there’s not a certain automated way to test for correctness. If I wrote a test that looked at a logical key (like CURRENT_USERS\…), and then checked if the value existed, I wouldn’t know if the correct physical key was updated. This may be a time when a human needs to test. (Maybe there’s a clever way around this, though.)</p>
<p>Full source code can be found after the References.</p>
<h1></h1>
<h1 id="references">References</h1>
<p><a href="https://msdn.microsoft.com/en-gb/library/aa384232(VS.85).aspx">Registry Redirector</a></p>
<p><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa384253(v=vs.85).aspx">Registry Keys Affected by WOW64</a></p>
<p><a href="https://technet.microsoft.com/en-us/library/cc960900.aspx">Group Policy Object – Disallow Run</a></p>
<p><a href="https://msdn.microsoft.com/en-us/library/w070t6ka(v=vs.110).aspx">WindowsIdentity.Impersonate</a></p>
<p><a href="https://bytes.com/topic/c-sharp/answers/463942-using-openprocesstoken">Using OpenProcessToken</a>&nbsp; &lt;=this is where the Win32 code came from. Very useful.</p>
<p><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa379295(v=vs.85).aspx">OpenProcessToken function</a></p>
<p><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa374905(v=vs.85).aspx">OpenProcessToken Access Rights</a></p>
<p><a href="http://www.pinvoke.net/default.aspx/advapi32.openprocesstoken">Constants for Token Access Rights</a></p>
<p><a href="https://msdn.microsoft.com/en-us/library/z3w4xdc9(v=vs.110).aspx">Process.GetProcessesByName</a></p>
<p>My machine’s named <a href="https://en.wikipedia.org/wiki/E._Nesbit">Nesbit</a>, after the great children’s fantasy author.</p>
<h1 id="full-source">Full Source</h1>
<div class="sourceCode" id="cb7"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">using</span> System;</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw">using</span> Microsoft.<span class="fu">Win32</span>;</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="kw">using</span> System.<span class="fu">Runtime</span>.<span class="fu">InteropServices</span>;</a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="kw">using</span> System.<span class="fu">Security</span>;</a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="kw">using</span> System.<span class="fu">Security</span>.<span class="fu">Principal</span>;</a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="kw">using</span> System.<span class="fu">Diagnostics</span>;</a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="kw">using</span> System.<span class="fu">Collections</span>.<span class="fu">Generic</span>;</a>
<a class="sourceLine" id="cb7-8" data-line-number="8"></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="kw">namespace</span> RegistryPrototyping</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">{</a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="kw">class</span> Program</a>
<a class="sourceLine" id="cb7-12" data-line-number="12">{</a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="kw">static</span> <span class="dt">void</span> <span class="fu">Main</span>(<span class="dt">string</span>[] args)</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">{</a>
<a class="sourceLine" id="cb7-15" data-line-number="15"><span class="kw">try</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16">{</a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="fu">WriteToLoggedOnUsers</span>();</a>
<a class="sourceLine" id="cb7-18" data-line-number="18">}</a>
<a class="sourceLine" id="cb7-19" data-line-number="19"><span class="kw">catch</span> (Exception ex)</a>
<a class="sourceLine" id="cb7-20" data-line-number="20">{</a>
<a class="sourceLine" id="cb7-21" data-line-number="21">Console.<span class="fu">WriteLine</span>(ex.<span class="fu">GetBaseException</span>().<span class="fu">Message</span>);</a>
<a class="sourceLine" id="cb7-22" data-line-number="22">}</a>
<a class="sourceLine" id="cb7-23" data-line-number="23">Console.<span class="fu">WriteLine</span>(<span class="st">"Finished. Press any key to close."</span>);</a>
<a class="sourceLine" id="cb7-24" data-line-number="24">Console.<span class="fu">ReadLine</span>();</a>
<a class="sourceLine" id="cb7-25" data-line-number="25">}</a>
<a class="sourceLine" id="cb7-26" data-line-number="26"></a>
<a class="sourceLine" id="cb7-27" data-line-number="27"><span class="kw">static</span> <span class="dt">void</span> <span class="fu">WriteRegistry</span>(<span class="dt">string</span> sid)</a>
<a class="sourceLine" id="cb7-28" data-line-number="28">{</a>
<a class="sourceLine" id="cb7-29" data-line-number="29"><span class="dt">string</span> keyName = @<span class="st">"HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer"</span>;</a>
<a class="sourceLine" id="cb7-30" data-line-number="30"><span class="dt">string</span> valueName = <span class="st">"DisallowRun"</span>;</a>
<a class="sourceLine" id="cb7-31" data-line-number="31"><span class="dt">string</span> value = <span class="st">"1"</span>;</a>
<a class="sourceLine" id="cb7-32" data-line-number="32">keyName = keyName.<span class="fu">Replace</span>(<span class="st">"HKEY_CURRENT_USER"</span>, @<span class="st">"HKEY_USERS</span><span class="sc">\"</span><span class="st"> + sid);</span></a>
<a class="sourceLine" id="cb7-33" data-line-number="33">RegistryValueKind dataType = RegistryValueKind.<span class="fu">DWord</span>;</a>
<a class="sourceLine" id="cb7-34" data-line-number="34">Registry.<span class="fu">SetValue</span>(keyName, valueName, value, dataType);</a>
<a class="sourceLine" id="cb7-35" data-line-number="35">}</a>
<a class="sourceLine" id="cb7-36" data-line-number="36"></a>
<a class="sourceLine" id="cb7-37" data-line-number="37"><span class="kw">static</span> <span class="dt">void</span> <span class="fu">WriteRegistry</span>()</a>
<a class="sourceLine" id="cb7-38" data-line-number="38">{</a>
<a class="sourceLine" id="cb7-39" data-line-number="39"><span class="dt">string</span> keyName = @<span class="st">"HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer"</span>;</a>
<a class="sourceLine" id="cb7-40" data-line-number="40"><span class="dt">string</span> valueName = <span class="st">"DisallowRun"</span>;</a>
<a class="sourceLine" id="cb7-41" data-line-number="41"><span class="dt">string</span> value = <span class="st">"1"</span>;</a>
<a class="sourceLine" id="cb7-42" data-line-number="42">RegistryValueKind dataType = RegistryValueKind.<span class="fu">DWord</span>;</a>
<a class="sourceLine" id="cb7-43" data-line-number="43">Registry.<span class="fu">SetValue</span>(keyName, valueName, value, dataType);</a>
<a class="sourceLine" id="cb7-44" data-line-number="44">}</a>
<a class="sourceLine" id="cb7-45" data-line-number="45"></a>
<a class="sourceLine" id="cb7-46" data-line-number="46"><span class="kw">static</span> <span class="dt">void</span> <span class="fu">WriteToLoggedOnUsers</span>()</a>
<a class="sourceLine" id="cb7-47" data-line-number="47">{</a>
<a class="sourceLine" id="cb7-48" data-line-number="48"><span class="kw">foreach</span> (var user <span class="kw">in</span> WindowsIdentityHelper.<span class="fu">GetLoggedOnUsers</span>())</a>
<a class="sourceLine" id="cb7-49" data-line-number="49">{</a>
<a class="sourceLine" id="cb7-50" data-line-number="50"><span class="kw">try</span></a>
<a class="sourceLine" id="cb7-51" data-line-number="51">{</a>
<a class="sourceLine" id="cb7-52" data-line-number="52"><span class="fu">WriteRegistry</span>(user.<span class="fu">Owner</span>.<span class="fu">Value</span>);</a>
<a class="sourceLine" id="cb7-53" data-line-number="53">Console.<span class="fu">WriteLine</span>(<span class="st">"Updated user "</span> + user.<span class="fu">Name</span> + <span class="st">"  SID "</span> + user.<span class="fu">Owner</span>.<span class="fu">Value</span>);</a>
<a class="sourceLine" id="cb7-54" data-line-number="54">}</a>
<a class="sourceLine" id="cb7-55" data-line-number="55"><span class="kw">catch</span> (Exception ex)</a>
<a class="sourceLine" id="cb7-56" data-line-number="56">{</a>
<a class="sourceLine" id="cb7-57" data-line-number="57">Console.<span class="fu">WriteLine</span>(ex.<span class="fu">GetBaseException</span>().<span class="fu">Message</span>);</a>
<a class="sourceLine" id="cb7-58" data-line-number="58">}</a>
<a class="sourceLine" id="cb7-59" data-line-number="59">}</a>
<a class="sourceLine" id="cb7-60" data-line-number="60">}</a>
<a class="sourceLine" id="cb7-61" data-line-number="61">}</a>
<a class="sourceLine" id="cb7-62" data-line-number="62">}</a>
<a class="sourceLine" id="cb7-63" data-line-number="63"></a>
<a class="sourceLine" id="cb7-64" data-line-number="64"></a>
<a class="sourceLine" id="cb7-65" data-line-number="65"><span class="kw">class</span> WindowsIdentityHelper</a>
<a class="sourceLine" id="cb7-66" data-line-number="66">{</a>
<a class="sourceLine" id="cb7-67" data-line-number="67"></a>
<a class="sourceLine" id="cb7-68" data-line-number="68">[<span class="fu">DllImport</span>(<span class="st">"advapi32"</span>, SetLastError = <span class="kw">true</span>),</a>
<a class="sourceLine" id="cb7-69" data-line-number="69">SuppressUnmanagedCodeSecurityAttribute]</a>
<a class="sourceLine" id="cb7-70" data-line-number="70"><span class="kw">static</span> <span class="kw">extern</span> <span class="dt">int</span> <span class="fu">OpenProcessToken</span>(</a>
<a class="sourceLine" id="cb7-71" data-line-number="71">System.<span class="fu">IntPtr</span> ProcessHandle, <span class="co">// handle to process</span></a>
<a class="sourceLine" id="cb7-72" data-line-number="72"><span class="dt">int</span> DesiredAccess, <span class="co">// desired access to process</span></a>
<a class="sourceLine" id="cb7-73" data-line-number="73"><span class="kw">ref</span> IntPtr TokenHandle <span class="co">// handle to open access token</span></a>
<a class="sourceLine" id="cb7-74" data-line-number="74">);</a>
<a class="sourceLine" id="cb7-75" data-line-number="75"></a>
<a class="sourceLine" id="cb7-76" data-line-number="76">[<span class="fu">DllImport</span>(<span class="st">"kernel32"</span>, SetLastError = <span class="kw">true</span>),</a>
<a class="sourceLine" id="cb7-77" data-line-number="77">SuppressUnmanagedCodeSecurityAttribute]</a>
<a class="sourceLine" id="cb7-78" data-line-number="78"><span class="kw">static</span> <span class="kw">extern</span> <span class="dt">bool</span> <span class="fu">CloseHandle</span>(IntPtr handle);</a>
<a class="sourceLine" id="cb7-79" data-line-number="79">[<span class="fu">DllImport</span>(<span class="st">"advapi32.dll"</span>, CharSet = CharSet.<span class="fu">Auto</span>, SetLastError = <span class="kw">true</span>)]</a>
<a class="sourceLine" id="cb7-80" data-line-number="80"><span class="kw">public</span> <span class="kw">extern</span> <span class="kw">static</span> <span class="dt">bool</span> <span class="fu">DuplicateToken</span>(IntPtr ExistingTokenHandle,</a>
<a class="sourceLine" id="cb7-81" data-line-number="81"><span class="dt">int</span> SECURITY_IMPERSONATION_LEVEL, <span class="kw">ref</span> IntPtr DuplicateTokenHandle);</a>
<a class="sourceLine" id="cb7-82" data-line-number="82"></a>
<a class="sourceLine" id="cb7-83" data-line-number="83"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_ASSIGN_PRIMARY = <span class="bn">0x0001</span>;</a>
<a class="sourceLine" id="cb7-84" data-line-number="84"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_DUPLICATE = <span class="bn">0x0002</span>;</a>
<a class="sourceLine" id="cb7-85" data-line-number="85"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_IMPERSONATE = <span class="bn">0x0004</span>;</a>
<a class="sourceLine" id="cb7-86" data-line-number="86"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_QUERY = <span class="bn">0x0008</span>;</a>
<a class="sourceLine" id="cb7-87" data-line-number="87"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_QUERY_SOURCE = <span class="bn">0x0010</span>;</a>
<a class="sourceLine" id="cb7-88" data-line-number="88"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_ADJUST_PRIVILEGES = <span class="bn">0x0020</span>;</a>
<a class="sourceLine" id="cb7-89" data-line-number="89"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_ADJUST_GROUPS = <span class="bn">0x0040</span>;</a>
<a class="sourceLine" id="cb7-90" data-line-number="90"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_ADJUST_DEFAULT = <span class="bn">0x0080</span>;</a>
<a class="sourceLine" id="cb7-91" data-line-number="91"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_ADJUST_SESSIONID = <span class="bn">0x0100</span>;</a>
<a class="sourceLine" id="cb7-92" data-line-number="92"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_READ = <span class="bn">0x00020000</span> | TOKEN_QUERY;</a>
<a class="sourceLine" id="cb7-93" data-line-number="93"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_WRITE = <span class="bn">0x00020000</span> | TOKEN_ADJUST_PRIVILEGES | TOKEN_ADJUST_GROUPS | TOKEN_ADJUST_DEFAULT;</a>
<a class="sourceLine" id="cb7-94" data-line-number="94"><span class="kw">public</span> <span class="dt">const</span> <span class="dt">int</span> TOKEN_EXECUTE = <span class="bn">0x00020000</span>;</a>
<a class="sourceLine" id="cb7-95" data-line-number="95"></a>
<a class="sourceLine" id="cb7-96" data-line-number="96"><span class="kw">public</span> <span class="kw">static</span> List <span class="fu">GetLoggedOnUsers</span>()</a>
<a class="sourceLine" id="cb7-97" data-line-number="97">{</a>
<a class="sourceLine" id="cb7-98" data-line-number="98">List users = <span class="kw">new</span> <span class="fu">List</span>();</a>
<a class="sourceLine" id="cb7-99" data-line-number="99"><span class="dt">string</span> errs = <span class="st">""</span>;</a>
<a class="sourceLine" id="cb7-100" data-line-number="100">IntPtr hToken = IntPtr.<span class="fu">Zero</span>;</a>
<a class="sourceLine" id="cb7-101" data-line-number="101"><span class="co">//Get a process that will always be available.</span></a>
<a class="sourceLine" id="cb7-102" data-line-number="102"><span class="kw">foreach</span> (Process proc <span class="kw">in</span> Process.<span class="fu">GetProcessesByName</span>(<span class="st">"explorer"</span>))</a>
<a class="sourceLine" id="cb7-103" data-line-number="103">{</a>
<a class="sourceLine" id="cb7-104" data-line-number="104"><span class="kw">try</span></a>
<a class="sourceLine" id="cb7-105" data-line-number="105">{</a>
<a class="sourceLine" id="cb7-106" data-line-number="106"><span class="kw">if</span> (<span class="fu">OpenProcessToken</span>(proc.<span class="fu">Handle</span>,</a>
<a class="sourceLine" id="cb7-107" data-line-number="107">TOKEN_QUERY | TOKEN_IMPERSONATE | TOKEN_DUPLICATE,</a>
<a class="sourceLine" id="cb7-108" data-line-number="108"><span class="kw">ref</span> hToken) != <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb7-109" data-line-number="109">{</a>
<a class="sourceLine" id="cb7-110" data-line-number="110">WindowsIdentity newId = <span class="kw">new</span> <span class="fu">WindowsIdentity</span>(hToken);</a>
<a class="sourceLine" id="cb7-111" data-line-number="111"><span class="fu">CloseHandle</span>(hToken);</a>
<a class="sourceLine" id="cb7-112" data-line-number="112">users.<span class="fu">Add</span>(newId);</a>
<a class="sourceLine" id="cb7-113" data-line-number="113">}</a>
<a class="sourceLine" id="cb7-114" data-line-number="114"><span class="kw">else</span></a>
<a class="sourceLine" id="cb7-115" data-line-number="115">{</a>
<a class="sourceLine" id="cb7-116" data-line-number="116">errs += String.<span class="fu">Format</span>(<span class="st">"OpenProcess Failed {0}, privilege not held</span><span class="sc">\r\n</span><span class="st">"</span>, Marshal.<span class="fu">GetLastWin32Error</span>());</a>
<a class="sourceLine" id="cb7-117" data-line-number="117">}</a>
<a class="sourceLine" id="cb7-118" data-line-number="118"></a>
<a class="sourceLine" id="cb7-119" data-line-number="119">}</a>
<a class="sourceLine" id="cb7-120" data-line-number="120"><span class="kw">catch</span> (Exception ex)</a>
<a class="sourceLine" id="cb7-121" data-line-number="121">{</a>
<a class="sourceLine" id="cb7-122" data-line-number="122">errs += String.<span class="fu">Format</span>(<span class="st">"OpenProcess Failed {0}</span><span class="sc">\r\n</span><span class="st">"</span>, ex.<span class="fu">Message</span>);</a>
<a class="sourceLine" id="cb7-123" data-line-number="123">}</a>
<a class="sourceLine" id="cb7-124" data-line-number="124">}</a>
<a class="sourceLine" id="cb7-125" data-line-number="125"><span class="kw">if</span> (errs.<span class="fu">Length</span> &gt; <span class="dv">0</span>) { <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">Exception</span>(errs); }</a>
<a class="sourceLine" id="cb7-126" data-line-number="126"><span class="kw">return</span> users;</a>
<a class="sourceLine" id="cb7-127" data-line-number="127">}</a>
<a class="sourceLine" id="cb7-128" data-line-number="128"></a>
<a class="sourceLine" id="cb7-129" data-line-number="129">}</a></code></pre></div>
</div>
              </div>
              

              <div class='post'>
                <h2 class='post-title'><a href='http://www.softwaremeadows.com/posts/catching-up-on-coding-syllabus'>Catching Up on Coding - The Syllabus</a></h2>
                <p class='post-info'><span class='posted-on'>2016-07-22 14:44</span></p>
                <div class='post-content'><p><img src="http://epguides.com/SwordofJustice/logo.jpg"></p>
<p>I’ve been a software developer for twenty years, but am behind in some skills. So, like Dack Rambo in the 70s TV show “<a href="https://en.wikipedia.org/wiki/Sword_of_Justice_(TV_series)">Sword of Justice</a>,” I’m taking myself to school. Just without the prison. Or <a href="https://www.youtube.com/watch?v=QG91OZwLme0">the awesome hair</a>.</p>
<p>Next Episode: <a href="http://www.softwaremeadows.com/2016/08/catching-up-on-coding-tdd-part-1.html">TDD Part 1</a></p>
<h1></h1>
<h1 id="teaser">Teaser</h1>
<p>“The deal of the cards begins the game.”</p>
<h1 id="act-1--the-project">Act 1 – The Project</h1>
<p>I’ve already started a hobby project named EduAgent. The purpose of EduAgent is:</p>
<blockquote>
<p>Allow a user to block and allow applications on remote Windows computers.</p>
</blockquote>
<p>The application’s architecture is simple enough:</p>
<ul>
<li>An agent, which is a Windows service running on client computers.</li>
<li>A web application that has bidirectional communication with agents.</li>
<li>A shared library.</li>
<li>A database.</li>
</ul>
<p>That should be enough complexity for me to apply each area I want to improve in.</p>
<h1 id="act-2--the-skills">Act 2 – The Skills</h1>
<p>I’ve done some work in most of these. However, it’s been awhile, and every job listing seems to ask for them (regardless of what’s actually in use).</p>
<ul>
<li>TDD (xUnit)</li>
<li>SOLID</li>
<li>DDD</li>
<li>Design Patterns (major)</li>
<li>Git</li>
<li>Dependency Injection</li>
<li>REST/WebAPI</li>
<li>MVVM (Angular/Typescript)</li>
<li>CSS Preprocessing (SASS)</li>
<li>Azure (maybe)</li>
<li>Security</li>
<li>Scalability (maybe)</li>
</ul>
<h1 id="act-3--the-rules">Act 3 – The Rules</h1>
<p>Each post will be on a subject, and will include:</p>
<ol>
<li>How much I (think) I know about the subject</li>
<li>The problem to solve</li>
<li>Before and after code samples</li>
<li>Lessons Learned</li>
<li>References</li>
</ol>
<h1 id="tag">Tag</h1>
<p>How much will my experience help me? I’m betting, a lot. After all, I’ve got all those old TV show heroes to help me out. <span style="font-size: xx-small; color: white">“The spade is the sword of justice. Its rapier marks the end.”</span> <a href="images/image.png"><img src="http://www.softwaremeadows.com/posts/catching-up-on-coding-syllabus/images/image.png" title="image" alt="image"></a> <span style="font-size: xx-small; color: white">“The spade is the sword of justice. Its rapier marks the end.”</span></p>
</div>
              </div>
              
    <div class='paging'><a href='index11.html'>Newer</a>&nbsp;&nbsp;&nbsp;<a href='index13.html'>Older</a></div>
  </section>
  <footer><p>Copyright (c) 2018 Charles L Flatt</p>
</footer>
  
</body>

</html>