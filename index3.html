<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  
  <link rel='stylesheet' href='http://www.softwaremeadows.com/css/default.css' />
<link rel='stylesheet' href='http://www.softwaremeadows.com/css/tango.css' />

  <title>Home | Software Meadows</title>
</head>

<body>
  <nav>
    <div id="menu">
      <ol>
<li><a href="http://www.softwaremeadows.com/">Home</a></li>
<li><a href="http://www.softwaremeadows.com/about">About</a></li>
</ol>

    </div>
    <div id="recent">
      <h2>Recent</h2>
      <a href='http://www.softwaremeadows.com/posts/announcing_deepshadow'>Announcing DeepShadow</a><a href='http://www.softwaremeadows.com/posts/announcing_deftconfig'>Announcing DeftConfig</a><a href='http://www.softwaremeadows.com/posts/tfs_2015_publish_asp_net_using_robocopy'>TFS 2015: Publish ASP.NET Using Robocopy</a><a href='http://www.softwaremeadows.com/posts/combining_veracrypt_google_backup_sync_sql_server_part_2'>Combining VeraCrypt, Google Backup & Sync, and Sql Server Part 2</a><a href='http://www.softwaremeadows.com/posts/combining_veracrypt_google_backup_sync_sql_server_part_1'>Combining VeraCrypt, Google Backup & Sync, and Sql Server Part 1</a>
    </div>
    <div id="history">
      <h2>History</h2>
      <ol class='tree'><li class='history-year'><label for='2018'>2018</label><input type='checkbox'  id='2018' /><ol><li class='history-month'><label for='2018-3'>March</label><input type='checkbox'  id='2018-3' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/announcing_deepshadow'>Announcing DeepShadow</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/announcing_deftconfig'>Announcing DeftConfig</a></li></ol></li><li class='history-month'><label for='2018-1'>January</label><input type='checkbox'  id='2018-1' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs_2015_publish_asp_net_using_robocopy'>TFS 2015: Publish ASP.NET Using Robocopy</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/combining_veracrypt_google_backup_sync_sql_server_part_2'>Combining VeraCrypt, Google Backup & Sync, and Sql Server Part 2</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/combining_veracrypt_google_backup_sync_sql_server_part_1'>Combining VeraCrypt, Google Backup & Sync, and Sql Server Part 1</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/new-blog-engine'>New Blog Engine</a></li></ol></li></ol></li><li class='history-year'><label for='2017'>2017</label><input type='checkbox'  id='2017' /><ol><li class='history-month'><label for='2017-8'>August</label><input type='checkbox'  id='2017-8' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/dont-use-data-prefix-in-angularjs'>Don't use "data" prefix in AngularJS</a></li></ol></li><li class='history-month'><label for='2017-7'>July</label><input type='checkbox'  id='2017-7' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/angularjs-service-with-var-declarations'>AngularJS service with var declarations instead of this. assignments</a></li></ol></li><li class='history-month'><label for='2017-6'>June</label><input type='checkbox'  id='2017-6' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/factory-resetting-android-without'>Factory Resetting Android Without Losing Your Life (Metaphorically)</a></li></ol></li><li class='history-month'><label for='2017-5'>May</label><input type='checkbox'  id='2017-5' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-4'>IdentityServer3 with PKCE Part 4 - Persisting User Data</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-3'>IdentityServer3 with PKCE Part 3 - Persist IdentityServer Configuration</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-2'>IdentityServer3 with PKCE Part 2 - Protected Resource Server</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-1-simple'>IdentityServer3 with PKCE Part 1 - Simple OAuth2 Server</a></li></ol></li><li class='history-month'><label for='2017-3'>March</label><input type='checkbox'  id='2017-3' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through'>TFS Continuous Integration Walk Through Part 5c - Multiple Solutions: Dependencies</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/sane-database-schema-conventions'>Sane Database Schema Conventions</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-agent'>TFS Continuous Integration - Agent Installation and Visual Studio Licensing</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-clickonce'>TFS Continuous Integration - ClickOnce Apps</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-and-private'>TFS Continuous Integration and Private NuGet Package Sources</a></li></ol></li><li class='history-month'><label for='2017-2'>February</label><input type='checkbox'  id='2017-2' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_22'>TFS Continuous Integration Walk Through Part 5b - Multiple Solutions: Simple Project References</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_20'>TFS Continuous Integration Walk Through Part 5a - Multiple Solutions: Overview</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_24'>TFS Continuous Integration Walk Through Part 4b - Problems With Traits</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_6'>TFS Continuous Integration Walk Through Part 4a - Filtering Tests</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_63'>TFS Continuous Integration Walk Through Part 3 - Notifications</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_5'>TFS Continuous Integration Walk Through Part 2 - Create an Automated Build</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through'>TFS Continuous Integration Walk Through Part 1 - Installing TFS and Checking In a Test Project</a></li></ol></li><li class='history-month'><label for='2017-1'>January</label><input type='checkbox'  id='2017-1' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/what-else-programmers-do-text'>What Else Programmers Do: A Text Manipulation Example</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/what-does-this-code-do-extended'>What does this code do? Extended explanation</a></li></ol></li></ol></li><li class='history-year'><label for='2016'>2016</label><input type='checkbox'  id='2016' /><ol><li class='history-month'><label for='2016-12'>December</label><input type='checkbox'  id='2016-12' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/nexus-5-gps-lock-problem-and-two'>Nexus 5 GPS Lock Problem and Three--or More!--Solutions</a></li></ol></li><li class='history-month'><label for='2016-11'>November</label><input type='checkbox'  id='2016-11' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/how-to-bypass-new-microsoft-office'>How to Bypass the New Microsoft Office Startup and Save Screens</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/google-tasks-vs-reminders-in-desktop'>Google Tasks vs Reminders in Desktop and Phone</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/catching-up-on-coding-claims-based-identity-part-1_6'>Catching Up on Coding - Claims-Based Identity Part 1</a></li></ol></li><li class='history-month'><label for='2016-10'>October</label><input type='checkbox'  id='2016-10' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/creating-forms-authentication'>Creating Forms Authentication Membership Tables in LocalDB–Right and Wrong Ways</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/windows-10-complaint-1-auto-update'>Windows 10 Complaint #1: Auto Update State Loss</a></li></ol></li><li class='history-month'><label for='2016-9'>September</label><input type='checkbox'  id='2016-9' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/disable-windows-10-photo-automatic'>Disable Windows 10 Photo Automatic Albums</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/a-laymans-explanation-of-mocking-and'>A Layman’s Explanation of Mocking and Dependency Injection</a></li></ol></li><li class='history-month'><label for='2016-8'>August</label><input type='checkbox'  id='2016-8' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-3'>Catching Up on Coding - TDD Part 3</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-2'>Catching Up on Coding - TDD Part 2</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-1'>Catching Up on Coding - TDD Part 1</a></li></ol></li><li class='history-month'><label for='2016-7'>July</label><input type='checkbox'  id='2016-7' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/writing-to-current-users-registry-when'>Writing to the Current User(s) Registry When Running as System</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/catching-up-on-coding-syllabus'>Catching Up on Coding - The Syllabus</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/quickly-enable-mercurial-keyring-for'>Quickly Enable Mercurial Keyring for BitBucket</a></li></ol></li><li class='history-month'><label for='2016-6'>June</label><input type='checkbox'  id='2016-6' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/create-easily-debuggable-windows-service'>Create an Easily Debuggable Windows Service</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/underrated-work-skills'>(Underrated) Work Skills</a></li></ol></li><li class='history-month'><label for='2016-5'>May</label><input type='checkbox'  id='2016-5' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/vbnet-windows-project-to-c-conversion'>VB.Net Windows Project to C# Conversion Tools Quick Review</a></li></ol></li><li class='history-month'><label for='2016-2'>February</label><input type='checkbox'  id='2016-2' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/scroll-bars-in-blogger-tags'>Scroll bars in Blogger &lt;pre&gt; Tags</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/google-keep-changes-taking-to-forums'>Google Keep Changes: Taking to the Forums</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/backward-step-for-google-keep'>Backward Step for Google Keep</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/recover-virtualbox-snapshots'>Recover VirtualBox Snapshots</a></li></ol></li><li class='history-month'><label for='2016-1'>January</label><input type='checkbox'  id='2016-1' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/auto-updating-new-windows-7-installation'>Auto Updating a New Windows 7 Installation</a></li></ol></li></ol></li><li class='history-year'><label for='2015'>2015</label><input type='checkbox'  id='2015' /><ol><li class='history-month'><label for='2015-8'>August</label><input type='checkbox'  id='2015-8' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/shoretel-brilliantly-simple'>ShoreTel - Brilliantly Simple?</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/the-google-photos-management-problems'>The Google Photos Management Problem(s)</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/creating-long-lasting-clickonce'>Creating a Long-Lasting ClickOnce Certificate</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/more-encrypted-config-filesclickonce'>More Encrypted Config Files–ClickOnce Complications</a></li></ol></li><li class='history-month'><label for='2015-7'>July</label><input type='checkbox'  id='2015-7' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/encrypting-appconfig'>Encrypting app.config</a></li></ol></li><li class='history-month'><label for='2015-3'>March</label><input type='checkbox'  id='2015-3' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/better-google-sites-designthe-notched'>Better Google Sites Design–The Notched Page</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/removing-unremovable-bluetooth-device'>Removing Unremovable Bluetooth Device: FAIL!</a></li></ol></li></ol></li><li class='history-year'><label for='2014'>2014</label><input type='checkbox'  id='2014' /><ol><li class='history-month'><label for='2014-11'>November</label><input type='checkbox'  id='2014-11' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/how-to-remove-savernet-and-similar'>How to remove Savernet (and similar) Chrome extension</a></li></ol></li><li class='history-month'><label for='2014-9'>September</label><input type='checkbox'  id='2014-9' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/prevent-word-from-restoring-minimized'>Prevent Word from Restoring Minimized Documents</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/clever-phish'>Clever Phish</a></li></ol></li><li class='history-month'><label for='2014-8'>August</label><input type='checkbox'  id='2014-8' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/enable-synaptics-touchpad-2-finger-tap'>Enable Synaptics touchpad 2-finger tap context menu</a></li></ol></li><li class='history-month'><label for='2014-5'>May</label><input type='checkbox'  id='2014-5' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/installing-fcm-flow-cytrometry-library'>Installing fcm flow cytrometry library on Windows 8.1</a></li></ol></li><li class='history-month'><label for='2014-4'>April</label><input type='checkbox'  id='2014-4' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/windows-81-update-1-driver-problem-dtmb'>Windows 8.1 Update 1 Driver Problem DTMB BDA TV USB</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/windows-81-window-key-s-search-from'>Windows 8.1: Window Key + S = Search from Desktop</a></li></ol></li><li class='history-month'><label for='2014-3'>March</label><input type='checkbox'  id='2014-3' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/whs-2011-windows-update-one-or-more'>WHS 2011 Windows Update “One or more services are no running” alert</a></li></ol></li><li class='history-month'><label for='2014-2'>February</label><input type='checkbox'  id='2014-2' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/lenovo-u530-touch-wifi-problem-continued'>Lenovo U530 Touch WiFi Problem Continued</a></li></ol></li><li class='history-month'><label for='2014-1'>January</label><input type='checkbox'  id='2014-1' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/lenovo-u530-touch-wifi-problem'>Lenovo U530 Touch WiFi Problem</a></li></ol></li></ol></li><li class='history-year'><label for='2013'>2013</label><input type='checkbox'  id='2013' /><ol><li class='history-month'><label for='2013-12'>December</label><input type='checkbox'  id='2013-12' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/whs-connector-restart-error-in-windows'>WHS Connector Restart Error in Windows 8.0/8.1</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/how-to-remove-apps-from-google-play-my'>How to Remove Apps from Google Play My Apps Site</a></li></ol></li><li class='history-month'><label for='2013-11'>November</label><input type='checkbox'  id='2013-11' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/windows-81-hidden-opt-ins-opt-outs'>Windows 8.1 Hidden Opt Ins/ Opt Outs</a></li></ol></li><li class='history-month'><label for='2013-9'>September</label><input type='checkbox'  id='2013-9' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-epilogue'>Edward Farley and the Fantastic Library Epilogue</a></li></ol></li><li class='history-month'><label for='2013-7'>July</label><input type='checkbox'  id='2013-7' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/a-week-or-more-of-jolicloud-day-2-end'>A Week (or More!) of JoliCloud - Day 2: THE END</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/a-week-or-more-of-jolicloud-day-1'>A Week (or More!) of JoliCloud - Day 1</a></li></ol></li><li class='history-month'><label for='2013-5'>May</label><input type='checkbox'  id='2013-5' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-12'>Edward Farley and the Fantastic Library Part 12</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-1019'>Edward Farley and the Fantastic Library Part 11</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-10'>Edward Farley and the Fantastic Library Part 10</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-9'>Edward Farley and the Fantastic Library Part 9</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-8'>Edward Farley and the Fantastic Library Part 8</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-7'>Edward Farley and the Fantastic Library Part 7</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-6'>Edward Farley and the Fantastic Library Part 6</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-5'>Edward Farley and the Fantastic Library Part 5</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-4'>Edward Farley and the Fantastic Library Part 4</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-3'>Edward Farley and the Fantastic Library Part 3</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-2'>Edward Farley and the Fantastic Library Part 2</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-1'>Edward Farley and the Fantastic Library Part 1</a></li></ol></li><li class='history-month'><label for='2013-4'>April</label><input type='checkbox'  id='2013-4' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/clean-up-orphaned-sql-users'>Clean Up Orphaned SQL Users</a></li></ol></li><li class='history-month'><label for='2013-3'>March</label><input type='checkbox'  id='2013-3' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/t-sql-one-to-one-cant-be-done'>T-SQL One to One Can't Be Done</a></li></ol></li><li class='history-month'><label for='2013-1'>January</label><input type='checkbox'  id='2013-1' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/test-post-with-code'>Migrating Google Drive</a></li></ol></li></ol></li></ol>
    </div>
  </nav>
  <header>
    <div id="site-image">
      <img src="http://www.softwaremeadows.com/images/header.png" alt="" />
    </div>
    <h1 id="site-name"></h1>
    <div id="site-subtitle">A pleasant walk through computing</div>
  </header>
  <section id="content">
    <h1 id="home">Home</h1>

  </section>
  <!-- posts only appear in home index -->
  <section id="posts">
    
              <div class='post'>
                <h2 class='post-title'><a href='http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-4'>IdentityServer3 with PKCE Part 4 - Persisting User Data</a></h2>
                <p class='post-info'><span class='posted-on'>2017-05-08 10:11</span></p>
                <div class='post-content'><p>This series simulates a native application accessing a protected Web API resource, using OAuth2 via <a href="https://github.com/IdentityServer/IdentityServer3">IdentityServer3</a>. It demonstrates using Proof Key for Code Exchange (PKCE), and is in four parts:</p>
<ol>
<li><a href="http://www.softwaremeadows.com/2017/05/identityserver3-with-pkce-part-1-simple.html">Build a simple authorization server, consumed by native application</a>.</li>
<li><a href="http://www.softwaremeadows.com/2017/05/identityserver3-with-pkce-part-2.html">Build a protected resource</a>.</li>
<li><a href="http://www.softwaremeadows.com/2017/05/identityserver3-with-pkce-part-3.html">Persist server configuration to database</a>.</li>
<li><a href="http://www.softwaremeadows.com/2017/05/identityserver3-with-pkce-part-4.html">Persist user data to database using Microsoft.Identity and SQL Server</a>.</li>
</ol>
<blockquote>
<p><strong>Important</strong> This series does <em>not</em> create an OpenID Connect (OIDC) server. It is OAuth-only, since the PKCE specification doesn't require OIDC.</p>
</blockquote>
<h1 id="where-were-at">Where We're At</h1>
<p>We're persisting IdentityServer configuration data, but still using in-memory users. IdentityServer can be extended to validate against an identity store, and supports Microsoft's AspNet.Identity via Entity Framework on SQL Server.</p>
<blockquote>
<p><strong>Important</strong> IdentityServer is <em>not</em> intended or used to add, edit or delete users. They make that clear. The server's job is only to verify identity. In this sample, there's a klunky method for populating the user database, and there are <em>no</em> API methods for registering a user. The API could be added using controller code similar to what's in the default ASP.NET Web API templates.</p>
</blockquote>
<h2 id="aspnetidentity">AspNetIdentity</h2>
<p><strong>References</strong> <a href="https://github.com/IdentityServer/IdentityServer3.AspNetIdentity">IdentityServer3.AspNetIdentity Sample</a> <a href="https://www.scottbrady91.com/Identity-Server/Identity-Server-3-using-ASPNET-Identity">Identity Server 3 using ASP.NET Identity</a> <a href="https://mindfulsoftware.com.au/guidance/oauth2-walkthrough-using-identity-server-and-aspnet/creating-an-identity-server-using-aspnet-identity-and-entity-framework-storage">OAuth2 Walkthrough using Identity Server and ASP.NET</a></p>
<p>Install these packages.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb1-1" data-line-number="1">Install-Package IdentityServer3.<span class="fu">AspNetIdentity</span> -Project AuthAndApi</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">Install-Package Microsoft.<span class="fu">AspNet</span>.<span class="fu">Identity</span>.<span class="fu">EntityFramework</span> -Version <span class="dv">2</span>.<span class="fu">2</span><span class="fl">.1</span> -Project AuthAndApi</a></code></pre></div>
<p>Add a new connection string to web.config, for the AspNet Identity database.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode xml"><code class="sourceCode xml"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">&lt;add</span><span class="ot"> name=</span><span class="st">"IdUsersDb"</span><span class="ot"> connectionString=</span><span class="st">"Server=(localDb)\MSSQLLocalDb;AttachDbFilename=|DataDirectory|IdUsers.mdb;Database=IdUsers-ncacpkce;Integrated Security=true;"</span><span class="ot"> providerName=</span><span class="st">"System.Data.SqlClient"</span> <span class="kw">/&gt;</span></a></code></pre></div>
<p>Update Factory.cs</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co">//Add these usings</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">using</span> Microsoft.<span class="fu">AspNet</span>.<span class="fu">Identity</span>.<span class="fu">EntityFramework</span>;</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">using</span> Microsoft.<span class="fu">AspNet</span>.<span class="fu">Identity</span>;</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">using</span> IdentityServer3.<span class="fu">AspNetIdentity</span>;</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw">using</span> IdentityServer3.<span class="fu">Core</span>.<span class="fu">Services</span>;</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="kw">using</span> IdentityServer3.<span class="fu">Core</span>.<span class="fu">Services</span>.<span class="fu">InMemory</span>;</a></code></pre></div>
<p>Change the Configure method, adding code to persist the users, and a new method to populate the database.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">public</span> <span class="kw">static</span> IdentityServerServiceFactory <span class="fu">Configure</span>(<span class="dt">string</span> optionsConnectionString, <span class="dt">string</span> usersConnectionString)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co">//Configure persisting IdentityServer operational services</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co">//The database will be created if needed. The default schema is being used.</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="dt">var</span> efConfig = <span class="kw">new</span> EntityFrameworkServiceOptions</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">{</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">ConnectionString = optionsConnectionString</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">};</a>
<a class="sourceLine" id="cb4-9" data-line-number="9"></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co">// these two calls just pre-populate the test DB from the in-memory config.</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="co">// clf note: there's probably a better way to do this for a production app.</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="fu">ConfigureClients</span>(Clients.<span class="fu">Get</span>(), efConfig);</a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="fu">ConfigureScopes</span>(Scopes.<span class="fu">Get</span>(), efConfig);</a>
<a class="sourceLine" id="cb4-14" data-line-number="14"></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="dt">var</span> factory = <span class="kw">new</span> <span class="fu">IdentityServerServiceFactory</span>();</a>
<a class="sourceLine" id="cb4-16" data-line-number="16">factory.<span class="fu">RegisterConfigurationServices</span>(efConfig);</a>
<a class="sourceLine" id="cb4-17" data-line-number="17">factory.<span class="fu">RegisterOperationalServices</span>(efConfig);</a>
<a class="sourceLine" id="cb4-18" data-line-number="18">factory.<span class="fu">ConfigureClientStoreCache</span>();</a>
<a class="sourceLine" id="cb4-19" data-line-number="19">factory.<span class="fu">ConfigureScopeStoreCache</span>();</a>
<a class="sourceLine" id="cb4-20" data-line-number="20"><span class="co">//persist users</span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21"><span class="co">//populate the database. This creates the database, if needed.</span></a>
<a class="sourceLine" id="cb4-22" data-line-number="22"><span class="fu">ConfigureUsers</span>(Users.<span class="fu">Get</span>(), usersConnectionString);</a>
<a class="sourceLine" id="cb4-23" data-line-number="23"><span class="co">//configure IdentityServer to use the database</span></a>
<a class="sourceLine" id="cb4-24" data-line-number="24">factory.<span class="fu">UserService</span> = <span class="kw">new</span> Registration&lt;IUserService&gt;(UserServiceFactory.<span class="fu">Create</span>(usersConnectionString));</a>
<a class="sourceLine" id="cb4-25" data-line-number="25"></a>
<a class="sourceLine" id="cb4-26" data-line-number="26"><span class="co">//configure cleanup for expired data</span></a>
<a class="sourceLine" id="cb4-27" data-line-number="27"><span class="dt">var</span> cleanup = <span class="kw">new</span> <span class="fu">TokenCleanup</span>(efConfig); <span class="co">//by default every 60 seconds</span></a>
<a class="sourceLine" id="cb4-28" data-line-number="28"></a>
<a class="sourceLine" id="cb4-29" data-line-number="29"><span class="kw">return</span> factory;</a>
<a class="sourceLine" id="cb4-30" data-line-number="30">}</a>
<a class="sourceLine" id="cb4-31" data-line-number="31"></a>
<a class="sourceLine" id="cb4-32" data-line-number="32"><span class="kw">public</span> <span class="kw">static</span> <span class="dt">void</span> <span class="fu">ConfigureUsers</span>(IEnumerable&lt;InMemoryUser&gt; users, <span class="dt">string</span> connectionString)</a>
<a class="sourceLine" id="cb4-33" data-line-number="33">{</a>
<a class="sourceLine" id="cb4-34" data-line-number="34"><span class="co">//create the Identity UserManager</span></a>
<a class="sourceLine" id="cb4-35" data-line-number="35"><span class="dt">var</span> context = <span class="kw">new</span> <span class="fu">IdentityDbContext</span>(connectionString);</a>
<a class="sourceLine" id="cb4-36" data-line-number="36"><span class="dt">var</span> userStore = <span class="kw">new</span> UserStore&lt;IdentityUser&gt;(context);</a>
<a class="sourceLine" id="cb4-37" data-line-number="37"><span class="dt">var</span> userManager = <span class="kw">new</span> UserManager&lt;IdentityUser&gt;(userStore);</a>
<a class="sourceLine" id="cb4-38" data-line-number="38"><span class="kw">foreach</span> (var user <span class="kw">in</span> users)</a>
<a class="sourceLine" id="cb4-39" data-line-number="39">{</a>
<a class="sourceLine" id="cb4-40" data-line-number="40"><span class="co">//no error checking!</span></a>
<a class="sourceLine" id="cb4-41" data-line-number="41"><span class="co">//only add if doesn't exist</span></a>
<a class="sourceLine" id="cb4-42" data-line-number="42"><span class="dt">var</span> test = userManager.<span class="fu">FindByName</span>(user.<span class="fu">Username</span>);</a>
<a class="sourceLine" id="cb4-43" data-line-number="43"><span class="kw">if</span> (test != <span class="kw">null</span>) { <span class="kw">continue</span>; }</a>
<a class="sourceLine" id="cb4-44" data-line-number="44">userManager.<span class="fu">Create</span>(<span class="kw">new</span> <span class="fu">IdentityUser</span>(user.<span class="fu">Username</span>), user.<span class="fu">Password</span>);</a>
<a class="sourceLine" id="cb4-45" data-line-number="45">test = userManager.<span class="fu">FindByName</span>(user.<span class="fu">Username</span>);</a>
<a class="sourceLine" id="cb4-46" data-line-number="46"><span class="kw">foreach</span> (var claim <span class="kw">in</span> user.<span class="fu">Claims</span>)</a>
<a class="sourceLine" id="cb4-47" data-line-number="47">{</a>
<a class="sourceLine" id="cb4-48" data-line-number="48"><span class="kw">if</span> (claim.<span class="fu">Type</span>.<span class="fu">ToLower</span>() == <span class="st">"email"</span>) { test.<span class="fu">Email</span> = claim.<span class="fu">Value</span>; }</a>
<a class="sourceLine" id="cb4-49" data-line-number="49">userManager.<span class="fu">AddClaim</span>(test.<span class="fu">Id</span>, claim);</a>
<a class="sourceLine" id="cb4-50" data-line-number="50">}</a>
<a class="sourceLine" id="cb4-51" data-line-number="51">userManager.<span class="fu">Update</span>(test);</a>
<a class="sourceLine" id="cb4-52" data-line-number="52">}</a>
<a class="sourceLine" id="cb4-53" data-line-number="53">}</a></code></pre></div>
<p>And finally, add a new factory class, which is used in the line <code>factory.UserServce =</code>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">public</span> <span class="kw">static</span> <span class="kw">class</span> UserServiceFactory</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="kw">public</span> <span class="kw">static</span> AspNetIdentityUserService&lt;IdentityUser, <span class="dt">string</span>&gt; <span class="fu">Create</span>(<span class="dt">string</span> connectionString)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">{</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="dt">var</span> context = <span class="kw">new</span> <span class="fu">IdentityDbContext</span>(connectionString);</a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="dt">var</span> userStore = <span class="kw">new</span> UserStore&lt;IdentityUser&gt;(context);</a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="dt">var</span> userManager = <span class="kw">new</span> UserManager&lt;IdentityUser&gt;(userStore);</a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="kw">return</span> <span class="kw">new</span> AspNetIdentityUserService&lt;IdentityUser, <span class="dt">string</span>&gt;(userManager);</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb5-10" data-line-number="10">}</a></code></pre></div>
<p>That's it! The Startup class doesn't change. Running the solution creates the new database, and the authentication works as before.</p>
<p><a href="images/17-05-06_165055.png"><img src="http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-4/images/17-05-06_165055.png" title="2017-05-06_165055" alt="2017-05-06_165055"></a></p>
<h1 id="wrap-up">Wrap Up</h1>
<p>In this series, I demonstrated authorizing a mobile application in a secure way. This was necessarily a simple sample. Some natural next steps and questions to answer would be:</p>
<ol>
<li>How to customize the IdentityServer login and authorization screens</li>
<li>Configure for OpenID Connect3</li>
<li>Show using Google authentication</li>
</ol>
</div>
              </div>
              

              <div class='post'>
                <h2 class='post-title'><a href='http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-3'>IdentityServer3 with PKCE Part 3 - Persist IdentityServer Configuration</a></h2>
                <p class='post-info'><span class='posted-on'>2017-05-08 10:09</span></p>
                <div class='post-content'><p>This series simulates a native application accessing a protected Web API resource, using OAuth2 via <a href="https://github.com/IdentityServer/IdentityServer3">IdentityServer3</a>. It demonstrates using Proof Key for Code Exchange (PKCE), and is in four parts:</p>
<ol>
<li><a href="http://www.softwaremeadows.com/2017/05/identityserver3-with-pkce-part-1-simple.html">Build a simple authorization server, consumed by native application</a>.</li>
<li><a href="http://www.softwaremeadows.com/2017/05/identityserver3-with-pkce-part-2.html">Build a protected resource</a>.</li>
<li><a href="http://www.softwaremeadows.com/2017/05/identityserver3-with-pkce-part-3.html">Persist server configuration to database</a>.</li>
<li><a href="http://www.softwaremeadows.com/2017/05/identityserver3-with-pkce-part-4.html">Persist user data to database using Microsoft.Identity and SQL Server</a>.</li>
</ol>
<blockquote>
<p><strong>Important</strong> This series does <em>not</em> create an OpenID Connect (OIDC) server. It is OAuth-only, since the PKCE specification doesn't require OIDC.</p>
</blockquote>
<h1 id="where-were-at">Where We're At</h1>
<p>Until now, we've been using in-memory configuration data (clients and scopes). But we'd like a way to persist the configuration to a database.</p>
<h2 id="identityserver-and-entity-framework">IdentityServer and Entity Framework</h2>
<p><strong>References</strong></p>
<p><a href="https://identityserver.github.io/Documentation/docsv2/ef/overview.html">Entity Framework support for Clients, Scopes, and Operational Data</a> <a href="https://identityserver.github.io/Documentation/docsv2/ef/operational.html">Operational Data</a> <a href="https://identityserver.github.io/Documentation/docsv2/ef/clients_scopes.html">Clients and Scopes</a> <a href="https://identityserver.github.io/Documentation/docsv2/advanced/caching.html">Caching results for client, scope, and user stores</a></p>
<p>Add these packages.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb1-1" data-line-number="1">Install-Package IdentityServer3.<span class="fu">EntityFramework</span> -Project AuthAndApi</a></code></pre></div>
<p>Add the App_Data folder. This is required if you want to use the connection string below.</p>
<p>Add a connection string for the configuration database. The sample uses SQL localDb 2016.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode xml"><code class="sourceCode xml"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">&lt;connectionStrings&gt;</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">&lt;add</span><span class="ot"> name=</span><span class="st">"IdConfigDb"</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="ot">connectionString=</span><span class="st">"Server=(localDb)\MSSQLLocalDb;AttachDbFilename=|DataDirectory|IdConfig.mdb;Database=IdConfig;Integrated Security=true;"</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="ot">providerName=</span><span class="st">"System.Data.SqlClient"</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="kw">&lt;/connectionStrings&gt;</span></a></code></pre></div>
<p>Add an IdentityServerConfiguration folder, and a Factory.cs class. The factory class takes care of setting the configuration database source, and also initially populating the database using our in-memory client and scope collections.</p>
<blockquote>
<p><strong>Note</strong> This sample doesn't provide a way to edit configuration data. There is a NuGet package that adds web-based configuration administration to a project. I haven't tried it, but here's the link. <a href="https://github.com/IdentityServer/IdentityServer3.Admin">IdentityServer3.Admin</a></p>
</blockquote>
<p><strong>Factory.cs</strong></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">using</span> System;</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">using</span> System.<span class="fu">Collections</span>.<span class="fu">Generic</span>;</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">using</span> System.<span class="fu">Linq</span>;</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">using</span> System.<span class="fu">Web</span>;</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co">//Added</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="kw">using</span> IdentityServer3.<span class="fu">Core</span>.<span class="fu">Configuration</span>;</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="kw">using</span> IdentityServer3.<span class="fu">EntityFramework</span>;</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="kw">using</span> IdentityServer3.<span class="fu">Core</span>.<span class="fu">Models</span>;</a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="kw">using</span> AuthAndApi.<span class="fu">IdOptions</span>;</a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="kw">using</span> AuthAndApi.<span class="fu">IdUsers</span>;</a>
<a class="sourceLine" id="cb3-11" data-line-number="11"></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="kw">namespace</span> AuthAndApi.<span class="fu">IdentityServerConfiguration</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13">{</a>
<a class="sourceLine" id="cb3-14" data-line-number="14"><span class="kw">public</span> <span class="kw">class</span> Factory</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">{</a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="kw">public</span> <span class="kw">static</span> IdentityServerServiceFactory <span class="fu">Configure</span>(<span class="dt">string</span> optionsConnectionString)</a>
<a class="sourceLine" id="cb3-17" data-line-number="17">{</a>
<a class="sourceLine" id="cb3-18" data-line-number="18"><span class="co">//Configure persisting IdentityServer operational services</span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19"><span class="co">//The database will be created if needed. The default schema is being used.</span></a>
<a class="sourceLine" id="cb3-20" data-line-number="20"><span class="dt">var</span> efConfig = <span class="kw">new</span> EntityFrameworkServiceOptions</a>
<a class="sourceLine" id="cb3-21" data-line-number="21">{</a>
<a class="sourceLine" id="cb3-22" data-line-number="22">ConnectionString = optionsConnectionString</a>
<a class="sourceLine" id="cb3-23" data-line-number="23">};</a>
<a class="sourceLine" id="cb3-24" data-line-number="24"></a>
<a class="sourceLine" id="cb3-25" data-line-number="25"><span class="co">// these two calls just pre-populate the test DB from the in-memory config.</span></a>
<a class="sourceLine" id="cb3-26" data-line-number="26"><span class="co">// clf note: there's probably a better way to do this for a production app.</span></a>
<a class="sourceLine" id="cb3-27" data-line-number="27"><span class="fu">ConfigureClients</span>(Clients.<span class="fu">Get</span>(), efConfig);</a>
<a class="sourceLine" id="cb3-28" data-line-number="28"><span class="fu">ConfigureScopes</span>(Scopes.<span class="fu">Get</span>(), efConfig);</a>
<a class="sourceLine" id="cb3-29" data-line-number="29"></a>
<a class="sourceLine" id="cb3-30" data-line-number="30"><span class="dt">var</span> factory = <span class="kw">new</span> <span class="fu">IdentityServerServiceFactory</span>();</a>
<a class="sourceLine" id="cb3-31" data-line-number="31">factory.<span class="fu">RegisterConfigurationServices</span>(efConfig);</a>
<a class="sourceLine" id="cb3-32" data-line-number="32">factory.<span class="fu">RegisterOperationalServices</span>(efConfig);</a>
<a class="sourceLine" id="cb3-33" data-line-number="33">factory.<span class="fu">ConfigureClientStoreCache</span>();</a>
<a class="sourceLine" id="cb3-34" data-line-number="34">factory.<span class="fu">ConfigureScopeStoreCache</span>();</a>
<a class="sourceLine" id="cb3-35" data-line-number="35"><span class="co">//Still using in-memory users for now</span></a>
<a class="sourceLine" id="cb3-36" data-line-number="36">factory.<span class="fu">UseInMemoryUsers</span>(Users.<span class="fu">Get</span>());</a>
<a class="sourceLine" id="cb3-37" data-line-number="37"></a>
<a class="sourceLine" id="cb3-38" data-line-number="38"><span class="kw">return</span> factory;</a>
<a class="sourceLine" id="cb3-39" data-line-number="39">}</a>
<a class="sourceLine" id="cb3-40" data-line-number="40"></a>
<a class="sourceLine" id="cb3-41" data-line-number="41"><span class="kw">public</span> <span class="kw">static</span> <span class="dt">void</span> <span class="fu">ConfigureClients</span>(IEnumerable&lt;Client&gt; clients, EntityFrameworkServiceOptions options)</a>
<a class="sourceLine" id="cb3-42" data-line-number="42">{</a>
<a class="sourceLine" id="cb3-43" data-line-number="43"><span class="kw">using</span> (<span class="dt">var</span> db = <span class="kw">new</span> <span class="fu">ClientConfigurationDbContext</span>(options.<span class="fu">ConnectionString</span>, options.<span class="fu">Schema</span>))</a>
<a class="sourceLine" id="cb3-44" data-line-number="44">{</a>
<a class="sourceLine" id="cb3-45" data-line-number="45"><span class="kw">if</span> (!db.<span class="fu">Clients</span>.<span class="fu">Any</span>())</a>
<a class="sourceLine" id="cb3-46" data-line-number="46">{</a>
<a class="sourceLine" id="cb3-47" data-line-number="47"><span class="kw">foreach</span> (var c <span class="kw">in</span> clients)</a>
<a class="sourceLine" id="cb3-48" data-line-number="48">{</a>
<a class="sourceLine" id="cb3-49" data-line-number="49"><span class="dt">var</span> e = c.<span class="fu">ToEntity</span>();</a>
<a class="sourceLine" id="cb3-50" data-line-number="50">db.<span class="fu">Clients</span>.<span class="fu">Add</span>(e);</a>
<a class="sourceLine" id="cb3-51" data-line-number="51">}</a>
<a class="sourceLine" id="cb3-52" data-line-number="52">db.<span class="fu">SaveChanges</span>();</a>
<a class="sourceLine" id="cb3-53" data-line-number="53">}</a>
<a class="sourceLine" id="cb3-54" data-line-number="54">}</a>
<a class="sourceLine" id="cb3-55" data-line-number="55">}</a>
<a class="sourceLine" id="cb3-56" data-line-number="56"></a>
<a class="sourceLine" id="cb3-57" data-line-number="57"><span class="kw">public</span> <span class="kw">static</span> <span class="dt">void</span> <span class="fu">ConfigureScopes</span>(IEnumerable&lt;Scope&gt; scopes, EntityFrameworkServiceOptions options)</a>
<a class="sourceLine" id="cb3-58" data-line-number="58">{</a>
<a class="sourceLine" id="cb3-59" data-line-number="59"><span class="kw">using</span> (<span class="dt">var</span> db = <span class="kw">new</span> <span class="fu">ScopeConfigurationDbContext</span>(options.<span class="fu">ConnectionString</span>, options.<span class="fu">Schema</span>))</a>
<a class="sourceLine" id="cb3-60" data-line-number="60">{</a>
<a class="sourceLine" id="cb3-61" data-line-number="61"><span class="kw">if</span> (!db.<span class="fu">Scopes</span>.<span class="fu">Any</span>())</a>
<a class="sourceLine" id="cb3-62" data-line-number="62">{</a>
<a class="sourceLine" id="cb3-63" data-line-number="63"><span class="kw">foreach</span> (var s <span class="kw">in</span> scopes)</a>
<a class="sourceLine" id="cb3-64" data-line-number="64">{</a>
<a class="sourceLine" id="cb3-65" data-line-number="65"><span class="dt">var</span> e = s.<span class="fu">ToEntity</span>();</a>
<a class="sourceLine" id="cb3-66" data-line-number="66">db.<span class="fu">Scopes</span>.<span class="fu">Add</span>(e);</a>
<a class="sourceLine" id="cb3-67" data-line-number="67">}</a>
<a class="sourceLine" id="cb3-68" data-line-number="68">db.<span class="fu">SaveChanges</span>();</a>
<a class="sourceLine" id="cb3-69" data-line-number="69">}</a>
<a class="sourceLine" id="cb3-70" data-line-number="70">}</a>
<a class="sourceLine" id="cb3-71" data-line-number="71">}</a>
<a class="sourceLine" id="cb3-72" data-line-number="72">}</a>
<a class="sourceLine" id="cb3-73" data-line-number="73">}</a></code></pre></div>
<p>Update Startup.cs, replacing the previous IdentityServer configuration that explicitly configured the Factory with in-memory data, with the new call to Factory.Configure.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co">//Configure IdentityServer for issuing authentication tokens</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="dt">var</span> options = <span class="kw">new</span> IdentityServerOptions</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">{</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">Factory = Factory.<span class="fu">Configure</span>(<span class="st">"IdConfigDb"</span>),</a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co">//SSL MUST be used in production</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="kw">#if</span> DEBUG</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">RequireSsl = <span class="kw">false</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="kw">#endif</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9">};</a>
<a class="sourceLine" id="cb4-10" data-line-number="10">app.<span class="fu">UseIdentityServer</span>(options);</a></code></pre></div>
<blockquote>
<p><strong>ASIDE!</strong></p>
<p>Running the app at this point, I got an error in Startup.cs that I was missing a dependency.</p>
<p><a href="images/17-05-06_134432_1.png"><img src="http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-3/images/17-05-06_134432_1.png" title="2017-05-06_134432" alt="2017-05-06_134432"></a></p>
<p>When I installed the package <code>IdentityServer3.EntityFramework</code>, Newtonsoft.Json version 8 was uninstalled, because the package requires version 9 or greater. The package installer output confirms this.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb5-1" data-line-number="1">Successfully uninstalled 'Newtonsoft.<span class="fu">Json</span>.<span class="fu">8</span>.<span class="fu">0</span><span class="fl">.3</span>' from AuthAndApi</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">Successfully installed 'Newtonsoft.<span class="fu">Json</span> <span class="dv">9</span>.<span class="fu">0</span><span class="fl">.1</span>' to AuthAndApi</a></code></pre></div>
<p>No package requires version 8 or lower, so what gives? For some reason, the solution's web.config assembly binding section wasn't updated properly. It still had this:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode xml"><code class="sourceCode xml"><a class="sourceLine" id="cb6-1" data-line-number="1">     <span class="kw">&lt;dependentAssembly&gt;</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">       <span class="kw">&lt;assemblyIdentity</span><span class="ot"> name=</span><span class="st">"Newtonsoft.Json"</span><span class="ot"> publicKeyToken=</span><span class="st">"30ad4fe6b2a6aeed"</span><span class="ot"> culture=</span><span class="st">"neutral"</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">       <span class="kw">&lt;bindingRedirect</span><span class="ot"> oldVersion=</span><span class="st">"0.0.0.0-8.0.0.0"</span><span class="ot"> newVersion=</span><span class="st">"8.0.0.0"</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">     <span class="kw">&lt;/dependentAssembly&gt;</span></a></code></pre></div>
<p>You could manually change the max version number to 9.0.0.0, reinstall the Newtonsoft package which will do it for you.</p>
<p><code>Update-Package -Reinstall Newtonsoft.Json -Project AuthAndApi</code></p>
</blockquote>
<p>When I run the application, it behaves exactly as before. Checking in the App_Data folder, I see my database was created.</p>
<p><a href="images/17-05-06_140602.png"><img src="http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-3/images/17-05-06_140602.png" title="2017-05-06_140602" alt="2017-05-06_140602"></a></p>
<p>One difference, though. After the first time running the app, I no longer was prompted to authorize the scope. This might be related to these factory settings:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb7-1" data-line-number="1">factory.<span class="fu">ConfigureClientStoreCache</span>();</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">factory.<span class="fu">ConfigureScopeStoreCache</span>();</a></code></pre></div>
<h1 id="wrap-up">Wrap Up</h1>
<p>Our server's configuration is now being persisted to a database. The only thing (for this sample!) left is to persist the user's credentials and claims.</p>
</div>
              </div>
              

              <div class='post'>
                <h2 class='post-title'><a href='http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-2'>IdentityServer3 with PKCE Part 2 - Protected Resource Server</a></h2>
                <p class='post-info'><span class='posted-on'>2017-05-08 10:07</span></p>
                <div class='post-content'><p>This series simulates a native application accessing a protected Web API resource, using OAuth2 via <a href="https://github.com/IdentityServer/IdentityServer3">IdentityServer3</a>. It demonstrates using Proof Key for Code Exchange (PKCE), and is in four parts:</p>
<ol>
<li><a href="http://www.softwaremeadows.com/2017/05/identityserver3-with-pkce-part-1-simple.html">Build a simple authorization server, consumed by native application</a>.</li>
<li><a href="http://www.softwaremeadows.com/2017/05/identityserver3-with-pkce-part-2.html">Build a protected resource</a>.</li>
<li><a href="http://www.softwaremeadows.com/2017/05/identityserver3-with-pkce-part-3.html">Persist server configuration to database</a>.</li>
<li><a href="http://www.softwaremeadows.com/2017/05/identityserver3-with-pkce-part-4.html">Persist user data to database using Microsoft.Identity and SQL Server</a>.</li>
</ol>
<blockquote>
<p><strong>Important</strong> This series does <em>not</em> create an OpenID Connect (OIDC) server. It is OAuth-only, since the PKCE specification doesn't require OIDC.</p>
</blockquote>
<h1 id="where-were-at">Where We're At</h1>
<p>We can get a token, but there's nothing to use it on. We've configured IdentityServer with information about our client application (PretendMobile), and we used that information (Client ID, etc) to get a token.</p>
<p>Now we'll add a Web API with a protected method that just returns some claim data. It will be configured to:</p>
<ol>
<li>Accept the access token our pretend mobile app gets from the authorization server.</li>
<li>Validate that token against the authorization server.</li>
</ol>
<p>We'll use the same project as the authorization server, but it's important to know that the Web API could be in a completely separate project.</p>
<h2 id="web-api">Web API</h2>
<p><strong>References</strong> <a href="https://identityserver.github.io/Documentation/docsv2/overview/simplestOAuth.html">Simplest OAuth Server</a> <a href="https://github.com/IdentityServer/IdentityServer3.Samples/tree/master/source/Simplest%20OAuth2%20Walkthrough">Simplest OAuth2 Walkthrough Code</a></p>
<p>Install the packages for Web API, and being able to accept the IdentityServer tokens. Note IdentityModel version, which is latest for .Net 4.6 (2.x is for .Net Core).</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb1-1" data-line-number="1">Install-Package Microsoft.<span class="fu">AspNet</span>.<span class="fu">WebApi</span>.<span class="fu">Client</span> -Version <span class="dv">5</span>.<span class="fu">2</span><span class="fl">.3</span> -Project AuthAndApi</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">Install-Package Microsoft.<span class="fu">AspNet</span>.<span class="fu">WebApi</span>.<span class="fu">Owin</span> -Version <span class="dv">5</span>.<span class="fu">2</span><span class="fl">.3</span> -Project AuthAndApi</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">Install-Package IdentityModel -Version <span class="dv">1</span>.<span class="fu">9</span><span class="fl">.2</span> -Project AuthAndApi</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">Install-Package IdentityServer3.<span class="fu">AccessTokenValidation</span> -Version <span class="dv">2</span>.<span class="fu">15</span><span class="fl">.0</span> -Project AuthAndApi</a></code></pre></div>
<p>Add two things to the OWIN pipeline: accepting access tokens, and using WebApi.</p>
<p><strong>Updated Startup.cs</strong></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">using</span> System;</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">using</span> System.<span class="fu">Collections</span>.<span class="fu">Generic</span>;</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">using</span> System.<span class="fu">Linq</span>;</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="kw">using</span> System.<span class="fu">Web</span>;</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="co">//Added</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="kw">using</span> IdentityServer3.<span class="fu">Core</span>.<span class="fu">Configuration</span>;</a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="kw">using</span> Owin;</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="kw">using</span> AuthAndApi.<span class="fu">IdOptions</span>;</a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="kw">using</span> AuthAndApi.<span class="fu">IdUsers</span>;</a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="kw">using</span> System.<span class="fu">Web</span>.<span class="fu">Http</span>;</a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="kw">using</span> IdentityServer3.<span class="fu">AccessTokenValidation</span>;</a>
<a class="sourceLine" id="cb2-12" data-line-number="12"></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="kw">namespace</span> AuthAndApi</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">{</a>
<a class="sourceLine" id="cb2-15" data-line-number="15"><span class="kw">public</span> <span class="kw">class</span> Startup</a>
<a class="sourceLine" id="cb2-16" data-line-number="16">{</a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">Configuration</span>(IAppBuilder app)</a>
<a class="sourceLine" id="cb2-18" data-line-number="18">{</a>
<a class="sourceLine" id="cb2-19" data-line-number="19"><span class="co">//Configure IdentityServer for issuing authentication tokens</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20"><span class="dt">var</span> options = <span class="kw">new</span> IdentityServerOptions</a>
<a class="sourceLine" id="cb2-21" data-line-number="21">{</a>
<a class="sourceLine" id="cb2-22" data-line-number="22">Factory = <span class="kw">new</span> <span class="fu">IdentityServerServiceFactory</span>()</a>
<a class="sourceLine" id="cb2-23" data-line-number="23">.<span class="fu">UseInMemoryClients</span>(Clients.<span class="fu">Get</span>())</a>
<a class="sourceLine" id="cb2-24" data-line-number="24">.<span class="fu">UseInMemoryScopes</span>(Scopes.<span class="fu">Get</span>())</a>
<a class="sourceLine" id="cb2-25" data-line-number="25">.<span class="fu">UseInMemoryUsers</span>(Users.<span class="fu">Get</span>()),</a>
<a class="sourceLine" id="cb2-26" data-line-number="26"><span class="co">//SSL MUST be used in production</span></a>
<a class="sourceLine" id="cb2-27" data-line-number="27"><span class="kw">#if</span> DEBUG</a>
<a class="sourceLine" id="cb2-28" data-line-number="28">RequireSsl = <span class="kw">false</span></a>
<a class="sourceLine" id="cb2-29" data-line-number="29"><span class="kw">#endif</span></a>
<a class="sourceLine" id="cb2-30" data-line-number="30">};</a>
<a class="sourceLine" id="cb2-31" data-line-number="31">app.<span class="fu">UseIdentityServer</span>(options);</a>
<a class="sourceLine" id="cb2-32" data-line-number="32"></a>
<a class="sourceLine" id="cb2-33" data-line-number="33"><span class="co">// Configure Web API to accept access tokens from IdentityServer, and require a scope of 'email'</span></a>
<a class="sourceLine" id="cb2-34" data-line-number="34">app.<span class="fu">UseIdentityServerBearerTokenAuthentication</span>(<span class="kw">new</span> IdentityServerBearerTokenAuthenticationOptions</a>
<a class="sourceLine" id="cb2-35" data-line-number="35">{</a>
<a class="sourceLine" id="cb2-36" data-line-number="36"><span class="co">//In this case, the authorization server is also the Web API server</span></a>
<a class="sourceLine" id="cb2-37" data-line-number="37">Authority = <span class="st">"http://localhost:27230"</span>,</a>
<a class="sourceLine" id="cb2-38" data-line-number="38">ValidationMode = ValidationMode.<span class="fu">ValidationEndpoint</span>,</a>
<a class="sourceLine" id="cb2-39" data-line-number="39">RequiredScopes = <span class="kw">new</span>[] { <span class="st">"email"</span> }</a>
<a class="sourceLine" id="cb2-40" data-line-number="40">});</a>
<a class="sourceLine" id="cb2-41" data-line-number="41"></a>
<a class="sourceLine" id="cb2-42" data-line-number="42"><span class="co">//Configure Web API</span></a>
<a class="sourceLine" id="cb2-43" data-line-number="43"><span class="dt">var</span> config = <span class="kw">new</span> <span class="fu">HttpConfiguration</span>();</a>
<a class="sourceLine" id="cb2-44" data-line-number="44">config.<span class="fu">MapHttpAttributeRoutes</span>();</a>
<a class="sourceLine" id="cb2-45" data-line-number="45">app.<span class="fu">UseWebApi</span>(config);</a>
<a class="sourceLine" id="cb2-46" data-line-number="46">}</a>
<a class="sourceLine" id="cb2-47" data-line-number="47">}</a>
<a class="sourceLine" id="cb2-48" data-line-number="48">}</a></code></pre></div>
<p>Add a Controllers folder, and a controller named Test.</p>
<p><a href="images/17-05-06_114024.png"><img src="http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-2/images/17-05-06_114024.png" title="2017-05-06_114024" alt="2017-05-06_114024"></a><a href="images/17-05-06_114144_1.png"><img src="http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-2/images/17-05-06_114144_1.png" title="2017-05-06_114144" alt="2017-05-06_114144"></a><a href="images/17-05-06_114210.png"><img src="http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-2/images/17-05-06_114210.png" title="2017-05-06_114210" alt="2017-05-06_114210"></a></p>
<p>Create an API method that requires authorization. The method checks for evidence a user authorized (and not just the application).</p>
<blockquote>
<p><strong>Note</strong> Code shamelessly stolen from the IdentityServer samples</p>
</blockquote>
<p><strong>TestController.cs</strong></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">using</span> System;</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">using</span> System.<span class="fu">Collections</span>.<span class="fu">Generic</span>;</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">using</span> System.<span class="fu">Linq</span>;</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">using</span> System.<span class="fu">Net</span>;</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw">using</span> System.<span class="fu">Net</span>.<span class="fu">Http</span>;</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="kw">using</span> System.<span class="fu">Web</span>.<span class="fu">Http</span>;</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="co">//Added</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="kw">using</span> System.<span class="fu">Security</span>.<span class="fu">Claims</span>;</a>
<a class="sourceLine" id="cb3-9" data-line-number="9"></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="kw">namespace</span> AuthAndApi.<span class="fu">Controllers</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11">{</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">[<span class="fu">Route</span>(<span class="st">"test"</span>)]</a>
<a class="sourceLine" id="cb3-13" data-line-number="13">[Authorize]</a>
<a class="sourceLine" id="cb3-14" data-line-number="14"><span class="kw">public</span> <span class="kw">class</span> TestController : ApiController</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">{</a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="kw">public</span> IHttpActionResult <span class="fu">Get</span>()</a>
<a class="sourceLine" id="cb3-17" data-line-number="17">{</a>
<a class="sourceLine" id="cb3-18" data-line-number="18"><span class="dt">var</span> user = User <span class="kw">as</span> ClaimsPrincipal;</a>
<a class="sourceLine" id="cb3-19" data-line-number="19"></a>
<a class="sourceLine" id="cb3-20" data-line-number="20"><span class="dt">var</span> subjectClaim = user.<span class="fu">FindFirst</span>(<span class="st">"sub"</span>);</a>
<a class="sourceLine" id="cb3-21" data-line-number="21"><span class="kw">if</span> (subjectClaim != <span class="kw">null</span>)</a>
<a class="sourceLine" id="cb3-22" data-line-number="22">{</a>
<a class="sourceLine" id="cb3-23" data-line-number="23"><span class="kw">return</span> <span class="fu">Json</span>(<span class="kw">new</span></a>
<a class="sourceLine" id="cb3-24" data-line-number="24">{</a>
<a class="sourceLine" id="cb3-25" data-line-number="25">message = <span class="st">"OK user"</span>,</a>
<a class="sourceLine" id="cb3-26" data-line-number="26">client = user.<span class="fu">FindFirst</span>(<span class="st">"client_id"</span>).<span class="fu">Value</span>,</a>
<a class="sourceLine" id="cb3-27" data-line-number="27">subject = subjectClaim.<span class="fu">Value</span>,</a>
<a class="sourceLine" id="cb3-28" data-line-number="28">email = user.<span class="fu">FindFirst</span>(<span class="st">"email"</span>).<span class="fu">Value</span></a>
<a class="sourceLine" id="cb3-29" data-line-number="29">});</a>
<a class="sourceLine" id="cb3-30" data-line-number="30">}</a>
<a class="sourceLine" id="cb3-31" data-line-number="31"><span class="kw">else</span></a>
<a class="sourceLine" id="cb3-32" data-line-number="32">{</a>
<a class="sourceLine" id="cb3-33" data-line-number="33"><span class="kw">return</span> <span class="fu">Json</span>(<span class="kw">new</span></a>
<a class="sourceLine" id="cb3-34" data-line-number="34">{</a>
<a class="sourceLine" id="cb3-35" data-line-number="35">message = <span class="st">"User claim not found for this client_id"</span>,</a>
<a class="sourceLine" id="cb3-36" data-line-number="36">client = user.<span class="fu">FindFirst</span>(<span class="st">"client_id"</span>).<span class="fu">Value</span></a>
<a class="sourceLine" id="cb3-37" data-line-number="37">});</a>
<a class="sourceLine" id="cb3-38" data-line-number="38">}</a>
<a class="sourceLine" id="cb3-39" data-line-number="39">}</a>
<a class="sourceLine" id="cb3-40" data-line-number="40">}</a>
<a class="sourceLine" id="cb3-41" data-line-number="41">}</a></code></pre></div>
<p>The API server now has a protected resource. Let's prove it requires authorization. Run the application. The console will still get an access token, but we're not doing anything with it, yet. Leave the project running and manually enter this URL into a browser to try to access the protected resource.</p>
<p><code>http://localhost:27230/test</code></p>
<p>The server will return something like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode xml"><code class="sourceCode xml"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">&lt;Error&gt;</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw">&lt;Message&gt;</span>Authorization has been denied for this request.<span class="kw">&lt;/Message&gt;</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="kw">&lt;/Error&gt;</span></a></code></pre></div>
<h2 id="pretend-mobile-app---access-protected-resource">Pretend Mobile App - Access Protected Resource</h2>
<p>In the PretendMobile project, add and call a method that access the protected Web API resource. The token is added to the request in the Authorization header.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">static</span> <span class="dt">void</span> <span class="fu">Main</span>(<span class="dt">string</span>[] args)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co">//get token</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="dt">var</span> response = <span class="fu">GetAccessToken</span>();</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">Console.<span class="fu">WriteLine</span>(<span class="st">"Access Token: "</span> + response.<span class="fu">AccessToken</span>);</a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="co">//use token</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="fu">CallProtectedApiResource</span>(response.<span class="fu">AccessToken</span>);</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">Console.<span class="fu">ReadLine</span>();</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb5-10" data-line-number="10"></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="kw">static</span> <span class="dt">void</span> <span class="fu">CallProtectedApiResource</span>(<span class="dt">string</span> access_token)</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">{</a>
<a class="sourceLine" id="cb5-13" data-line-number="13"><span class="dt">var</span> client = <span class="kw">new</span> <span class="fu">HttpClient</span>();</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">client.<span class="fu">SetBearerToken</span>(access_token);</a>
<a class="sourceLine" id="cb5-15" data-line-number="15">Console.<span class="fu">WriteLine</span>(client.<span class="fu">GetStringAsync</span>(<span class="st">"http://localhost:27230/test"</span>).<span class="fu">Result</span>);</a>
<a class="sourceLine" id="cb5-16" data-line-number="16">}</a></code></pre></div>
<p>Run the solution. After authorizing, the application successfully gets the protected resource's data.</p>
<p><a href="images/17-05-06_121035_1.png"><img src="http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-2/images/17-05-06_121035_1.png" title="2017-05-06_121035" alt="2017-05-06_121035"></a></p>
<h1 id="wrap-up">Wrap Up</h1>
<p>We now have a fully functioning mobile application! Next up, persisting the IdentityServer configuration.</p>
</div>
              </div>
              
    <div class='paging'><a href='index2.html'>Newer</a>&nbsp;&nbsp;&nbsp;<a href='index4.html'>Older</a></div>
  </section>
  <footer><p>Copyright (c) 2018 Charles L Flatt</p>
</footer>
  
</body>

</html>