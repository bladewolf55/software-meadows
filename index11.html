<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  
  <link rel='stylesheet' href='http://www.softwaremeadows.com/css/default.css' />
<link rel='stylesheet' href='http://www.softwaremeadows.com/css/tango.css' />

  <title>Home | Software Meadows</title>
</head>

<body>
  <nav>
    <div id="menu">
      <ol>
<li><a href="http://www.softwaremeadows.com/">Home</a></li>
<li><a href="http://www.softwaremeadows.com/about">About</a></li>
</ol>

    </div>
    <div id="recent">
      <h2>Recent</h2>
      <a href='http://www.softwaremeadows.com/posts/announcing_deftconfig'>Announcing DeftConfig</a><a href='http://www.softwaremeadows.com/posts/tfs_2015_publish_asp_net_using_robocopy'>TFS 2015: Publish ASP.NET Using Robocopy</a><a href='http://www.softwaremeadows.com/posts/combining_veracrypt_google_backup_sync_sql_server_part_2'>Combining VeraCrypt, Google Backup & Sync, and Sql Server Part 2</a><a href='http://www.softwaremeadows.com/posts/combining_veracrypt_google_backup_sync_sql_server_part_1'>Combining VeraCrypt, Google Backup & Sync, and Sql Server Part 1</a><a href='http://www.softwaremeadows.com/posts/new-blog-engine'>New Blog Engine</a>
    </div>
    <div id="history">
      <h2>History</h2>
      <ol class='tree'><li class='history-year'><label for='2018'>2018</label><input type='checkbox'  id='2018' /><ol><li class='history-month'><label for='2018-3'>March</label><input type='checkbox'  id='2018-3' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/announcing_deftconfig'>Announcing DeftConfig</a></li></ol></li><li class='history-month'><label for='2018-1'>January</label><input type='checkbox'  id='2018-1' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs_2015_publish_asp_net_using_robocopy'>TFS 2015: Publish ASP.NET Using Robocopy</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/combining_veracrypt_google_backup_sync_sql_server_part_2'>Combining VeraCrypt, Google Backup & Sync, and Sql Server Part 2</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/combining_veracrypt_google_backup_sync_sql_server_part_1'>Combining VeraCrypt, Google Backup & Sync, and Sql Server Part 1</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/new-blog-engine'>New Blog Engine</a></li></ol></li></ol></li><li class='history-year'><label for='2017'>2017</label><input type='checkbox'  id='2017' /><ol><li class='history-month'><label for='2017-8'>August</label><input type='checkbox'  id='2017-8' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/dont-use-data-prefix-in-angularjs'>Don't use "data" prefix in AngularJS</a></li></ol></li><li class='history-month'><label for='2017-7'>July</label><input type='checkbox'  id='2017-7' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/angularjs-service-with-var-declarations'>AngularJS service with var declarations instead of this. assignments</a></li></ol></li><li class='history-month'><label for='2017-6'>June</label><input type='checkbox'  id='2017-6' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/factory-resetting-android-without'>Factory Resetting Android Without Losing Your Life (Metaphorically)</a></li></ol></li><li class='history-month'><label for='2017-5'>May</label><input type='checkbox'  id='2017-5' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-4'>IdentityServer3 with PKCE Part 4 - Persisting User Data</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-3'>IdentityServer3 with PKCE Part 3 - Persist IdentityServer Configuration</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-2'>IdentityServer3 with PKCE Part 2 - Protected Resource Server</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-1-simple'>IdentityServer3 with PKCE Part 1 - Simple OAuth2 Server</a></li></ol></li><li class='history-month'><label for='2017-3'>March</label><input type='checkbox'  id='2017-3' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through'>TFS Continuous Integration Walk Through Part 5c - Multiple Solutions: Dependencies</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/sane-database-schema-conventions'>Sane Database Schema Conventions</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-agent'>TFS Continuous Integration - Agent Installation and Visual Studio Licensing</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-clickonce'>TFS Continuous Integration - ClickOnce Apps</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-and-private'>TFS Continuous Integration and Private NuGet Package Sources</a></li></ol></li><li class='history-month'><label for='2017-2'>February</label><input type='checkbox'  id='2017-2' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_22'>TFS Continuous Integration Walk Through Part 5b - Multiple Solutions: Simple Project References</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_20'>TFS Continuous Integration Walk Through Part 5a - Multiple Solutions: Overview</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_24'>TFS Continuous Integration Walk Through Part 4b - Problems With Traits</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_6'>TFS Continuous Integration Walk Through Part 4a - Filtering Tests</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_63'>TFS Continuous Integration Walk Through Part 3 - Notifications</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_5'>TFS Continuous Integration Walk Through Part 2 - Create an Automated Build</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through'>TFS Continuous Integration Walk Through Part 1 - Installing TFS and Checking In a Test Project</a></li></ol></li><li class='history-month'><label for='2017-1'>January</label><input type='checkbox'  id='2017-1' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/what-else-programmers-do-text'>What Else Programmers Do: A Text Manipulation Example</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/what-does-this-code-do-extended'>What does this code do? Extended explanation</a></li></ol></li></ol></li><li class='history-year'><label for='2016'>2016</label><input type='checkbox'  id='2016' /><ol><li class='history-month'><label for='2016-12'>December</label><input type='checkbox'  id='2016-12' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/nexus-5-gps-lock-problem-and-two'>Nexus 5 GPS Lock Problem and Three--or More!--Solutions</a></li></ol></li><li class='history-month'><label for='2016-11'>November</label><input type='checkbox'  id='2016-11' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/how-to-bypass-new-microsoft-office'>How to Bypass the New Microsoft Office Startup and Save Screens</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/google-tasks-vs-reminders-in-desktop'>Google Tasks vs Reminders in Desktop and Phone</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/catching-up-on-coding-claims-based-identity-part-1_6'>Catching Up on Coding - Claims-Based Identity Part 1</a></li></ol></li><li class='history-month'><label for='2016-10'>October</label><input type='checkbox'  id='2016-10' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/creating-forms-authentication'>Creating Forms Authentication Membership Tables in LocalDB–Right and Wrong Ways</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/windows-10-complaint-1-auto-update'>Windows 10 Complaint #1: Auto Update State Loss</a></li></ol></li><li class='history-month'><label for='2016-9'>September</label><input type='checkbox'  id='2016-9' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/disable-windows-10-photo-automatic'>Disable Windows 10 Photo Automatic Albums</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/a-laymans-explanation-of-mocking-and'>A Layman’s Explanation of Mocking and Dependency Injection</a></li></ol></li><li class='history-month'><label for='2016-8'>August</label><input type='checkbox'  id='2016-8' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-3'>Catching Up on Coding - TDD Part 3</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-2'>Catching Up on Coding - TDD Part 2</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-1'>Catching Up on Coding - TDD Part 1</a></li></ol></li><li class='history-month'><label for='2016-7'>July</label><input type='checkbox'  id='2016-7' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/writing-to-current-users-registry-when'>Writing to the Current User(s) Registry When Running as System</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/catching-up-on-coding-syllabus'>Catching Up on Coding - The Syllabus</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/quickly-enable-mercurial-keyring-for'>Quickly Enable Mercurial Keyring for BitBucket</a></li></ol></li><li class='history-month'><label for='2016-6'>June</label><input type='checkbox'  id='2016-6' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/create-easily-debuggable-windows-service'>Create an Easily Debuggable Windows Service</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/underrated-work-skills'>(Underrated) Work Skills</a></li></ol></li><li class='history-month'><label for='2016-5'>May</label><input type='checkbox'  id='2016-5' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/vbnet-windows-project-to-c-conversion'>VB.Net Windows Project to C# Conversion Tools Quick Review</a></li></ol></li><li class='history-month'><label for='2016-2'>February</label><input type='checkbox'  id='2016-2' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/scroll-bars-in-blogger-tags'>Scroll bars in Blogger &lt;pre&gt; Tags</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/google-keep-changes-taking-to-forums'>Google Keep Changes: Taking to the Forums</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/backward-step-for-google-keep'>Backward Step for Google Keep</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/recover-virtualbox-snapshots'>Recover VirtualBox Snapshots</a></li></ol></li><li class='history-month'><label for='2016-1'>January</label><input type='checkbox'  id='2016-1' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/auto-updating-new-windows-7-installation'>Auto Updating a New Windows 7 Installation</a></li></ol></li></ol></li><li class='history-year'><label for='2015'>2015</label><input type='checkbox'  id='2015' /><ol><li class='history-month'><label for='2015-8'>August</label><input type='checkbox'  id='2015-8' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/shoretel-brilliantly-simple'>ShoreTel - Brilliantly Simple?</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/the-google-photos-management-problems'>The Google Photos Management Problem(s)</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/creating-long-lasting-clickonce'>Creating a Long-Lasting ClickOnce Certificate</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/more-encrypted-config-filesclickonce'>More Encrypted Config Files–ClickOnce Complications</a></li></ol></li><li class='history-month'><label for='2015-7'>July</label><input type='checkbox'  id='2015-7' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/encrypting-appconfig'>Encrypting app.config</a></li></ol></li><li class='history-month'><label for='2015-3'>March</label><input type='checkbox'  id='2015-3' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/better-google-sites-designthe-notched'>Better Google Sites Design–The Notched Page</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/removing-unremovable-bluetooth-device'>Removing Unremovable Bluetooth Device: FAIL!</a></li></ol></li></ol></li><li class='history-year'><label for='2014'>2014</label><input type='checkbox'  id='2014' /><ol><li class='history-month'><label for='2014-11'>November</label><input type='checkbox'  id='2014-11' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/how-to-remove-savernet-and-similar'>How to remove Savernet (and similar) Chrome extension</a></li></ol></li><li class='history-month'><label for='2014-9'>September</label><input type='checkbox'  id='2014-9' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/prevent-word-from-restoring-minimized'>Prevent Word from Restoring Minimized Documents</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/clever-phish'>Clever Phish</a></li></ol></li><li class='history-month'><label for='2014-8'>August</label><input type='checkbox'  id='2014-8' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/enable-synaptics-touchpad-2-finger-tap'>Enable Synaptics touchpad 2-finger tap context menu</a></li></ol></li><li class='history-month'><label for='2014-5'>May</label><input type='checkbox'  id='2014-5' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/installing-fcm-flow-cytrometry-library'>Installing fcm flow cytrometry library on Windows 8.1</a></li></ol></li><li class='history-month'><label for='2014-4'>April</label><input type='checkbox'  id='2014-4' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/windows-81-update-1-driver-problem-dtmb'>Windows 8.1 Update 1 Driver Problem DTMB BDA TV USB</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/windows-81-window-key-s-search-from'>Windows 8.1: Window Key + S = Search from Desktop</a></li></ol></li><li class='history-month'><label for='2014-3'>March</label><input type='checkbox'  id='2014-3' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/whs-2011-windows-update-one-or-more'>WHS 2011 Windows Update “One or more services are no running” alert</a></li></ol></li><li class='history-month'><label for='2014-2'>February</label><input type='checkbox'  id='2014-2' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/lenovo-u530-touch-wifi-problem-continued'>Lenovo U530 Touch WiFi Problem Continued</a></li></ol></li><li class='history-month'><label for='2014-1'>January</label><input type='checkbox'  id='2014-1' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/lenovo-u530-touch-wifi-problem'>Lenovo U530 Touch WiFi Problem</a></li></ol></li></ol></li><li class='history-year'><label for='2013'>2013</label><input type='checkbox'  id='2013' /><ol><li class='history-month'><label for='2013-12'>December</label><input type='checkbox'  id='2013-12' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/whs-connector-restart-error-in-windows'>WHS Connector Restart Error in Windows 8.0/8.1</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/how-to-remove-apps-from-google-play-my'>How to Remove Apps from Google Play My Apps Site</a></li></ol></li><li class='history-month'><label for='2013-11'>November</label><input type='checkbox'  id='2013-11' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/windows-81-hidden-opt-ins-opt-outs'>Windows 8.1 Hidden Opt Ins/ Opt Outs</a></li></ol></li><li class='history-month'><label for='2013-9'>September</label><input type='checkbox'  id='2013-9' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-epilogue'>Edward Farley and the Fantastic Library Epilogue</a></li></ol></li><li class='history-month'><label for='2013-7'>July</label><input type='checkbox'  id='2013-7' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/a-week-or-more-of-jolicloud-day-2-end'>A Week (or More!) of JoliCloud - Day 2: THE END</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/a-week-or-more-of-jolicloud-day-1'>A Week (or More!) of JoliCloud - Day 1</a></li></ol></li><li class='history-month'><label for='2013-5'>May</label><input type='checkbox'  id='2013-5' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-12'>Edward Farley and the Fantastic Library Part 12</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-1019'>Edward Farley and the Fantastic Library Part 11</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-10'>Edward Farley and the Fantastic Library Part 10</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-9'>Edward Farley and the Fantastic Library Part 9</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-8'>Edward Farley and the Fantastic Library Part 8</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-7'>Edward Farley and the Fantastic Library Part 7</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-6'>Edward Farley and the Fantastic Library Part 6</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-5'>Edward Farley and the Fantastic Library Part 5</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-4'>Edward Farley and the Fantastic Library Part 4</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-3'>Edward Farley and the Fantastic Library Part 3</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-2'>Edward Farley and the Fantastic Library Part 2</a></li><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/edward-farley-part-1'>Edward Farley and the Fantastic Library Part 1</a></li></ol></li><li class='history-month'><label for='2013-4'>April</label><input type='checkbox'  id='2013-4' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/clean-up-orphaned-sql-users'>Clean Up Orphaned SQL Users</a></li></ol></li><li class='history-month'><label for='2013-3'>March</label><input type='checkbox'  id='2013-3' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/t-sql-one-to-one-cant-be-done'>T-SQL One to One Can't Be Done</a></li></ol></li><li class='history-month'><label for='2013-1'>January</label><input type='checkbox'  id='2013-1' /><ol><li class='history-post'><a class='history-post' href='http://www.softwaremeadows.com/posts/test-post-with-code'>Migrating Google Drive</a></li></ol></li></ol></li></ol>
    </div>
  </nav>
  <header>
    <div id="site-image">
      <img src="http://www.softwaremeadows.com/images/header.png" alt="" />
    </div>
    <h1 id="site-name"></h1>
    <div id="site-subtitle">A pleasant walk through computing</div>
  </header>
  <section id="content">
    <h1 id="home">Home</h1>

  </section>
  <!-- posts only appear in home index -->
  <section id="posts">
    
              <div class='post'>
                <h2 class='post-title'><a href='http://www.softwaremeadows.com/posts/a-laymans-explanation-of-mocking-and'>A Layman’s Explanation of Mocking and Dependency Injection</a></h2>
                <p class='post-info'><span class='posted-on'>2016-09-05 12:28</span></p>
                <div class='post-content'><h1 id="a-sad-tale-of-woe-again">A Sad Tale of Woe Again</h1>
<p><a href="images/image.png"><img src="http://www.softwaremeadows.com/posts/a-laymans-explanation-of-mocking-and/images/image.png" title="image" alt="image"></a></p>
<p>So your husband or wife is a software engineer, and you’re not. You like the <em>idea</em> of software, you even <em>use</em> software, but you are as interested in what goes into creating software as you are in soap manufacturing. He (or she, but programming is still a stupidly male-dominated field, so we’ll stick with the percentages) comes home, blathering on about his day. The conversation goes something like this:</p>
<p>Him: “They handed me a legacy codebase today. It’s ancient .Net 2 stuff. I’m supposed to refactor the existing code and, in parallel, rewrite it to .Net 4.5.”</p>
<p>You: (silent, but thinking, “I wonder if crocodiles attack alligators. Or can they mate with them? You only hear about crocodiles <em>or</em> alligators, not crocodiles <em>and</em> alligators. Is a ‘crocogator’ a thing?”)</p>
<p>Him: “I spent about five hours just looking at the stack. What a mess! I mean, it’s not bad, really, but before I make any changes I need a way to unit test, and it’s not architected for that. I don’t want to go down the rabbit hole since I’m rewriting the whole thing using SOLID DDD principles, but I’ve got to get some DI going, and I’m going to have to figure out how to mock some of the internals.”</p>
<p>You: (nodding, and thinking, “If I pull weeds today, then I can mow tomorrow and feel virtuous two days in a row, and treat myself to wine at lunch on Saturday.”)</p>
<p>Him: “Can I brainstorm the unit testing with you? Just, you know, talk it out? That would really help.”</p>
<p>You: (nodding slowly, thinking, “O! M! G! Just cut off my head and pour cabbage into it! Still, he’s a good man. All I have to do is listen.”</p>
<p>Him: “Stop me any time if I can explain how something works.”</p>
<p>You: “OK, honey.” (but thinking, “The weeds. I was going to pull the weeds.”)</p>
<h1></h1>
<h1 id="unbaffling-language-to-the-rescue">Unbaffling Language to the Rescue!</h1>
<p>The only thing worse than listening to a software developer talk about code is asking a sailor about an upcoming voyage. Here are some actual nautical terms and phrases: cumshaw, geedunk, abeam, baggywrinkle, beat to quarters, by and large, coxswain. The definition of “death roll”?:&nbsp; “In a keel boat, a death roll is the act of broaching to windward, putting the spinnaker pole into the water and causing a crash-gybe of the boom and mainsail, which sweep across the deck and plunge down into the water.” [<a href="https://en.wikipedia.org/wiki/Glossary_of_nautical_terms">Wikipedia</a>]</p>
<p>Water. I drink water. I understand water.</p>
<p>Programmers don’t need to live lives of unending, habitual obfuscation. We can explain, if we but remember the lessons of literature.</p>
<h1 id="the-totally-contrived-ridiculous-metaphor">The Totally Contrived, Ridiculous Metaphor</h1>
<p>Imagine you’re a high school teacher. Now, imagine that you have a four-inch wood splinter going through your left eyelid. Which is easier on your mental state? If you say “splinter,” you must be a teacher.</p>
<p>Now, imagine a magical school where you don’t have to grade your own papers. You finish your eight-hour work day, go home, take an hour planning the next day’s lessons, have dinner, and study an hour or two for your required continuing education course, but you <em>don’t</em> have to grade at least twenty-five of the 120 five-page essays from mid-term exams.</p>
<p>Instead, you get to hand the exams to your Grading And Reports Department. It works like this:</p>
<ol>
<li>Give Mr Michael Murphy your stack of 120 essays.</li>
<li>A few days later, pick up the graded essays and a formatted report of the students’ grades, broken down by class period, by student, and summarized with comparative aggregates. It’s a great report.</li>
</ol>
<p>Recently, you were tasked with testing the GARD system. You’re a great choice, because you helped create the department. Here’s what you know:</p>
<ol>
<li>Mr Murphy takes the papers and gives them to Dr Marcia Malone. Dr Malone grades every paper. She gives the results back to Mr Murphy.</li>
<li>Mr Murphy aggregates the grades and creates the formatted report.</li>
<li>You helped train Dr Malone, who is brilliant. She can grade anything. But teachers have no control over how she grades.</li>
<li>The grading scale Dr Malone uses could change at any time. Today, 90-100% could be an “A.” Tomorrow, 93-100% could be an “A.” (Remember, this is a <em>contrived</em> <em>example</em>.)</li>
</ol>
<p>Here’s a lousy illustration.</p>
<p>You give the papers to Mr Murphy</p>
<p><a href="images/image-001.png"><img src="http://www.softwaremeadows.com/posts/a-laymans-explanation-of-mocking-and/images/image-001.png" title="image" alt="image"></a></p>
<p>Mr Murphy gives the papers to Dr Malone, who does mysterious, magical mischief.</p>
<p><a href="images/image-002.png"><img src="http://www.softwaremeadows.com/posts/a-laymans-explanation-of-mocking-and/images/image-002.png" title="image" alt="image"></a></p>
<p>Mr Murphy gives you back the papers.</p>
<p><a href="images/image-003.png"><img src="http://www.softwaremeadows.com/posts/a-laymans-explanation-of-mocking-and/images/image-003.png" title="image" alt="image"></a></p>
<p>You have only been asked to test the report formatting. This is critical! You are <em><strong>not</strong></em> verifying the grades are correct. You only care about the report. You devise this test</p>
<blockquote>
<p>Given a stack of 120 papers, if the grades are abc, then report should look like xyz.</p>
</blockquote>
<p>So here’s your challenge. You are going to give Mr Murphy 120 papers. He’s going to create the report. You’re going to compare what he gives you with how you know the report should look, right down to the numbers and letter grades on it. If they match, the test passes. If not, the test fails.</p>
<p>“Crap!” you think, “I can’t depend on Dr Malone to always give Mr Murphy the same grades! Besides, it takes her three days on average to grade that many papers, and I want my tests to be done in a day. It only takes Mr Murphy a few hours to prepare a report.”</p>
<p>You develop a plan. You are a genius.</p>
<ol>
<li>You build an automaton that looks like Dr Malone. But, it doesn’t actually grade anything. It just gives back a consistent set of scores that you tell it.</li>
<li>When you give Mr Murphy the papers, you’ll <em>also</em> give him the automaton.</li>
<li>Instead of Mr Murphy handing the papers to Dr Malone, he’ll hand them to the automaton and immediately get back your scores from it.</li>
<li>Mr Murphy formats the report and gives it to you.</li>
</ol>
<p>More laughable illustrations, but let’s include the programming terms.</p>
<p>We have a dependency on our grader, Dr Malone. We’ll change the GARD room so that we can give it a real <em>or fake</em> grader. This is called Dependency Injection.</p>
<p><a href="images/image12.png"><img src="http://www.softwaremeadows.com/posts/a-laymans-explanation-of-mocking-and/images/image12.png" title="image" alt="image"></a></p>
<p>Mr Murphy doesn’t care which grader he gets answers from. For our test, he uses the fake one. That is, he uses a Mock (also called a fake, or stub, or substitute).</p>
<p><a href="images/image-004.png"><img src="http://www.softwaremeadows.com/posts/a-laymans-explanation-of-mocking-and/images/image-004.png" title="image" alt="image"></a></p>
<p>We get back the report made from data we injected. We just want to compare the reports, the work Mr Murphy does.</p>
<p><a href="images/image-005.png"><img src="http://www.softwaremeadows.com/posts/a-laymans-explanation-of-mocking-and/images/image-005.png" title="image" alt="image"></a></p>
<p>If they match, the test passes. If not, fail!</p>
<p><a href="images/image-006.png"><img src="http://www.softwaremeadows.com/posts/a-laymans-explanation-of-mocking-and/images/image-006.png" title="image" alt="image"></a></p>
<h1 id="how-a-programmer-sees-this">How a programmer sees this</h1>
<p>A programmer sees it the same way. Except it’s all words that look like English, but are alien-ese.</p>
<p><strong>The Interface</strong></p>
<p><a href="images/image-007.png"><img src="http://www.softwaremeadows.com/posts/a-laymans-explanation-of-mocking-and/images/image-007.png" title="image" alt="image"></a></p>
<p><strong>The Production Code</strong></p>
<p><a href="images/image-008.png"><img src="http://www.softwaremeadows.com/posts/a-laymans-explanation-of-mocking-and/images/image-008.png" title="image" alt="image"></a></p>
<p><strong>Using the Production Code</strong></p>
<p><a href="images/image-009.png"><img src="http://www.softwaremeadows.com/posts/a-laymans-explanation-of-mocking-and/images/image-009.png" title="image" alt="image"></a></p>
<p><strong>The Test Code</strong></p>
<p><a href="images/image-010.png"><img src="http://www.softwaremeadows.com/posts/a-laymans-explanation-of-mocking-and/images/image-010.png" title="image" alt="image"></a></p>
<h1 id="wrap-up">Wrap Up</h1>
<p>Dependency Injection and Mocking solve two problems that affect how well software can be tested.</p>
<ol>
<li>Dependency Injection lets us control what external dependencies, like a grading engine, a method uses. If we couldn’t do this, we’d have to always use production data, when that’s not what we’re always testing.</li>
<li>Once we can inject a dependency, we can Mock its behavior. That is, we can make it do whatever we want, giving the method under test consistent results. Again, we’re not testing the dependent service. We’re testing the method that is using it.</li>
</ol>
<p>It takes some work, but once you get your head wrapped around these concepts and their implementation, their importance becomes clear.</p>
</div>
              </div>
              

              <div class='post'>
                <h2 class='post-title'><a href='http://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-3'>Catching Up on Coding - TDD Part 3</a></h2>
                <p class='post-info'><span class='posted-on'>2016-08-31 11:07</span></p>
                <div class='post-content'><p><img src="http://www.tvparty.com/bgifs17/aliasdvd.jpg">I’ve been a software developer for twenty years, but am behind in some skills. This series chronicles my self-improvement.</p>
<p>It turns out that unit testing exercises a lot of coding methods for more maintainable code. Some methods involve deception, so who better to inspire us than our “Butch Cassidy/Sundance Kid” knockoffs from 70s show <a href="https://en.wikipedia.org/wiki/Alias_Smith_and_Jones">Alias Smith and Jones</a>? The difference is, I’m not trying to “<a href="https://www.youtube.com/watch?v=4nmxLeNd0ck">get out of this business</a>.”</p>
<p>Previously on CUOC: <a href="http://www.softwaremeadows.com/2016/08/catching-up-on-coding-tdd-part-2.html">TDD Part 2</a> Next Episode: <a href="http://www.softwaremeadows.com/2016/11/catching-up-on-coding-claims-based-identity-part-1_6.html">Claims-Based Identity Part 1</a></p>
<h1 id="teaser">Teaser</h1>
<p>Unit testing benefits from mocking and Inversion of Control. I’d argue that it’s hard to effectively unit test <em>without</em> these techniques. Parts <a href="http://www.softwaremeadows.com/2016/08/catching-up-on-coding-tdd-part-1.html">one</a> and <a href="http://www.softwaremeadows.com/2016/08/catching-up-on-coding-tdd-part-2.html">two</a> of this TDD series used hand-crafted mocking and IoC. Today, we’ll redo some tests using 3rd party tools/frameworks.</p>
<h1 id="act-1--choosing-the-tools">Act 1 – Choosing the Tools</h1>
<p>I researched what developers are recommending for mocking and IoC. Of course, opinions abound, but in the end I came to a few conclusions.</p>
<p><strong>Mocking</strong></p>
<ul>
<li>No one recommends <a href="https://www.hibernatingrhinos.com/oss/rhino-mocks">Rhino Mocks</a> anymore. It appears to be a mostly dead project.</li>
<li><a href="https://github.com/Moq/moq4/wiki/Quickstart">Moq</a> is still used, but is falling out of favor.</li>
<li>Developers like <a href="http://nsubstitute.github.io/">NSubstitute</a> and <a href="https://code.google.com/archive/p/fakeiteasy/">FakeItEasy</a>.</li>
<li>NSubstitute has a more concise API. FakeItEasy is more natural language and less ambiguous.</li>
<li>My reaction to seeing them side-by-side is that I like FIE’s syntax more. I like tests that are immediately easy to understand.</li>
<li>But I’m a little put off by the verbosity, so I’ll try NSubstitute first.</li>
</ul>
<p><em>References</em></p>
<p><a href="https://helloacm.com/c-test-mocking-frameworks/">C# Test Mocking Frameworks</a></p>
<p><a href="http://blog.travisgosselin.com/nsubstitute-a-refreshingly-simple-mocking-framework-for-unit-tests/">NSubstitute: A Refreshingly Simple Mocking Framework for Unit Tests</a></p>
<p><a href="http://weareadaptive.com/2014/09/30/why-nsubstitute/">Mocking: why we picked NSubstitute</a></p>
<p><a href="http://sweetsciencecoding.com/easy-mocking-with-fakeiteasy/">Easy Mocking with FakeItEasy</a></p>
<p><strong>IoC</strong></p>
<ul>
<li>Ninject is the most popular, and has the worst performance (though some developers argue that IoC container performance doesn’t matter).</li>
<li>Unity is supported (for now) by Microsoft, but people have complained about some limitations.</li>
<li>StructureMap, Autofac, and Simple Injector remain as the choices. Based on a few reviews—but mostly gut instinct—I’m going to use Simple Injector. (Autofac would be my second choice.)</li>
</ul>
<p><em>References</em></p>
<p><a href="http://www.palmmedia.de/Blog/2011/8/30/ioc-container-benchmark-performance-comparison">IoC Container Benchmark – Performance comparison</a></p>
<p><a href="http://www.denisoliva.com/2015/09/16/inversion-of-control-ioc-containers-basic-comparison-between-some-ioc-containers/">Inversion of Control Containers Basic Comparison</a></p>
<p><a href="https://cardinalcore.co.uk/2015/01/28/ioc-battle-in-2015-results-using-ninject-think-again/">IoC Battle in 2015 results: Using Ninject – think again!</a></p>
<p><a href="https://lostechies.com/jimmybogard/2015/01/13/generic-variance-in-di-containers/">Generic variance in DI containers</a></p>
<p><a href="https://simpleinjector.codeplex.com/wikipage?title=Migration%20Guide">Simple Injector Migration Guide</a> &lt;-I love that they include how to migrate <em>away</em> from their product. Also serves as a coding comparison.</p>
<h1 id="act-2--making-a-mockery-of-testing">Act 2 – Making a Mockery of Testing</h1>
<h2 id="install-nsubstitute">Install NSubstitute</h2>
<ol>
<li>Install the package into the unit test project using NuGet.</li>
<li>After installation, a nice readme.txt file opens. Read it.</li>
</ol>
<h2 id="replace-a-previous-test">Replace a Previous Test</h2>
<p>In my <a href="http://www.softwaremeadows.com/2016/08/catching-up-on-coding-tdd-part-2.html">previous tests</a>, I created my own mock Registry wrappers from IRegistryWrapper and IRegistryMockWrapper. These are interfaces I created to allow Inversion of Control of the Registry. IRegistryWrapper looks like this</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">public</span> <span class="kw">interface</span> IRegistryWrapper</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="dt">object</span> <span class="fu">GetValue</span>(<span class="dt">string</span> keyName, <span class="dt">string</span> valueName, <span class="dt">object</span> defaultValue);</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="dt">void</span> <span class="fu">SetValue</span>(<span class="dt">string</span> keyName, <span class="dt">string</span> valueName, <span class="dt">object</span> value, RegistryValueKind valueKind);</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">}</a></code></pre></div>
<p>the hand-crafted mock looks like this</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">class</span> RegistryMock : IRegistryWrapper</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">public</span> <span class="dt">object</span> <span class="fu">GetValue</span>(<span class="dt">string</span> keyName, <span class="dt">string</span> valueName, <span class="dt">object</span> defaultValue)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">{</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="co">//this may become cumbersome, but for now specify some return values</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="kw">switch</span> (keyName)</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">{</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="kw">case</span> @<span class="st">"HKEY_LOCAL_MACHINE\SOFTWARE\EduAgent"</span>:</a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="kw">if</span> (valueName == <span class="st">"Version"</span>) <span class="kw">return</span> defaultValue;</a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="kw">break</span>;</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">}</a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="kw">throw</span> <span class="kw">new</span> <span class="fu">Exception</span>(<span class="st">"Invalid keyName"</span>);</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb2-14" data-line-number="14"></a>
<a class="sourceLine" id="cb2-15" data-line-number="15"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">SetValue</span>(<span class="dt">string</span> keyName, <span class="dt">string</span> valueName, <span class="dt">object</span> value, RegistryValueKind valueKind)</a>
<a class="sourceLine" id="cb2-16" data-line-number="16">{</a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="kw">throw</span> <span class="kw">new</span> <span class="fu">NotImplementedException</span>();</a>
<a class="sourceLine" id="cb2-18" data-line-number="18">}</a>
<a class="sourceLine" id="cb2-19" data-line-number="19">}</a></code></pre></div>
<p>here’s the unit test</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> RegistryService_GetRegistryKeyValue_Should</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">IRegistryWrapper _registry = <span class="kw">new</span> <span class="fu">RegistryMock</span>();</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">IRegistryKeyWrapper _registryKey = <span class="kw">new</span> <span class="fu">RegistryKeyMock</span>();</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">[Fact]</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ReturnNullConstantTextIfValueIsMissing</span>()</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">{</a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="dt">var</span> service = <span class="kw">new</span> <span class="fu">RegistryService</span>(_registry, _registryKey);</a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="dt">var</span> result = service.<span class="fu">GetRegistryKeyValue</span>(@<span class="st">"HKEY_LOCAL_MACHINE\SOFTWARE\EduAgent"</span>, <span class="st">"Version"</span>);</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">Assert.<span class="fu">Equal</span>(result, service.<span class="fu">NoValue</span>);</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb3-13" data-line-number="13">}</a></code></pre></div>
<p>and finally, here's the RegistryService method that passes the test</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">public</span> <span class="dt">string</span> <span class="fu">GetRegistryKeyValue</span>(<span class="dt">string</span> keyName, <span class="dt">string</span> valueName)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="kw">try</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">{</a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co">//value will be null if no value found, and the default value if the key is missing. But we only care that there's no value.</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co">//Null can't be returned to the client. Don't return empty, since that's ambigious (did the key exist?).</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="co">//Return a magic string.</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="dt">object</span> value = _registry.<span class="fu">GetValue</span>(keyName, valueName, <span class="kw">null</span>); <span class="co">//guarantees null if no value or missing key.</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="kw">return</span> value != <span class="kw">null</span> ? value.<span class="fu">ToString</span>() : NoValue;</a>
<a class="sourceLine" id="cb4-10" data-line-number="10"></a>
<a class="sourceLine" id="cb4-11" data-line-number="11">}</a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="kw">catch</span> (Exception ex)</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">{</a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="kw">return</span> <span class="st">"Error attempting keyName '"</span> + keyName + <span class="st">"' and valueName '"</span> + valueName + <span class="st">"'</span><span class="sc">\r\n</span><span class="st">"</span> + ex.<span class="fu">GetBaseException</span>().<span class="fu">Message</span>;</a>
<a class="sourceLine" id="cb4-15" data-line-number="15">}</a>
<a class="sourceLine" id="cb4-16" data-line-number="16">}</a></code></pre></div>
<p>All I’m going to do is refactor the test so that I use NSubstitute instead of my own mocks. I’ll need a mock for IRegistryKeyWrapper because the class expects it, but I won’t set any behavior on it.</p>
<blockquote>
<p>Note: remember to add “using NSubstitute;”</p>
</blockquote>
<p>In my hand-crafted mock, I specified return values based on the arguments to GetValue, and otherwise threw an exception. For my unit test, I need to do something similar. Here’s my first attempt, and it does indeed pass.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb5-1" data-line-number="1"></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="dt">var</span> registry = Substitute.<span class="fu">For</span>&lt;IRegistryWrapper&gt;();</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="dt">var</span> registryKey = Substitute.<span class="fu">For</span>&lt;IRegistryKeyWrapper&gt;();</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="co">//Registry.GetValue will return null if the valueName doesn't exist.</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">registry.<span class="fu">GetValue</span>(@<span class="st">"HKEY_LOCAL_MACHINE\SOFTWARE\EduAgent"</span>, <span class="st">"Version"</span>, <span class="kw">null</span>).<span class="fu">Returns</span>(<span class="kw">null</span>);</a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="dt">var</span> service = <span class="kw">new</span> <span class="fu">RegistryService</span>(registry, registryKey);</a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="dt">var</span> result = service.<span class="fu">GetRegistryKeyValue</span>(@<span class="st">"HKEY_LOCAL_MACHINE\SOFTWARE\EduAgent"</span>, <span class="st">"Version"</span>);</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">Assert.<span class="fu">Equal</span>(result, service.<span class="fu">NoValue</span>);</a></code></pre></div>
<p>The problem is (or <em>seems to be</em>), if I change the substitute's argument "Version" to "Blamo", the test still passes. This is happening because given an unknown argument the method will still return null. I need to tell the substitute that it should only return null if it gets the right arguments.</p>
<p><em>Or do I?</em></p>
<p>No, I don’t. I’m attempting to give my mock too much behavior. I <em>only</em> want the mocked Registry to pretend that the value was missing and return null. Elsewhere I’ll test the behavior if the value exists. My hand-crafted mock was eventually going to give me trouble because it was doing too much <em>and</em> it wasn’t really behaving like the Registry class.</p>
<h2 id="the-heart-of-mocking">The Heart of Mocking</h2>
<p>The method I’m testing happens to be&nbsp; a good one for getting at the essence of mocking. RegistryService.GetValue is <em>almost</em> a pass-through to Registry.GetValue. But, it has its own behavior and is supposed to call Registry.GetValue.</p>
<p>As the developer and tester, I know three things:</p>
<ol>
<li>How external dependencies behave (Microsoft.Win32.Registry).</li>
<li>How my test behaves.</li>
<li>What’s in my method.</li>
</ol>
<p>That last one is the problem. I <em>know</em> my method calls Registry.GetValue(), because I wrote it. But that’s a serious mental mistake when it comes to the test. I need to write my tests, whether before or after, as if I knew nothing about the method’s code. I should pretend the <em>only</em> things I know about the method are:</p>
<ol>
<li>The parameters it’s called with.</li>
<li>The dependencies it has.</li>
<li>The result when it’s called with particular values.</li>
</ol>
<p>In short, my method is a black box. It could be empty, for all I know. That’s why TDD starts with an empty method, so that it fails first. If it succeeds when empty, that’s a problem. When my method has a dependency, I need to only mock up what that dependency will do if it’s called with the expected value.</p>
<p><em>But, I mustn’t assume the mocked dependency has been called at all</em>.</p>
<p>So, here’s how my test should look.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co">//Arrange</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="dt">var</span> registry = Substitute.<span class="fu">For</span>&lt;IRegistryWrapper&gt;();</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="dt">var</span> registryKey = Substitute.<span class="fu">For</span>&lt;IRegistryKeyWrapper&gt;();</a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co">//Registry.GetValue will return null if the valueName doesn't exist.</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">registry.<span class="fu">GetValue</span>(@<span class="st">"HKEY_LOCAL_MACHINE\SOFTWARE\EduAgent"</span>, <span class="st">"Version"</span>, <span class="kw">null</span>).<span class="fu">Returns</span>(<span class="kw">null</span>);</a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="dt">var</span> service = <span class="kw">new</span> <span class="fu">RegistryService</span>(registry, registryKey);</a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="co">//Act</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="dt">var</span> result = service.<span class="fu">GetRegistryKeyValue</span>(@<span class="st">"HKEY_LOCAL_MACHINE\SOFTWARE\EduAgent"</span>, <span class="st">"Version"</span>);</a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="co">//Assert</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"><span class="co">//First, make sure the mocked Registry was called at least once. Otherwise, we might have a false positive.</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11">registry.<span class="fu">Received</span>().<span class="fu">GetValue</span>(@<span class="st">"HKEY_LOCAL_MACHINE\SOFTWARE\EduAgent"</span>, <span class="st">"Version"</span>, <span class="kw">null</span>);</a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="co">//Now make sure we got back the expected value from our method.</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13">Assert.<span class="fu">Equal</span>(result, service.<span class="fu">NoValue</span>);</a></code></pre></div>
<p>To sum up, some key lessons of unit testing are:</p>
<ol>
<li>Treat the method under test as a black box.</li>
<li>Test behaviors of the method, not its dependencies.</li>
<li>Verify mocked dependencies are called.</li>
</ol>
<p>A mocking framework gives more value than just controlling return values. It lets you know that your dependencies are being used the way you expect.</p>
<h1 id="act-3--ouch-injecting-dependencies">Act 3 – Ouch! Injecting Dependencies</h1>
<ol>
<li>Interfaces are used in production code to make it easier to inject dependencies.</li>
<li>Mocking frameworks are used in unit testing code to control injected dependencies.</li>
<li>IoC containers are used in production code to manage injected dependencies.</li>
</ol>
<p>For the first two, see <em>Act 2</em>, above.</p>
<p>I don’t <em>have</em>&nbsp; to use an IoC container. I can write code like this:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co">//pass the live registry wrappers</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">RegistryService service = <span class="kw">new</span> <span class="fu">RegistryService</span>(<span class="kw">new</span> <span class="fu">RegistryWrapper</span>(), <span class="kw">new</span> <span class="fu">RegistryKeyWrapper</span>());</a></code></pre></div>
<p>I could also let my class have default dependencies. This might be OK, as long as the caller knows what to expect. It would be considered "convention over configuration."</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> RegistryService</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="kw">private</span> IRegistryWrapper _registry;</a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="kw">private</span> IRegistryKeyWrapper _registryKey;</a>
<a class="sourceLine" id="cb8-5" data-line-number="5"></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="kw">public</span> <span class="fu">RegistryService</span>()</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">{</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">_registry = <span class="kw">new</span> <span class="fu">RegistryWrapper</span>();</a>
<a class="sourceLine" id="cb8-9" data-line-number="9">_registryKey = <span class="kw">new</span> <span class="fu">RegistryKeyWrapper</span>();</a>
<a class="sourceLine" id="cb8-10" data-line-number="10">}</a>
<a class="sourceLine" id="cb8-11" data-line-number="11"><span class="kw">public</span> <span class="fu">RegistryService</span>(IRegistryWrapper registry, IRegistryKeyWrapper key)</a>
<a class="sourceLine" id="cb8-12" data-line-number="12">{</a>
<a class="sourceLine" id="cb8-13" data-line-number="13">_registry = registry;</a>
<a class="sourceLine" id="cb8-14" data-line-number="14">_registryKey = key;</a>
<a class="sourceLine" id="cb8-15" data-line-number="15">}</a>
<a class="sourceLine" id="cb8-16" data-line-number="16">...</a>
<a class="sourceLine" id="cb8-17" data-line-number="17">}</a>
<a class="sourceLine" id="cb8-18" data-line-number="18"></a>
<a class="sourceLine" id="cb8-19" data-line-number="19"><span class="co">//usage, by default uses the Windows Registry.</span></a>
<a class="sourceLine" id="cb8-20" data-line-number="20"><span class="dt">var</span> service = <span class="kw">new</span> <span class="fu">RegistryService</span>();</a></code></pre></div>
<p>For simple cases, using an IoC is overkill. In fact, I would say:</p>
<blockquote>
<p>Don’t use an IoC container unless you have to.</p>
</blockquote>
<p>When do you “have to”?</p>
<ul>
<li>Where there are lots of dependencies.</li>
<li>When you have lots of nested dependencies.</li>
<li>When you want your dependency initialization to be in one place.</li>
</ul>
<p>There are probably other reasons, but those will do for now.</p>
<h2 id="install-simple-injector">Install Simple Injector</h2>
<ol>
<li>Get it from NuGet, install to the project that’s injecting the dependencies.</li>
</ol>
<h2 id="injection">Injection!</h2>
<p>First, I prepare my RegistryService class for dependency injection.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> RegistryService</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="kw">private</span> IRegistryWrapper _registry;</a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="kw">private</span> IRegistryKeyWrapper _registryKey;</a>
<a class="sourceLine" id="cb9-5" data-line-number="5"></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="kw">public</span> <span class="fu">RegistryService</span>(IRegistryWrapper registry, IRegistryKeyWrapper key)</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">{</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">_registry = registry;</a>
<a class="sourceLine" id="cb9-9" data-line-number="9">_registryKey = key;</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">}</a></code></pre></div>
<p>My Windows service, EduAgent, is calling the RegistryService, which is in a separate DLL. I want all my dependencies initialized once, in one place. The service’s Main method is the starting point. But, you know what, to make it easier for another developer, I’ll create a class called DependencyInjection, which we’ll call from Main. That makes it pretty clear where the dependencies are maintained, and how.</p>
<p>All we’re doing here is saying “if I request from ‘container’ a type of IRegistryWrapper, give me an instance of the class RegistryWrapper.”</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">public</span> <span class="kw">static</span> <span class="kw">class</span> DependencyInjection</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="kw">public</span> <span class="kw">static</span> Container container;</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="kw">public</span> <span class="kw">static</span> <span class="dt">void</span> <span class="fu">InitializeDependencies</span>()</a>
<a class="sourceLine" id="cb10-5" data-line-number="5">{</a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="co">//create container</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">container = <span class="kw">new</span> <span class="fu">Container</span>();</a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="co">//register interfaces</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9">container.<span class="fu">Register</span>&lt;IRegistryWrapper, RegistryWrapper&gt;();</a>
<a class="sourceLine" id="cb10-10" data-line-number="10">container.<span class="fu">Register</span>&lt;IRegistryKeyWrapper, RegistryKeyWrapper&gt;();</a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="co">//register concrete types</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12">container.<span class="fu">Register</span>&lt;RegistryService&gt;();</a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="co">//optionally verify</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14">container.<span class="fu">Verify</span>();</a>
<a class="sourceLine" id="cb10-15" data-line-number="15">}</a>
<a class="sourceLine" id="cb10-16" data-line-number="16">}</a></code></pre></div>
<p>I initialize the dependencies.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">static</span> <span class="kw">class</span> Program</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="co">///</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="co">/// The main entry point for the application.</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="co">///</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="kw">static</span> <span class="dt">void</span> <span class="fu">Main</span>()</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">{</a>
<a class="sourceLine" id="cb11-8" data-line-number="8">DependencyInjection.<span class="fu">InitializeDependencies</span>();</a>
<a class="sourceLine" id="cb11-9" data-line-number="9">ServiceBase[] ServicesToRun;</a>
<a class="sourceLine" id="cb11-10" data-line-number="10">...</a></code></pre></div>
<p>Notice that during initialization, I’m also registering the concrete type RegistryService. I’m doing this so that I can request an instance of RegistryService <em>without</em> passing any constructor arguments. The container knows what to pass in on my behalf.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co">//pass the live registry wrappers, which are auto-wired by Simple Injector</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2">RegistryService service = DependencyInjection.<span class="fu">container</span>.<span class="fu">GetInstance</span>&lt;RegistryService&gt;();</a></code></pre></div>
<p>This is the same as if I had done this:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb13-1" data-line-number="1">RegistryService service = <span class="kw">new</span> <span class="fu">RegistryService</span>(<span class="kw">new</span> <span class="fu">RegistryWrapper</span>(), <span class="kw">new</span> <span class="fu">RegistryKeyWrapper</span>());</a></code></pre></div>
<p>But by using an IoC container, if I use a different (again, fictitious) registry provider, I only need to set it in one place: InitializeDependencies.</p>
<h1 id="tag">Tag</h1>
<p>There’s a lot more to mocking and dependency injection than the above samples show. I ran into a pretty significant problem because my original IRegistryKeyWrapper included IDisposable, which plays hell with dependency injection.</p>
<blockquote>
<p>Lesson: Sometimes these tools add complications. But other times, they reveal problems in your code.</p>
</blockquote>
<p>On the subject of complications, one of the stars of <em>Alias Smith and Jones</em> killed himself during the first season. He suffered from depression and alcoholism. To this day, that makes me sad. <a href="http://www.imdb.com/name/nm0240233/?ref_=fn_al_nm_1">Pete Duel</a>, I miss what you could have done.</p>
<p><a href="images/image.png"><img src="http://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-3/images/image.png" title="image" alt="image"></a></p>
</div>
              </div>
              

              <div class='post'>
                <h2 class='post-title'><a href='http://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-2'>Catching Up on Coding - TDD Part 2</a></h2>
                <p class='post-info'><span class='posted-on'>2016-08-24 17:13</span></p>
                <div class='post-content'><p><img src="https://johnkennethmuir.files.wordpress.com/2012/01/journey1.jpg"></p>
<p>I’ve been a software developer for twenty years, but am behind in some skills. This series chronicles my self-improvement.</p>
<p>Taking a cue from the 70s and its badass fonts, my <a href="https://en.wikipedia.org/wiki/The_Fantastic_Journey">Fantastic Journey</a> is traveling from skill to skill, trying to escape every software engineer’s Bermuda Triangle: obsolescence. I don’t have Jared Martin’s Sonic Energizer to focus my thoughts and manipulate matter. All I can do is listen to the <a href="https://www.youtube.com/watch?v=fqKEENAGSBo">groovy theme music</a>.</p>
<p>Previously on CUOC: <a href="http://www.softwaremeadows.com/2016/08/catching-up-on-coding-tdd-part-1.html">TDD Part 1</a> Next Episode: <a href="http://www.softwaremeadows.com/2016/08/catching-up-on-coding-tdd-part-3.html">TDD Part 3</a></p>
<h1 id="teaser">Teaser</h1>
<p>It’s one thing to practice TDD from the start. It’s another to take legacy code <em>that you wrote</em> and create unit tests for it. My EduAgent project includes a client service that processes requests to update the registry.</p>
<p>Looking at my code, I right away see my first stumbling block: the purpose of the code is changing the registry. For testing, this means:</p>
<ul>
<li>Affecting the registry of whatever computer the tests run on.</li>
<li>Guaranteeing each test starts with a clean environment. What does this mean for parallel testing?</li>
<li>Guaranteeing the registry returns to its original state, regardless of test results.</li>
<li>Not breaking the computer.</li>
</ul>
<p>These are characteristics of integration/functional tests, not unit tests. Should I mock the registry classes to deal with this code?</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="dt">object</span> value = Registry.<span class="fu">GetValue</span>(keyName, valueName, <span class="kw">null</span>);</a></code></pre></div>
<p>If I do—if I <em>can</em>—am I really testing anything? Or am I creating fake conditions that assure the test will pass? There’s a danger, in unit testing, of creating tests that don’t actually test the method: they “test” a mock that will always return the expected value.</p>
<h1 id="act-1--what-i-can-test-what-i-should">Act 1 – What I Can Test, What I Should</h1>
<p>The purpose of mocks is to allow the unit test to focus on what it can test, and ignore what can corrupt the test—assuming what can corrupts the test isn’t exactly what should be tested!</p>
<p>A classic, challenging example is methods that access a database. I don’t want to test if I can access the database. I want to test what I’m doing with the data. For example, consider this class method.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> EmployeeInfoService</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">IEmployeeDbContext _db;</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="kw">public</span> <span class="fu">EmployeeInfoService</span>(IEmployeeDbContext db) { _db = db; }</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="kw">public</span> List <span class="fu">GetAverageHourlyPay</span>(<span class="dt">int</span>[] employeeIds)</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">{</a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="kw">return</span> from stats <span class="kw">in</span> _db.<span class="fu">PayStubs</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="co">//...a bunch of code that gets data and calculates the hourly pay by doing this:</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="co">// stats.Hours / stats.Amount</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">;</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">}</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">}</a></code></pre></div>
<p>I don’t care, <em>in the test I’m about to write,</em> if I can access the database, or if the database is returning the right data, or breaks when I hand it a list of EmployeeIds. All I care about is whether the method properly does the math given specific numbers. So, I’d mock the EmployeeDbContext and fabricate the numbers.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb3-1" data-line-number="1">[Fact]</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">EmployeeInfoService_GetAverageHourlyPay_Should_Correctly_Calculate</span>()</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">{</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="dt">var</span> db = <span class="kw">new</span> <span class="fu">MockEmployeeDbContext</span>();</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co">//...add a bunch of test data to the mock, then pass it to service</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="dt">var</span> service = <span class="kw">new</span> <span class="fu">EmployeeInfoService</span>(db);</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="dt">var</span> list = service.<span class="fu">GetAverageHourlyPay</span>(<span class="kw">new</span> <span class="dt">int</span>[] { <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> });</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">Assert.<span class="fu">Equals</span>(<span class="fl">23.34</span>, list[<span class="dv">0</span>].<span class="fu">AverageHourlyPay</span>);</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">Assert.<span class="fu">Equals</span>(<span class="fl">17.98</span>, list[<span class="dv">1</span>].<span class="fu">AverageHourlyPay</span>);</a>
<a class="sourceLine" id="cb3-10" data-line-number="10">}</a></code></pre></div>
<p>Contrast that to this method.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">public</span> <span class="dt">string</span>[] <span class="fu">GetEmployeeNames</span>()</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kw">return</span> _db.<span class="fu">Employees</span>.<span class="fu">Select</span>(a =&gt; a.<span class="fu">Name</span>).<span class="fu">ToArray</span>();</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">}</a></code></pre></div>
<p>Is there any reason to create a unit test for this method? I don’t think so. The test would look something like this.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb5-1" data-line-number="1">[Fact]</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">EmployeeInfoService_GetEmployeeNames_Should_Return_A_List_Of_Names</span>()</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">{</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="dt">var</span> db = <span class="kw">new</span> <span class="fu">MockEmployeeDbContext</span>();</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="co">//...add a bunch of mock Employees with names, then pass to service</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="dt">var</span> service = <span class="kw">new</span> <span class="fu">EmployeeInfoService</span>(db);</a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="dt">var</span> list = service.<span class="fu">GetEmployeeNames</span>();</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">Assert.<span class="fu">True</span>(list.<span class="fu">Contains</span>(<span class="st">"Varian"</span>));</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">}</a></code></pre></div>
<p>This gets us nothing. All we did was test that our mocking framework works. So…</p>
<blockquote>
<p>Lesson 1: Be sure you’re testing something that can fail.</p>
</blockquote>
<h1 id="act-2--the-simple-test">Act 2 – The Simple Test</h1>
<p>For my RegistryService class, I have a different problem as stated above. Can I even mock the .Net Registry class? We’ll look at that shortly. For right now, I’ll evaluate all the methods and see which ones I can test without mocking. Here’s the complete list:</p>
<ul>
<li>ProcessRequest</li>
<li>GetRegistryKeyValue</li>
<li>GetRegistryValueKind</li>
<li>SetRegistryKeyValue</li>
<li>DeleteRegistryKey</li>
<li>DeleteRegistryValue</li>
<li>OpenSubKey64</li>
<li>ParseRegistryHive</li>
<li>NotifyAppsOfRegistryChange</li>
</ul>
<p>Of all these, just one doesn’t require using registry data: ParseRegistryHive. The method’s purpose is to return the hive enum given a string.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">public</span> <span class="kw">static</span> RegistryHive <span class="fu">ParseRegistryHive</span>(<span class="dt">string</span> hiveName)</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="kw">if</span> (hiveName.<span class="fu">ToUpper</span>() == <span class="st">"HKEY_CLASSES_ROOT"</span>) { <span class="kw">return</span> RegistryHive.<span class="fu">ClassesRoot</span>; }</a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="kw">else</span> <span class="kw">if</span> (hiveName.<span class="fu">ToUpper</span>() == <span class="st">"HKEY_CURRENT_USER"</span>) { <span class="kw">return</span> RegistryHive.<span class="fu">CurrentUser</span>; }</a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="kw">else</span> <span class="kw">if</span> (hiveName.<span class="fu">ToUpper</span>() == <span class="st">"HKEY_LOCAL_MACHINE"</span>) { <span class="kw">return</span> RegistryHive.<span class="fu">LocalMachine</span>; }</a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="kw">else</span> <span class="kw">if</span> (hiveName.<span class="fu">ToUpper</span>() == <span class="st">"HKEY_USERS"</span>) { <span class="kw">return</span> RegistryHive.<span class="fu">Users</span>; }</a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="kw">else</span> <span class="kw">if</span> (hiveName.<span class="fu">ToUpper</span>() == <span class="st">"HKEY_CURRENT_CONFIG"</span>) { <span class="kw">return</span> RegistryHive.<span class="fu">CurrentConfig</span>; }</a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="co">//last chance, will throw error if invalid</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="kw">else</span> <span class="kw">return</span> (RegistryHive)Enum.<span class="fu">Parse</span>(<span class="kw">typeof</span>(RegistryHive), hiveName);</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">}</a></code></pre></div>
<p>I’m using xUnit.net for my unit testing. xUnit’s Theories are pretty nice, allowing testing sets of data. My tests verify that the method throws errors—or doesn’t—appropriately, and also that it returns the correct hive. I wrote a note to myself about that last one, summed up as:</p>
<blockquote>
<p>Lesson 2: Don’t copy/paste any code from your test into the method you’re testing. What if your test has a bug?</p>
</blockquote>
<div class="sourceCode" id="cb7"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> RegistryService_ParseRegistryHive_Should</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">[Theory]</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">[<span class="fu">InlineData</span>(<span class="st">"HKEY_CLASSES_ROOT"</span>)]</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">[<span class="fu">InlineData</span>(<span class="st">"HKEY_CURRENT_USER"</span>)]</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">[<span class="fu">InlineData</span>(<span class="st">"HKEY_LOCAL_MACHINE"</span>)]</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">[<span class="fu">InlineData</span>(<span class="st">"HKEY_USERS"</span>)]</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">[<span class="fu">InlineData</span>(<span class="st">"HKEY_CURRENT_CONFIG"</span>)]</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">[<span class="fu">InlineData</span>(<span class="st">"hkey_current_config"</span>)]</a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">NotThrowErrorWithValidHive</span>(<span class="dt">string</span> name)</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">{</a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="dt">var</span> hive = RegistryService.<span class="fu">ParseRegistryHive</span>(name);</a>
<a class="sourceLine" id="cb7-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb7-14" data-line-number="14"></a>
<a class="sourceLine" id="cb7-15" data-line-number="15">[Theory]</a>
<a class="sourceLine" id="cb7-16" data-line-number="16">[<span class="fu">InlineData</span>(<span class="st">"HKEY_CLASSES_ROOT"</span>)]</a>
<a class="sourceLine" id="cb7-17" data-line-number="17">[<span class="fu">InlineData</span>(<span class="st">"HKEY_CURRENT_USER"</span>)]</a>
<a class="sourceLine" id="cb7-18" data-line-number="18">[<span class="fu">InlineData</span>(<span class="st">"HKEY_LOCAL_MACHINE"</span>)]</a>
<a class="sourceLine" id="cb7-19" data-line-number="19">[<span class="fu">InlineData</span>(<span class="st">"HKEY_USERS"</span>)]</a>
<a class="sourceLine" id="cb7-20" data-line-number="20">[<span class="fu">InlineData</span>(<span class="st">"HKEY_CURRENT_CONFIG"</span>)]</a>
<a class="sourceLine" id="cb7-21" data-line-number="21"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ReturnCorrectEnumWithValidHive</span>(<span class="dt">string</span> name)</a>
<a class="sourceLine" id="cb7-22" data-line-number="22">{</a>
<a class="sourceLine" id="cb7-23" data-line-number="23"><span class="co">//This basically reproduces the method code. Need to NOT copy/paste from method, but</span></a>
<a class="sourceLine" id="cb7-24" data-line-number="24"><span class="co">//instead rewrite. In TDD, would NOT copy/paste from the test, otherwise there's a danger</span></a>
<a class="sourceLine" id="cb7-25" data-line-number="25"><span class="co">//the test duplicates a wrong condition.</span></a>
<a class="sourceLine" id="cb7-26" data-line-number="26"><span class="dt">var</span> hive = RegistryService.<span class="fu">ParseRegistryHive</span>(name);</a>
<a class="sourceLine" id="cb7-27" data-line-number="27"><span class="kw">switch</span> (name)</a>
<a class="sourceLine" id="cb7-28" data-line-number="28">{</a>
<a class="sourceLine" id="cb7-29" data-line-number="29"><span class="kw">case</span> <span class="st">"HKEY_CLASSES_ROOT"</span>:</a>
<a class="sourceLine" id="cb7-30" data-line-number="30">Assert.<span class="fu">True</span>(hive == Microsoft.<span class="fu">Win32</span>.<span class="fu">RegistryHive</span>.<span class="fu">ClassesRoot</span>);</a>
<a class="sourceLine" id="cb7-31" data-line-number="31"><span class="kw">break</span>;</a>
<a class="sourceLine" id="cb7-32" data-line-number="32"><span class="kw">case</span> <span class="st">"HKEY_CURRENT_USER"</span>:</a>
<a class="sourceLine" id="cb7-33" data-line-number="33">Assert.<span class="fu">True</span>(hive == Microsoft.<span class="fu">Win32</span>.<span class="fu">RegistryHive</span>.<span class="fu">CurrentUser</span>);</a>
<a class="sourceLine" id="cb7-34" data-line-number="34"><span class="kw">break</span>;</a>
<a class="sourceLine" id="cb7-35" data-line-number="35"><span class="kw">case</span> <span class="st">"HKEY_LOCAL_MACHINE"</span>:</a>
<a class="sourceLine" id="cb7-36" data-line-number="36">Assert.<span class="fu">True</span>(hive == Microsoft.<span class="fu">Win32</span>.<span class="fu">RegistryHive</span>.<span class="fu">LocalMachine</span>);</a>
<a class="sourceLine" id="cb7-37" data-line-number="37"><span class="kw">break</span>;</a>
<a class="sourceLine" id="cb7-38" data-line-number="38"><span class="kw">case</span> <span class="st">"HKEY_USERS"</span>:</a>
<a class="sourceLine" id="cb7-39" data-line-number="39">Assert.<span class="fu">True</span>(hive == Microsoft.<span class="fu">Win32</span>.<span class="fu">RegistryHive</span>.<span class="fu">Users</span>);</a>
<a class="sourceLine" id="cb7-40" data-line-number="40"><span class="kw">break</span>;</a>
<a class="sourceLine" id="cb7-41" data-line-number="41"><span class="kw">case</span> <span class="st">"HKEY_CURRENT_CONFIG"</span>:</a>
<a class="sourceLine" id="cb7-42" data-line-number="42">Assert.<span class="fu">True</span>(hive == Microsoft.<span class="fu">Win32</span>.<span class="fu">RegistryHive</span>.<span class="fu">CurrentConfig</span>);</a>
<a class="sourceLine" id="cb7-43" data-line-number="43"><span class="kw">break</span>;</a>
<a class="sourceLine" id="cb7-44" data-line-number="44"><span class="kw">default</span>:</a>
<a class="sourceLine" id="cb7-45" data-line-number="45">Assert.<span class="fu">True</span>(<span class="kw">false</span>,name + <span class="st">" didn't return a valid hive. Hive enum returned was "</span> + hive);</a>
<a class="sourceLine" id="cb7-46" data-line-number="46"><span class="kw">break</span>;</a>
<a class="sourceLine" id="cb7-47" data-line-number="47">}</a>
<a class="sourceLine" id="cb7-48" data-line-number="48">}</a>
<a class="sourceLine" id="cb7-49" data-line-number="49"></a>
<a class="sourceLine" id="cb7-50" data-line-number="50">[Theory]</a>
<a class="sourceLine" id="cb7-51" data-line-number="51">[<span class="fu">InlineData</span>(<span class="st">"fail"</span>)]</a>
<a class="sourceLine" id="cb7-52" data-line-number="52">[<span class="fu">InlineData</span>(<span class="st">""</span>)]</a>
<a class="sourceLine" id="cb7-53" data-line-number="53"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ThrowErrorWithInvalidHive</span>(<span class="dt">string</span> name)</a>
<a class="sourceLine" id="cb7-54" data-line-number="54">{</a>
<a class="sourceLine" id="cb7-55" data-line-number="55">Assert.<span class="fu">Throws</span>(() =&gt;  RegistryService.<span class="fu">ParseRegistryHive</span>(name));</a>
<a class="sourceLine" id="cb7-56" data-line-number="56">}</a>
<a class="sourceLine" id="cb7-57" data-line-number="57">}</a></code></pre></div>
<h1 id="act-3--testing-the-difficult-mock-it-or---">Act 3 – Testing the Difficult: Mock it, or . . .</h1>
<p>I’ve been putting it off long enough. What about the rest of the methods? You know, the ones that could <em>completely screw up my registry?</em></p>
<p>First, which methods do testable work? Some of them are just wrappers so that I can get back a better error message, for example:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">public</span> <span class="kw">static</span> <span class="dt">void</span> <span class="fu">SetRegistryKeyValue</span>(<span class="dt">string</span> keyName, <span class="dt">string</span> valueName, <span class="dt">string</span> value, RegistryValueKind dataType = RegistryValueKind.<span class="fu">String</span>)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="kw">try</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">{</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">Registry.<span class="fu">SetValue</span>(keyName, valueName, value, dataType);</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="kw">catch</span> (Exception ex)</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">{</a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="kw">throw</span> <span class="kw">new</span> <span class="fu">Exception</span>(<span class="st">"Error setting registry value keyName '"</span> + keyName + <span class="st">"', valueName '"</span> + valueName + <span class="st">", value '"</span> + value + <span class="st">"'</span><span class="sc">\r\n</span><span class="st">"</span> + ex.<span class="fu">GetBaseException</span>().<span class="fu">Message</span>);</a>
<a class="sourceLine" id="cb8-10" data-line-number="10">}</a>
<a class="sourceLine" id="cb8-11" data-line-number="11">}</a></code></pre></div>
<p>Do I need to test this? Well, I’d <em>like</em> to test that I get back the right exception, so…hmm. OK, let’s see if anyone has mocked the registry.</p>
<ul>
<li><a href="https://msdn.microsoft.com/en-us/library/hh549175(v=vs.140).aspx">Microsoft Fake Framework</a> – Great if you have Visual Studio Enterprise and are, therefore, wealthy. (Here’s a <a href="http://stackoverflow.com/a/29701802/1628707">Stack Overflow</a> example.)</li>
<li><a href="https://github.com/jozefizso/SystemWrapper">SystemWrapper</a>, which wraps a lot of .Net assemblies. Here’s an <a href="http://www.rhyous.com/2011/11/04/unit-testing-registry-access-with-rhinomocks-and-systemwrapper/">article by a project contributor</a>, and uses RhinoMocks.</li>
<li>The following allow mocking classes without interfaces (but I don’t know if the class methods must be virtual): <a href="https://www.typemock.com/">“TypeMock</a> <em>(paid)</em>, <a href="http://www.telerik.com/products/mocking.aspx">JustMock</a> <em>(paid)</em>, or <a href="http://urasandesu.github.io/Prig/">Prig</a> <em>(free + open source)</em>.”</li>
</ul>
<p>In the last bullet, I quote from an excellent Stack Overflow response on the subject. In fact, here are two comments.</p>
<ul>
<li>Is it recommended to mock a concrete class? <a href="http://stackoverflow.com/a/12187583/1628707">Response by David Tchepak</a></li>
<li>Is it recommended to mock a concrete class? <a href="http://stackoverflow.com/a/15164143/1628707">Response by Michael Freidgeim</a></li>
</ul>
<p>The research tells me I have two choices:</p>
<ol>
<li>Mock the concrete Registry class</li>
<li>Use a wrapper around the Registry class</li>
</ol>
<p>I looked at the Prig example. Whew! That’s a lot of setup! And I’m not prepared to pay for TypeMock or JustMock, though I expect they’re excellent.</p>
<p>This means wrapping the Registry class. Before I try out SystemWrapper, I’m going to create my own wrapper. I want to understand what’s involved. (This is self-education, after all!) The methods I’m using are:</p>
<p>Registry.GetValue Registry.SetValue RegistryKey.GetValueKind RegistryKey.DeleteSubKey RegistryKey.DeleteValue RegistryKey.OpenBaseKey RegistryKey.OpenBaseKey.OpenSubKey</p>
<p>All right, boys! Wrap…That…Code!!!</p>
<p>I had to rethink my whole approach to my RegistryService class, which consumes the Microsoft.Win32.Registry. Originally I wrote it as a static class, since it didn’t need to be instantiated. But this class now could depend on different “registry providers.” I want to protect the class from being misused. A static SetRegistryProvider method won’t work, because of the danger that in production one caller sets it one way and another sets it differently. It’s the same as if a class could use more than one database back end; you wouldn’t make it static. The solution was to remove static, and make the class entirely instance-able.</p>
<p>Moving on, the Registry wrapper is pretty straight forward. The oddity is that I’m wrapping a static class in an instance.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">public</span> <span class="kw">interface</span> IRegistryWrapper</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="dt">object</span> <span class="fu">GetValue</span>(<span class="dt">string</span> keyName, <span class="dt">string</span> valueName, <span class="dt">object</span> defaultValue);</a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="dt">void</span> <span class="fu">SetValue</span>(<span class="dt">string</span> keyName, <span class="dt">string</span> valueName, <span class="dt">object</span> value, RegistryValueKind valueKind);</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb9-6" data-line-number="6"></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="kw">public</span> <span class="kw">class</span> RegistryWrapper : IRegistryWrapper</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">{</a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="kw">public</span> <span class="dt">object</span> <span class="fu">GetValue</span>(<span class="dt">string</span> keyName, <span class="dt">string</span> valueName, <span class="dt">object</span> defaultValue)</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">{</a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="kw">return</span> Registry.<span class="fu">GetValue</span>(keyName, valueName, defaultValue);</a>
<a class="sourceLine" id="cb9-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb9-13" data-line-number="13"></a>
<a class="sourceLine" id="cb9-14" data-line-number="14"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">SetValue</span>(<span class="dt">string</span> keyName, <span class="dt">string</span> valueName, <span class="dt">object</span> value, RegistryValueKind valueKind)</a>
<a class="sourceLine" id="cb9-15" data-line-number="15">{</a>
<a class="sourceLine" id="cb9-16" data-line-number="16">Registry.<span class="fu">SetValue</span>(keyName, valueName, value, valueKind);</a>
<a class="sourceLine" id="cb9-17" data-line-number="17">}</a>
<a class="sourceLine" id="cb9-18" data-line-number="18">}</a></code></pre></div>
<p>The RegistryKey wrapper presented a challenge. The constructor for RegistryKey is private. You cannot create an instance of RegistryKey this way:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb10-1" data-line-number="1">RegistryKey key = <span class="kw">new</span> <span class="fu">RegistryKey</span>(); <span class="co">//this won't compile</span></a></code></pre></div>
<p>Instead, instances are created using the static method OpenBaseKey().</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb11-1" data-line-number="1">RegistryKey key = RegistryKey.<span class="fu">OpenBaseKey</span>(RegistryHive.<span class="fu">CurrentUser</span>, RegistryView.<span class="fu">Registry64</span>);</a></code></pre></div>
<p>My abstraction needs to be clear, I want to create an interface, but interfaces can’t have static members.</p>
<p>A base key is <em>required</em> for RegistryKey to function, therefore it’s required for my wrapper to function. But the RegistryService class, which uses RegistryKey, encapsulates which base key will be used; each method could instantiate its own RegistryKey with different base keys. For example:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">DeletePluginVersionValue</span>(<span class="dt">string</span> id)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="co">//_registryKey was injected via the constructor</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4">RegistryKey basekey = RegistryKey.<span class="fu">OpenBaseKey</span>(RegistryHive.<span class="fu">LocalMachine</span>, RegistryView.<span class="fu">Default</span>);</a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="kw">using</span> (RegistryKey key = basekey.<span class="fu">OpenSubKey</span>(@<span class="st">"SOFTWARE\EduAgent\RegistryPlugin"</span>, <span class="kw">false</span>))</a>
<a class="sourceLine" id="cb12-6" data-line-number="6">{</a>
<a class="sourceLine" id="cb12-7" data-line-number="7">key.<span class="fu">DeleteValue</span>(<span class="st">"Value"</span>);</a>
<a class="sourceLine" id="cb12-8" data-line-number="8">key.<span class="fu">Close</span>();</a>
<a class="sourceLine" id="cb12-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb12-10" data-line-number="10">}</a></code></pre></div>
<p>My abstracted class is going to work similarly.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">DeletePluginVersionValue</span>(<span class="dt">string</span> id)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="co">//_registryKey was injected via the constructor</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4">IRegistryKeyWrapper basekey = _registryKey.<span class="fu">OpenBaseKey</span>(RegistryHive.<span class="fu">LocalMachine</span>, RegistryView.<span class="fu">Default</span>);</a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="kw">using</span> (IRegistryKeyWrapper key = basekey.<span class="fu">OpenSubKey</span>(@<span class="st">"SOFTWARE\EduAgent\RegistryPlugin"</span>,<span class="kw">false</span>))</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">{</a>
<a class="sourceLine" id="cb13-7" data-line-number="7">key.<span class="fu">DeleteValue</span>(<span class="st">"Value"</span>);</a>
<a class="sourceLine" id="cb13-8" data-line-number="8">key.<span class="fu">Close</span>();</a>
<a class="sourceLine" id="cb13-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb13-10" data-line-number="10">}</a></code></pre></div>
<p>But for testing, I need to pass in a non-null class instance that implements an interface, but does <em>not</em> have a base class yet. I <em>can’t</em> do this:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw">public</span> <span class="kw">interface</span> IRegistryKeyWrapper: IDisposable</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">IRegistryKeyWrapper <span class="fu">OpenSubKey</span>(<span class="dt">string</span> name, <span class="dt">bool</span> writable);</a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="co">//originally static</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5">IRegistryKeyWrapper <span class="fu">OpenBaseKey</span>(RegistryHive hKey, RegistryView view);</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb14-7" data-line-number="7"></a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="kw">public</span> <span class="kw">class</span> RegistryKeyWrapper : IRegistryKeyWrapper</a>
<a class="sourceLine" id="cb14-9" data-line-number="9">{</a>
<a class="sourceLine" id="cb14-10" data-line-number="10"><span class="kw">private</span> RegistryKey _baseKey;</a>
<a class="sourceLine" id="cb14-11" data-line-number="11"><span class="kw">private</span> <span class="fu">RegistryKeyWrapper</span>(RegistryKey key)</a>
<a class="sourceLine" id="cb14-12" data-line-number="12">{</a>
<a class="sourceLine" id="cb14-13" data-line-number="13">_baseKey = key;</a>
<a class="sourceLine" id="cb14-14" data-line-number="14">}</a>
<a class="sourceLine" id="cb14-15" data-line-number="15"><span class="co">//etc.</span></a></code></pre></div>
<p>Why not? Follow along.</p>
<p>The RegistryService constructor:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> RegistryService</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="kw">private</span> IRegistryWrapper _registry;</a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="kw">private</span> IRegistryKeyWrapper _registryKey;</a>
<a class="sourceLine" id="cb15-5" data-line-number="5"></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="kw">public</span> <span class="fu">RegistryService</span>(IRegistryWrapper registry, IRegistryKeyWrapper key)</a>
<a class="sourceLine" id="cb15-7" data-line-number="7">{</a>
<a class="sourceLine" id="cb15-8" data-line-number="8">_registry = registry;</a>
<a class="sourceLine" id="cb15-9" data-line-number="9">_registryKey = key;</a>
<a class="sourceLine" id="cb15-10" data-line-number="10">}</a></code></pre></div>
<p>Using the RegistryService:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="co">//this won't compile; RegistryKeyWrapper requires base key!</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2">RegistryService service = <span class="kw">new</span> <span class="fu">RegistryService</span>(<span class="kw">new</span> <span class="fu">RegistryWrapper</span>(), <span class="kw">new</span> <span class="fu">RegistryKeyWrapper</span>());</a></code></pre></div>
<p>I <em>need</em> to be able to create a new RegistryKeyWrapper(), but my live registry wrapper right now requires an actual registry base key. The (unfortunate) solution is to allow the user to create an instance of the class that can’t work.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> RegistryKeyWrapper : IRegistryKeyWrapper</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="kw">private</span> RegistryKey _baseKey;</a>
<a class="sourceLine" id="cb17-4" data-line-number="4"></a>
<a class="sourceLine" id="cb17-5" data-line-number="5"><span class="co">///</span></a>
<a class="sourceLine" id="cb17-6" data-line-number="6"><span class="co">/// Note the class can't be used until instantiated using OpenBaseKey or setting to another RegistryKeyWrapper.</span></a>
<a class="sourceLine" id="cb17-7" data-line-number="7"><span class="co">/// This constructor is here to allow an instance to be passed via dependency injection.</span></a>
<a class="sourceLine" id="cb17-8" data-line-number="8"><span class="co">///</span></a>
<a class="sourceLine" id="cb17-9" data-line-number="9"><span class="kw">public</span> <span class="fu">RegistryKeyWrapper</span>() { }</a>
<a class="sourceLine" id="cb17-10" data-line-number="10"></a>
<a class="sourceLine" id="cb17-11" data-line-number="11"><span class="kw">private</span> <span class="fu">RegistryKeyWrapper</span>(RegistryKey key)</a>
<a class="sourceLine" id="cb17-12" data-line-number="12">{</a>
<a class="sourceLine" id="cb17-13" data-line-number="13">_baseKey = key;</a>
<a class="sourceLine" id="cb17-14" data-line-number="14">}</a></code></pre></div>
<p>In the RegistryService example, above, if the user were to use _registryKey immediately, without setting it using OpeBaseKey, it would fail because the private variable _baseKey has not been set.</p>
<p>I wouldn’t call this ideal, but it does allow us to test the class.</p>
<p><strong>EDIT 8/31/16 -------------------------------------------------------------</strong></p>
<p><strong>Not only is it not ideal, but it’s not even good. What I’m trying to do is wrap RegistryKey in a pass-through manner. But that’s a mistake, because it implements IDisposable and in my wrapper I <em>should not</em> implement IDisposable.</strong></p>
<p><strong>In a later post, I’ll explain how I rewrote my RegistryKey wrapper in a better way. It doesn’t affect the validity of the info in this post.</strong></p>
<p><strong>-------------------------------------------------------------</strong></p>
<p>First, I’ll fix up my previous tests for ParseRegistryHive that relied on Registry. In my unit test project I create the mock classes. At this point, I don’t even make the classes work, since ParseRegistryHive doesn’t depend on any methods.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw">class</span> RegistryMock : IRegistryWrapper</a>
<a class="sourceLine" id="cb18-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb18-3" data-line-number="3"><span class="kw">public</span> <span class="dt">object</span> <span class="fu">GetValue</span>(<span class="dt">string</span> keyName, <span class="dt">string</span> valueName, <span class="dt">object</span> defaultValue)</a>
<a class="sourceLine" id="cb18-4" data-line-number="4">{</a>
<a class="sourceLine" id="cb18-5" data-line-number="5"><span class="kw">throw</span> <span class="kw">new</span> <span class="fu">NotImplementedException</span>();</a>
<a class="sourceLine" id="cb18-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb18-7" data-line-number="7"></a>
<a class="sourceLine" id="cb18-8" data-line-number="8"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">SetValue</span>(<span class="dt">string</span> keyName, <span class="dt">string</span> valueName, <span class="dt">object</span> value, RegistryValueKind valueKind)</a>
<a class="sourceLine" id="cb18-9" data-line-number="9">{</a>
<a class="sourceLine" id="cb18-10" data-line-number="10"><span class="kw">throw</span> <span class="kw">new</span> <span class="fu">NotImplementedException</span>();</a>
<a class="sourceLine" id="cb18-11" data-line-number="11">}</a>
<a class="sourceLine" id="cb18-12" data-line-number="12">}</a></code></pre></div>
<p>And update a test to use the new service, passing in the mocks.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb19-1" data-line-number="1">IRegistryWrapper _registry = <span class="kw">new</span> <span class="fu">RegistryMock</span>();</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">IRegistryKeyWrapper _registryKey = <span class="kw">new</span> <span class="fu">RegistryKeyMock</span>();</a>
<a class="sourceLine" id="cb19-3" data-line-number="3"></a>
<a class="sourceLine" id="cb19-4" data-line-number="4">[Theory]</a>
<a class="sourceLine" id="cb19-5" data-line-number="5">[<span class="fu">InlineData</span>(<span class="st">"HKEY_CLASSES_ROOT"</span>)]</a>
<a class="sourceLine" id="cb19-6" data-line-number="6">[<span class="fu">InlineData</span>(<span class="st">"HKEY_CURRENT_USER"</span>)]</a>
<a class="sourceLine" id="cb19-7" data-line-number="7">[<span class="fu">InlineData</span>(<span class="st">"HKEY_LOCAL_MACHINE"</span>)]</a>
<a class="sourceLine" id="cb19-8" data-line-number="8">[<span class="fu">InlineData</span>(<span class="st">"HKEY_USERS"</span>)]</a>
<a class="sourceLine" id="cb19-9" data-line-number="9">[<span class="fu">InlineData</span>(<span class="st">"HKEY_CURRENT_CONFIG"</span>)]</a>
<a class="sourceLine" id="cb19-10" data-line-number="10">[<span class="fu">InlineData</span>(<span class="st">"hkey_current_config"</span>)]</a>
<a class="sourceLine" id="cb19-11" data-line-number="11"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">NotThrowErrorWithValidHive</span>(<span class="dt">string</span> name)</a>
<a class="sourceLine" id="cb19-12" data-line-number="12">{</a>
<a class="sourceLine" id="cb19-13" data-line-number="13"><span class="dt">var</span> service = <span class="kw">new</span> <span class="fu">RegistryService</span>(_registry, _registryKey);</a>
<a class="sourceLine" id="cb19-14" data-line-number="14"><span class="dt">var</span> hive = service.<span class="fu">ParseRegistryHive</span>(name);</a>
<a class="sourceLine" id="cb19-15" data-line-number="15">}</a></code></pre></div>
<p>Now, create a test for the RegistryMock.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> RegistryService_GetRegistryKeyValue_Should</a>
<a class="sourceLine" id="cb20-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">IRegistryWrapper _registry = <span class="kw">new</span> <span class="fu">RegistryMock</span>();</a>
<a class="sourceLine" id="cb20-4" data-line-number="4">IRegistryKeyWrapper _registryKey = <span class="kw">new</span> <span class="fu">RegistryKeyMock</span>();</a>
<a class="sourceLine" id="cb20-5" data-line-number="5"></a>
<a class="sourceLine" id="cb20-6" data-line-number="6">[Fact]</a>
<a class="sourceLine" id="cb20-7" data-line-number="7"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ReturnNullConstantTextIfValueIsMissing</span>()</a>
<a class="sourceLine" id="cb20-8" data-line-number="8">{</a>
<a class="sourceLine" id="cb20-9" data-line-number="9"><span class="dt">var</span> service = <span class="kw">new</span> <span class="fu">RegistryService</span>(_registry, _registryKey);</a>
<a class="sourceLine" id="cb20-10" data-line-number="10"><span class="dt">var</span> result = service.<span class="fu">GetRegistryKeyValue</span>(@<span class="st">"HKEY_LOCAL_MACHINE\SOFTWARE\EduAgent"</span>, <span class="st">"Version"</span>);</a>
<a class="sourceLine" id="cb20-11" data-line-number="11">Assert.<span class="fu">Equal</span>(result, service.<span class="fu">NoValue</span>);</a>
<a class="sourceLine" id="cb20-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb20-13" data-line-number="13">}</a></code></pre></div>
<p>Which requires RegistryMock.GetValue to be implemented:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="kw">class</span> RegistryMock : IRegistryWrapper</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb21-3" data-line-number="3"><span class="kw">public</span> <span class="dt">object</span> <span class="fu">GetValue</span>(<span class="dt">string</span> keyName, <span class="dt">string</span> valueName, <span class="dt">object</span> defaultValue)</a>
<a class="sourceLine" id="cb21-4" data-line-number="4">{</a>
<a class="sourceLine" id="cb21-5" data-line-number="5"><span class="co">//this may become cumbersome, but for now specify some return values</span></a>
<a class="sourceLine" id="cb21-6" data-line-number="6"><span class="kw">switch</span> (keyName)</a>
<a class="sourceLine" id="cb21-7" data-line-number="7">{</a>
<a class="sourceLine" id="cb21-8" data-line-number="8"><span class="kw">case</span> @<span class="st">"HKEY_LOCAL_MACHINE\SOFTWARE\EduAgent"</span>:</a>
<a class="sourceLine" id="cb21-9" data-line-number="9"><span class="kw">if</span> (valueName == <span class="st">"Version"</span>) <span class="kw">return</span> defaultValue;</a>
<a class="sourceLine" id="cb21-10" data-line-number="10"><span class="kw">break</span>;</a>
<a class="sourceLine" id="cb21-11" data-line-number="11">}</a>
<a class="sourceLine" id="cb21-12" data-line-number="12"><span class="kw">throw</span> <span class="kw">new</span> <span class="fu">Exception</span>(<span class="st">"Invalid keyName"</span>);</a>
<a class="sourceLine" id="cb21-13" data-line-number="13">}</a></code></pre></div>
<p>Running the test, it passes.</p>
<p>Next up, using the RegistryKeyMock. Here’s the test:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> RegistryService_OpenSubKey64_Should</a>
<a class="sourceLine" id="cb22-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb22-3" data-line-number="3">IRegistryWrapper _registry = <span class="kw">new</span> <span class="fu">RegistryMock</span>();</a>
<a class="sourceLine" id="cb22-4" data-line-number="4">IRegistryKeyWrapper _registryKey = <span class="kw">new</span> <span class="fu">RegistryKeyMock</span>();</a>
<a class="sourceLine" id="cb22-5" data-line-number="5"></a>
<a class="sourceLine" id="cb22-6" data-line-number="6">[Fact]</a>
<a class="sourceLine" id="cb22-7" data-line-number="7"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ThrowExceptionWhenUsingInvalidKey</span>()</a>
<a class="sourceLine" id="cb22-8" data-line-number="8">{</a>
<a class="sourceLine" id="cb22-9" data-line-number="9"><span class="dt">var</span> service = <span class="kw">new</span> <span class="fu">RegistryService</span>(_registry, _registryKey);</a>
<a class="sourceLine" id="cb22-10" data-line-number="10"><span class="dt">var</span> ex = Assert.<span class="fu">Throws</span>(() =&gt; service.<span class="fu">OpenSubKey64</span>(@<span class="st">"HKEY_LOCAL_MACHINE\SOFTWARE\EduAgentMissing"</span>));</a>
<a class="sourceLine" id="cb22-11" data-line-number="11">Assert.<span class="fu">Equal</span>(<span class="st">"Error opening subkey 'HKEY_LOCAL_MACHINE</span><span class="sc">\\</span><span class="st">SOFTWARE</span><span class="sc">\\</span><span class="st">EduAgentMissing'. Operation returned null."</span>, ex.<span class="fu">Message</span>);</a>
<a class="sourceLine" id="cb22-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb22-13" data-line-number="13">}</a></code></pre></div>
<p>Here are the relevant methods I had to implement. This one was kind of tricky because I have to set properties that are read only. I’m making use of the latest C# language features to set the value of read only properties in the constructor. I also needed a helper method to return the string representation of a hive name.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> RegistryKeyMock : IRegistryKeyWrapper</a>
<a class="sourceLine" id="cb23-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb23-3" data-line-number="3"><span class="kw">public</span> <span class="fu">RegistryKeyMock</span>() { }</a>
<a class="sourceLine" id="cb23-4" data-line-number="4"><span class="kw">public</span> <span class="fu">RegistryKeyMock</span>(<span class="dt">string</span> name, <span class="dt">int</span> subKeyCount, <span class="dt">int</span> valueCount, RegistryView view)</a>
<a class="sourceLine" id="cb23-5" data-line-number="5">{</a>
<a class="sourceLine" id="cb23-6" data-line-number="6">Name = name;</a>
<a class="sourceLine" id="cb23-7" data-line-number="7">SubKeyCount = subKeyCount;</a>
<a class="sourceLine" id="cb23-8" data-line-number="8">ValueCount = valueCount;</a>
<a class="sourceLine" id="cb23-9" data-line-number="9">View = view;</a>
<a class="sourceLine" id="cb23-10" data-line-number="10">}</a>
<a class="sourceLine" id="cb23-11" data-line-number="11"></a>
<a class="sourceLine" id="cb23-12" data-line-number="12"><span class="kw">public</span> <span class="dt">string</span> Name { <span class="kw">get</span>; }</a>
<a class="sourceLine" id="cb23-13" data-line-number="13"><span class="kw">public</span> <span class="dt">int</span> SubKeyCount { <span class="kw">get</span>; }</a>
<a class="sourceLine" id="cb23-14" data-line-number="14"><span class="kw">public</span> <span class="dt">int</span> ValueCount { <span class="kw">get</span>; }</a>
<a class="sourceLine" id="cb23-15" data-line-number="15"><span class="kw">public</span> RegistryView View { <span class="kw">get</span>; }</a>
<a class="sourceLine" id="cb23-16" data-line-number="16"></a>
<a class="sourceLine" id="cb23-17" data-line-number="17"><span class="kw">public</span> IRegistryKeyWrapper <span class="fu">OpenBaseKey</span>(RegistryHive hKey, RegistryView view)</a>
<a class="sourceLine" id="cb23-18" data-line-number="18">{</a>
<a class="sourceLine" id="cb23-19" data-line-number="19"><span class="kw">return</span> <span class="kw">new</span> <span class="fu">RegistryKeyMock</span>(<span class="fu">HiveToString</span>(hKey), <span class="dv">10</span>, <span class="dv">10</span>, view);</a>
<a class="sourceLine" id="cb23-20" data-line-number="20">}</a>
<a class="sourceLine" id="cb23-21" data-line-number="21"></a>
<a class="sourceLine" id="cb23-22" data-line-number="22"><span class="kw">public</span> IRegistryKeyWrapper <span class="fu">OpenSubKey</span>(<span class="dt">string</span> name, <span class="dt">bool</span> writable)</a>
<a class="sourceLine" id="cb23-23" data-line-number="23">{</a>
<a class="sourceLine" id="cb23-24" data-line-number="24"><span class="kw">if</span> (name == @<span class="st">"SOFTWARE\EduAgentMissing"</span>)</a>
<a class="sourceLine" id="cb23-25" data-line-number="25"><span class="kw">return</span> <span class="kw">null</span>;</a>
<a class="sourceLine" id="cb23-26" data-line-number="26"><span class="kw">return</span> <span class="kw">new</span> <span class="fu">RegistryKeyMock</span>(Name + <span class="st">"</span><span class="sc">\\</span><span class="st">"</span> + name, SubKeyCount, ValueCount, View);</a>
<a class="sourceLine" id="cb23-27" data-line-number="27">}</a>
<a class="sourceLine" id="cb23-28" data-line-number="28"></a>
<a class="sourceLine" id="cb23-29" data-line-number="29"><span class="kw">private</span> <span class="dt">string</span> <span class="fu">HiveToString</span>(RegistryHive hive)</a>
<a class="sourceLine" id="cb23-30" data-line-number="30">{</a>
<a class="sourceLine" id="cb23-31" data-line-number="31"><span class="dt">string</span> key = <span class="st">"HKEY_"</span>;</a>
<a class="sourceLine" id="cb23-32" data-line-number="32"><span class="kw">if</span> (hive == RegistryHive.<span class="fu">ClassesRoot</span>) <span class="kw">return</span> key + <span class="st">"CLASSES_ROOT"</span>;</a>
<a class="sourceLine" id="cb23-33" data-line-number="33"><span class="kw">if</span> (hive == RegistryHive.<span class="fu">CurrentConfig</span>) <span class="kw">return</span> key + <span class="st">"CURRENT_CONFIG"</span>;</a>
<a class="sourceLine" id="cb23-34" data-line-number="34"><span class="kw">if</span> (hive == RegistryHive.<span class="fu">CurrentUser</span>) <span class="kw">return</span> key + <span class="st">"CURRENT_USER"</span>;</a>
<a class="sourceLine" id="cb23-35" data-line-number="35"><span class="kw">if</span> (hive == RegistryHive.<span class="fu">LocalMachine</span>) <span class="kw">return</span> key + <span class="st">"LOCAL_MACHINE"</span>;</a>
<a class="sourceLine" id="cb23-36" data-line-number="36"><span class="kw">if</span> (hive == RegistryHive.<span class="fu">Users</span>) <span class="kw">return</span> key + <span class="st">"USERS"</span>;</a>
<a class="sourceLine" id="cb23-37" data-line-number="37"><span class="kw">return</span> <span class="st">""</span>;</a>
<a class="sourceLine" id="cb23-38" data-line-number="38">}</a>
<a class="sourceLine" id="cb23-39" data-line-number="39">}</a></code></pre></div>
<p>Test it, it passes, love those green lights!</p>
<h1 id="tag">Tag</h1>
<p>This was like a special made-for-TV movie of <em>Fantastic Journey</em>. With all the stuff I’ve done, what haven’t I? Well, there are two big ones:</p>
<ul>
<li>Use a mocking framework such as <a href="https://github.com/Moq/moq4">Moq</a> or <a href="https://www.hibernatingrhinos.com/oss/rhino-mocks">RhinoMocks</a></li>
<li>Use an Inversion of Control container such as <a href="http://www.ninject.org/">Ninject</a> or <a href="https://github.com/unitycontainer/unity">Unity</a>.</li>
</ul>
<p>But I’m leaving those for a future post. Otherwise, like our intrepid explorers, I’ll be canceled and never get back to my own time and place.</p>
<p><img src="http://epguides.com/FantasticJourney/cast.jpg"></p>
</div>
              </div>
              
    <div class='paging'><a href='index10.html'>Newer</a>&nbsp;&nbsp;&nbsp;<a href='index12.html'>Older</a></div>
  </section>
  <footer><p>Copyright (c) 2018 Charles L Flatt</p>
</footer>
  
</body>

</html>