<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta property="og:image" content="https://www.softwaremeadows.com/images/header.png" />
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117916694-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-117916694-1');
  </script>
  <script src='https://www.softwaremeadows.com/header-scripts/prism.js'></script>

  <link rel='stylesheet' href='https://www.softwaremeadows.com/css/default.css' />
<link rel='stylesheet' href='https://www.softwaremeadows.com/css/kavadocs.css' />
<link rel='stylesheet' href='https://www.softwaremeadows.com/css/prism.css' />
<link rel='stylesheet' href='https://www.softwaremeadows.com/css/responsive.css' />


  <title>Why The Repository Pattern Fails For Legacy Databases Like Yours And What To Do About It | Software Meadows</title>
</head>

<body>
  <div class="row">
    <div class="col-left">
      <nav id="nav" class="nav">
        <div id="menu">
          <ol>
<li><a href="https://www.softwaremeadows.com/">Home</a></li>
<li><a href="https://www.softwaremeadows.com/devops">DevOps</a></li>
<li><a href="https://www.softwaremeadows.com/well-being">Well-Being</a></li>
<li><a href="https://www.softwaremeadows.com/about">About</a></li>
<li><a target="_blank" href="https://github.com/bladewolf55">On GitHub</a></li>
</ol>

        </div>
        <div id="recent">
          <h2>Recent</h2>
          <a href='https://www.softwaremeadows.com/posts/remote_work_tiny_habits_-_staying_healthy_food'>Remote Work Tiny Habits - Staying Healthy (Food)</a><a href='https://www.softwaremeadows.com/posts/remote_work_tiny_tips_-_staying_healthy_exercise'>Remote Work Tiny Tips - Staying Healthy (Exercise)</a><a href='https://www.softwaremeadows.com/posts/remote_work_tiny_tips_-_focusing_and_breaking'>Remote Work Tiny Tips - Focusing</a><a href='https://www.softwaremeadows.com/posts/remote_work_tiny_tips_-_forming_new_habits'>Remote Work Tiny Tips - Forming New Habits</a><a href='https://www.softwaremeadows.com/posts/remote_work_tiny_tips_-_keeping_your_routine'>Remote Work Tiny Tips - Keeping Your Routine</a>
        </div>
        <div id="history">
          <h2>History</h2>
          <ol class='tree'><li class='history-year'><label for='2020'>2020</label><input type='checkbox'  id='2020' /><ol><li class='history-month'><label for='2020-3'>March</label><input type='checkbox'  id='2020-3' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/remote_work_tiny_habits_-_staying_healthy_food'>Remote Work Tiny Habits - Staying Healthy (Food)</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/remote_work_tiny_tips_-_staying_healthy_exercise'>Remote Work Tiny Tips - Staying Healthy (Exercise)</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/remote_work_tiny_tips_-_focusing_and_breaking'>Remote Work Tiny Tips - Focusing</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/remote_work_tiny_tips_-_forming_new_habits'>Remote Work Tiny Tips - Forming New Habits</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/remote_work_tiny_tips_-_keeping_your_routine'>Remote Work Tiny Tips - Keeping Your Routine</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/continuous_integration_flow_-_an_accurate_and_unlovely_graphic'>Continuous Integration Flow - An Accurate and Unlovely Graphic</a></li></ol></li><li class='history-month'><label for='2020-2'>February</label><input type='checkbox'  id='2020-2' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/why_the_repository_pattern_fails_for_legacy_database_like_yours_and_wh'>Why the Repository Pattern Fails for Legacy Databases Like Yours and What to Do About It</a></li></ol></li><li class='history-month'><label for='2020-1'>January</label><input type='checkbox'  id='2020-1' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/mock_returning_a_list_as_imongoqueryable_for_unit_testing'>Mock returning a List as IMongoQueryable for unit testing</a></li></ol></li></ol></li><li class='history-year'><label for='2019'>2019</label><input type='checkbox'  id='2019' /><ol><li class='history-month'><label for='2019-12'>December</label><input type='checkbox'  id='2019-12' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/git_basics_with_visual_studio_2019'>Git Basics With Visual Studio 2019</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/tfs_azure_devops__building_and_releasing_git_branches,_a_simple_example'>TFS/Azure DevOps: Building and Releasing Git Branches, A Simple Example</a></li></ol></li><li class='history-month'><label for='2019-10'>October</label><input type='checkbox'  id='2019-10' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/who_are_you_coding_for_'>Who Are You Coding For?</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/the_viewservice_pattern__especially_good_for_windows_forms'>The ViewService Pattern: Especially Good For Windows Forms</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/most_of_us_developers_arent_smart'>Most of Us Developers Aren't Smart</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/confirmed_android_text_punctuation_voice_commands'>Confirmed Android text punctuation voice commands</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/summary_of_accelerate_state_of_devops_2019'>Summary of "Accelerate State of DevOps 2019"</a></li></ol></li><li class='history-month'><label for='2019-9'>September</label><input type='checkbox'  id='2019-9' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/posh-git_fork_to_allow_visual_studio_to_use_tfvc_and_ignore_git'>Posh-git Fork to Allow Visual Studio to Use TFVC and Ignore Git</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/asp_net_core_controllers_-_exploring_how_to_test_a_simple_feature'>ASP.NET Core Controllers - Exploring How To Test a Simple Feature</a></li></ol></li><li class='history-month'><label for='2019-8'>August</label><input type='checkbox'  id='2019-8' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/remote_micro-exclusions-_two_poor_daily_standup_practices'>Remote Micro-Exclusions: Two Poor Daily Standup Practices</a></li></ol></li><li class='history-month'><label for='2019-6'>June</label><input type='checkbox'  id='2019-6' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/memstate-_the_practical_argument_for_big_in-memory_data'>Memstate: The Practical Argument for Big, In-Memory Data</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/grammar_for_developers_apostrophes_3_simple_rules_3_common_mistakes'>Grammar for Developers - Apostrophes: 3 Simple Rules, 3 Common Mistakes</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/weekly_sugar-_accelerate__the_best_book_about_devops'>Weekly Sugar: 'Accelerate', the Best Book About DevOps</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/20190616-1610 flatts_posts-casts_review_003'>Flatt's Posts/Casts Review #003 - Incentives, Emotions, Diversity, and Applying Bodyguard Training to Coding</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/weekly_sugar-_applying_kanban_principles_to_your_personal_task_list'>Weekly Sugar: Applying Kanban Principles to Your Personal Task List</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/joe_developer-_when_(not)_to_drink_coffee'>Joe Developer: When (not) to Drink Coffee</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/an_open_email_to_blackwing602_com_about_their_poor_account_security'>An Open Email to Blackwing602.com About Their Poor Account Security</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/weekly_sugar-_take_a_walk'>Weekly Sugar: Take a Walk</a></li></ol></li><li class='history-month'><label for='2019-5'>May</label><input type='checkbox'  id='2019-5' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/a_response_to_jonathan_cutrells_podcast_episode_crafting_your_work_b'>A Response to Jonathan Cutrell's Podcast Episode "Crafting Your Work By Your Strengths"</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/weekly_sugar-_when_(not)_to_drink_coffe__a_preview'>Weekly Sugar: When (not) to Drink Coffee, a Preview</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/flatts_posts-casts_review_002_-_real_problems__strengths__korean_war'>Flatt's Posts/Casts Review #002 - Real Problems, Strengths, Korean War, Smaller Problems, Good/Bad Shame</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/the_50-10_time_box_revising_pomodoro_for_software_development_repost'>The 50-10 Time Box - Revising Pomodoro for Software Development</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/flatts_post-cast_reviews_001_-_job_search_burnout_blazor_net_core_configuration'>Flatt's Posts/Casts Review #001 - Job Search, Burnout, Blazor, .NET Core Configuration, Personal Agency, Natural Movement, KonMari in Business</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/weekly_sugar-_when_is_music_a_distraction_'>Weekly Sugar: When is Music a Distraction?</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/yes_or_no_a_classic_and_effective_book_for_decision_making'>"Yes or No?" -- A Classic and Effective Book For Decision-Making</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/my_git_aliases_with_a_nod_to_Smith_and_Jones'>"My" Git Aliases (with a nod to Smith and Jones)</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/proposal-_combine_agile_and_craftsmanship_manifestos_into_agile_crafted_software_values'>Proposal: Combine Agile and Craftsmanship Manifestos into "Agile Crafted Software Values"</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/suggestion_for_uncle_bob-_change_software_craftsmanship_to_crafted_software'>Suggestion for Uncle Bob: Change "Software Craftsmanship" to "Crafted Software"</a></li></ol></li><li class='history-month'><label for='2019-4'>April</label><input type='checkbox'  id='2019-4' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/my_mixed_relationship_with_tdd'>My Mixed Relationship with TDD</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/dont_be_a_lazy_programmer_like_matthew_jones_isnt'>Don't Be a Lazy Programmer Like Matthew Jones Isn't</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/personal_reflections_on_removing_distractions_for_improved_productivity'>Personal Reflections on Removing Distractions for Improved Productivity</a></li></ol></li><li class='history-month'><label for='2019-3'>March</label><input type='checkbox'  id='2019-3' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/creating_a_modern__practical_resume'>Creating a Modern, Practical Résumé</a></li></ol></li><li class='history-month'><label for='2019-2'>February</label><input type='checkbox'  id='2019-2' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/a_week_of_web_blocking_for_productivity_and_well-being'>Digital Minimalism: A Week of Web Blocking for Productivity and Well-Being</a></li></ol></li><li class='history-month'><label for='2019-1'>January</label><input type='checkbox'  id='2019-1' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/revert_packagereference_project_to_packages_config'>Revert PackageReference Project to Packages.config</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/create_a_simple_photo_album_site_with_wix'>Create a Simple Photo Album Site With Wix</a></li></ol></li></ol></li><li class='history-year'><label for='2018'>2018</label><input type='checkbox'  id='2018' /><ol><li class='history-month'><label for='2018-11'>November</label><input type='checkbox'  id='2018-11' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/three_rules_for_successfully_starting_a_habit'>Three Rules for Successfully Starting a Habit</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/going_full_screen-_when_and_why'>Going Full Screen: When and Why</a></li></ol></li><li class='history-month'><label for='2018-10'>October</label><input type='checkbox'  id='2018-10' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/nuget_packagereference_in_visual_studio'>NuGet PackageReference in Visual Studio</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/accelerate_book_notes_and_quotes'>Accelerate Book Notes</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/getting_started_with_software_(and_business_and_life)_skills'>Getting Started With Software (and Business and Life) Skills</a></li></ol></li><li class='history-month'><label for='2018-9'>September</label><input type='checkbox'  id='2018-9' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/shortest_user_story_intro_ever'>Shortest User Story Intro Ever</a></li></ol></li><li class='history-month'><label for='2018-8'>August</label><input type='checkbox'  id='2018-8' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/a_simple__effective_meeting_agenda_system'>A Simple, Effective Meeting Agenda System</a></li></ol></li><li class='history-month'><label for='2018-7'>July</label><input type='checkbox'  id='2018-7' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/highly_opinionated_android_to_do_and_note_apps_comparison'>Highly Opinionated Android To Do and Note Apps Comparison</a></li></ol></li><li class='history-month'><label for='2018-6'>June</label><input type='checkbox'  id='2018-6' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/tidbits_vs_code-_orange_icon_resurrection'>Tid Bits: VS Code: Orange Icon Resurrection</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/tidbits_use_visual_studio_for_git_diff-merge'>Tid Bits: Use Visual Studio for Git Diff/Merge</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/3_chrome_extensions_for_performance__research__and_blogging'>3 Chrome Extensions for Performance, Research, and Blogging</a></li></ol></li><li class='history-month'><label for='2018-5'>May</label><input type='checkbox'  id='2018-5' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/chrome_browser_pinned_startup_tabs'>Chrome Browser Pinned Startup Tabs</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/solving_nancyfx_tokenizer_keychain_bin_invalid_read_type_request_115'>Solving NancyFx Tokenizer keyChain.bin Invalid Read Type Request '115'</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/my_ideal_markdown_editor_-_thoughts_and_reviews_part_1'>My Ideal Markdown Editor - Thoughts and Reviews Part 1</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/my_why_and_how_of_posh_git_contenxt_menu_transcripts_and_tf_exe'>My Why and How of posh-git: Context Menu, Transcripts, and TF.exe</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/how_to_secure-erase_regular_and_ssd_hard_drives_without_superstition'>How to Secure-Erase Regular and SSD Hard Drives Without Superstition</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/sql_permissions_for_data_folders'>SQL Permissions for Data Folders</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/grammar_for_developers_-_3_simple_rules_3_common_mistakes'>Grammar for Developers - 3 Simple Rules, 3 Common Mistakes</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/notes_on_improving_developer_team_practices_1'>Notes on Improving Developer Team Practices</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/using_git_locally_with_remote_tfvc'>Using Git Locally With Remote TFVC</a></li></ol></li><li class='history-month'><label for='2018-4'>April</label><input type='checkbox'  id='2018-4' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/raw_code_-_picture_renaming_and_sorting'>Raw Code - Picture Renaming and Sorting</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/becoming_a_professional_blogger_part_1'>Becoming a Professional Blogger Part 1</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/entity_framework_6_child_deletion_and_foreign_keys_string_int_guid'>Entity Framework 6 Child Deletion and Foreign Keys - String Int GUID</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/the_50-10_time_box_revising_pomodoro_for_software_development'>The 50-10 Time Box - Revising Pomodoro for Software Development</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/linqpad_-_refresh_entity_after_submitchanges_to_avoid_cached_results'>LINQPad - Refresh Entity after SubmitChanges to Avoid Cached Results</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/create_blog_post_using_markdown_monster_command_addin'>Create Blog Post Using Markdown Monster's Command Addin</a></li></ol></li><li class='history-month'><label for='2018-3'>March</label><input type='checkbox'  id='2018-3' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/batch_image_resize_checking_min_max_in_both_dimensions'>Batch Image Resize Checking Min Max in Both Dimensions</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/announcing_deepshadow'>Announcing DeepShadow</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/announcing_deftconfig'>Announcing DeftConfig</a></li></ol></li><li class='history-month'><label for='2018-1'>January</label><input type='checkbox'  id='2018-1' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/tfs_2015_publish_asp_net_using_robocopy'>TFS 2015: Publish ASP.NET Using Robocopy</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/combining_veracrypt_google_backup_sync_sql_server_part_2'>Combining VeraCrypt, Google Backup & Sync, and Sql Server Part 2</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/combining_veracrypt_google_backup_sync_sql_server_part_1'>Combining VeraCrypt, Google Backup & Sync, and Sql Server Part 1</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/new-blog-engine'>New Blog Engine</a></li></ol></li></ol></li><li class='history-year'><label for='2017'>2017</label><input type='checkbox'  id='2017' /><ol><li class='history-month'><label for='2017-8'>August</label><input type='checkbox'  id='2017-8' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/dont-use-data-prefix-in-angularjs'>Don't use "data" prefix in AngularJS</a></li></ol></li><li class='history-month'><label for='2017-7'>July</label><input type='checkbox'  id='2017-7' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/angularjs-service-with-var-declarations'>AngularJS service with var declarations instead of this. assignments</a></li></ol></li><li class='history-month'><label for='2017-6'>June</label><input type='checkbox'  id='2017-6' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/factory-resetting-android-without'>Factory Resetting Android Without Losing Your Life (Metaphorically)</a></li></ol></li><li class='history-month'><label for='2017-5'>May</label><input type='checkbox'  id='2017-5' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-4'>IdentityServer3 with PKCE Part 4 - Persisting User Data</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-3'>IdentityServer3 with PKCE Part 3 - Persist IdentityServer Configuration</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-2'>IdentityServer3 with PKCE Part 2 - Protected Resource Server</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/identityserver3-with-pkce-part-1-simple'>IdentityServer3 with PKCE Part 1 - Simple OAuth2 Server</a></li></ol></li><li class='history-month'><label for='2017-3'>March</label><input type='checkbox'  id='2017-3' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through'>TFS Continuous Integration Walk Through Part 5c - Multiple Solutions: Dependencies</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/sane-database-schema-conventions'>Sane Database Schema Conventions</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/tfs-continuous-integration-agent'>TFS Continuous Integration - Agent Installation and Visual Studio Licensing</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/tfs-continuous-integration-clickonce'>TFS Continuous Integration - ClickOnce Apps</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/tfs-continuous-integration-and-private'>TFS Continuous Integration and Private NuGet Package Sources</a></li></ol></li><li class='history-month'><label for='2017-2'>February</label><input type='checkbox'  id='2017-2' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_22'>TFS Continuous Integration Walk Through Part 5b - Multiple Solutions: Simple Project References</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_20'>TFS Continuous Integration Walk Through Part 5a - Multiple Solutions: Overview</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_24'>TFS Continuous Integration Walk Through Part 4b - Problems With Traits</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_6'>TFS Continuous Integration Walk Through Part 4a - Filtering Tests</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_63'>TFS Continuous Integration Walk Through Part 3 - Notifications</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through_5'>TFS Continuous Integration Walk Through Part 2 - Create an Automated Build</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/tfs-continuous-integration-walk-through'>TFS Continuous Integration Walk Through Part 1 - Installing TFS and Checking In a Test Project</a></li></ol></li><li class='history-month'><label for='2017-1'>January</label><input type='checkbox'  id='2017-1' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/what-else-programmers-do-text'>What Else Programmers Do: A Text Manipulation Example</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/what-does-this-code-do-extended'>What does this code do? Extended explanation</a></li></ol></li></ol></li><li class='history-year'><label for='2016'>2016</label><input type='checkbox'  id='2016' /><ol><li class='history-month'><label for='2016-12'>December</label><input type='checkbox'  id='2016-12' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/nexus-5-gps-lock-problem-and-two'>Nexus 5 GPS Lock Problem and Three--or More!--Solutions</a></li></ol></li><li class='history-month'><label for='2016-11'>November</label><input type='checkbox'  id='2016-11' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/how-to-bypass-new-microsoft-office'>How to Bypass the New Microsoft Office Startup and Save Screens</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/google-tasks-vs-reminders-in-desktop'>Google Tasks vs Reminders in Desktop and Phone</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/catching-up-on-coding-claims-based-identity-part-1_6'>Catching Up on Coding - Claims-Based Identity Part 1</a></li></ol></li><li class='history-month'><label for='2016-10'>October</label><input type='checkbox'  id='2016-10' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/creating-forms-authentication'>Creating Forms Authentication Membership Tables in LocalDB–Right and Wrong Ways</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/windows-10-complaint-1-auto-update'>Windows 10 Complaint #1: Auto Update State Loss</a></li></ol></li><li class='history-month'><label for='2016-9'>September</label><input type='checkbox'  id='2016-9' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/disable-windows-10-photo-automatic'>Disable Windows 10 Photo Automatic Albums</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/a-laymans-explanation-of-mocking-and'>A Layman’s Explanation of Mocking and Dependency Injection</a></li></ol></li><li class='history-month'><label for='2016-8'>August</label><input type='checkbox'  id='2016-8' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-3'>Catching Up on Coding - TDD Part 3</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-2'>Catching Up on Coding - TDD Part 2</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/catching-up-on-coding-tdd-part-1'>Catching Up on Coding - TDD Part 1</a></li></ol></li><li class='history-month'><label for='2016-7'>July</label><input type='checkbox'  id='2016-7' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/writing-to-current-users-registry-when'>Writing to the Current User(s) Registry When Running as System</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/catching-up-on-coding-syllabus'>Catching Up on Coding - The Syllabus</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/quickly-enable-mercurial-keyring-for'>Quickly Enable Mercurial Keyring for BitBucket</a></li></ol></li><li class='history-month'><label for='2016-6'>June</label><input type='checkbox'  id='2016-6' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/create-easily-debuggable-windows-service'>Create an Easily Debuggable Windows Service</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/underrated-work-skills'>(Underrated) Work Skills</a></li></ol></li><li class='history-month'><label for='2016-5'>May</label><input type='checkbox'  id='2016-5' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/vbnet-windows-project-to-c-conversion'>VB.Net Windows Project to C# Conversion Tools Quick Review</a></li></ol></li><li class='history-month'><label for='2016-2'>February</label><input type='checkbox'  id='2016-2' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/scroll-bars-in-blogger-tags'>Scroll bars in Blogger &lt;pre&gt; Tags</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/google-keep-changes-taking-to-forums'>Google Keep Changes: Taking to the Forums</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/backward-step-for-google-keep'>Backward Step for Google Keep</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/recover-virtualbox-snapshots'>Recover VirtualBox Snapshots</a></li></ol></li><li class='history-month'><label for='2016-1'>January</label><input type='checkbox'  id='2016-1' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/auto-updating-new-windows-7-installation'>Auto Updating a New Windows 7 Installation</a></li></ol></li></ol></li><li class='history-year'><label for='2015'>2015</label><input type='checkbox'  id='2015' /><ol><li class='history-month'><label for='2015-8'>August</label><input type='checkbox'  id='2015-8' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/shoretel-brilliantly-simple'>ShoreTel - Brilliantly Simple?</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/the-google-photos-management-problems'>The Google Photos Management Problem(s)</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/creating-long-lasting-clickonce'>Creating a Long-Lasting ClickOnce Certificate</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/more-encrypted-config-filesclickonce'>More Encrypted Config Files–ClickOnce Complications</a></li></ol></li><li class='history-month'><label for='2015-7'>July</label><input type='checkbox'  id='2015-7' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/encrypting-appconfig'>Encrypting app.config</a></li></ol></li><li class='history-month'><label for='2015-3'>March</label><input type='checkbox'  id='2015-3' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/better-google-sites-designthe-notched'>Better Google Sites Design–The Notched Page</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/removing-unremovable-bluetooth-device'>Removing Unremovable Bluetooth Device: FAIL!</a></li></ol></li></ol></li><li class='history-year'><label for='2014'>2014</label><input type='checkbox'  id='2014' /><ol><li class='history-month'><label for='2014-11'>November</label><input type='checkbox'  id='2014-11' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/how-to-remove-savernet-and-similar'>How to remove Savernet (and similar) Chrome extension</a></li></ol></li><li class='history-month'><label for='2014-9'>September</label><input type='checkbox'  id='2014-9' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/prevent-word-from-restoring-minimized'>Prevent Word from Restoring Minimized Documents</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/clever-phish'>Clever Phish</a></li></ol></li><li class='history-month'><label for='2014-8'>August</label><input type='checkbox'  id='2014-8' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/enable-synaptics-touchpad-2-finger-tap'>Enable Synaptics touchpad 2-finger tap context menu</a></li></ol></li><li class='history-month'><label for='2014-5'>May</label><input type='checkbox'  id='2014-5' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/installing-fcm-flow-cytrometry-library'>Installing fcm flow cytrometry library on Windows 8.1</a></li></ol></li><li class='history-month'><label for='2014-4'>April</label><input type='checkbox'  id='2014-4' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/windows-81-update-1-driver-problem-dtmb'>Windows 8.1 Update 1 Driver Problem DTMB BDA TV USB</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/windows-81-window-key-s-search-from'>Windows 8.1: Window Key + S = Search from Desktop</a></li></ol></li><li class='history-month'><label for='2014-3'>March</label><input type='checkbox'  id='2014-3' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/whs-2011-windows-update-one-or-more'>WHS 2011 Windows Update “One or more services are no running” alert</a></li></ol></li><li class='history-month'><label for='2014-2'>February</label><input type='checkbox'  id='2014-2' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/lenovo-u530-touch-wifi-problem-continued'>Lenovo U530 Touch WiFi Problem Continued</a></li></ol></li><li class='history-month'><label for='2014-1'>January</label><input type='checkbox'  id='2014-1' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/lenovo-u530-touch-wifi-problem'>Lenovo U530 Touch WiFi Problem</a></li></ol></li></ol></li><li class='history-year'><label for='2013'>2013</label><input type='checkbox'  id='2013' /><ol><li class='history-month'><label for='2013-12'>December</label><input type='checkbox'  id='2013-12' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/whs-connector-restart-error-in-windows'>WHS Connector Restart Error in Windows 8.0/8.1</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/how-to-remove-apps-from-google-play-my'>How to Remove Apps from Google Play My Apps Site</a></li></ol></li><li class='history-month'><label for='2013-11'>November</label><input type='checkbox'  id='2013-11' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/windows-81-hidden-opt-ins-opt-outs'>Windows 8.1 Hidden Opt Ins/ Opt Outs</a></li></ol></li><li class='history-month'><label for='2013-9'>September</label><input type='checkbox'  id='2013-9' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/edward-farley-epilogue'>Edward Farley and the Fantastic Library Epilogue</a></li></ol></li><li class='history-month'><label for='2013-7'>July</label><input type='checkbox'  id='2013-7' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/a-week-or-more-of-jolicloud-day-2-end'>A Week (or More!) of JoliCloud - Day 2: THE END</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/a-week-or-more-of-jolicloud-day-1'>A Week (or More!) of JoliCloud - Day 1</a></li></ol></li><li class='history-month'><label for='2013-5'>May</label><input type='checkbox'  id='2013-5' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/edward-farley-part-12'>Edward Farley and the Fantastic Library Part 12</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/edward-farley-part-1019'>Edward Farley and the Fantastic Library Part 11</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/edward-farley-part-10'>Edward Farley and the Fantastic Library Part 10</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/edward-farley-part-9'>Edward Farley and the Fantastic Library Part 9</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/edward-farley-part-8'>Edward Farley and the Fantastic Library Part 8</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/edward-farley-part-7'>Edward Farley and the Fantastic Library Part 7</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/edward-farley-part-6'>Edward Farley and the Fantastic Library Part 6</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/edward-farley-part-5'>Edward Farley and the Fantastic Library Part 5</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/edward-farley-part-4'>Edward Farley and the Fantastic Library Part 4</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/edward-farley-part-3'>Edward Farley and the Fantastic Library Part 3</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/edward-farley-part-2'>Edward Farley and the Fantastic Library Part 2</a></li><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/edward-farley-part-1'>Edward Farley and the Fantastic Library Part 1</a></li></ol></li><li class='history-month'><label for='2013-4'>April</label><input type='checkbox'  id='2013-4' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/clean-up-orphaned-sql-users'>Clean Up Orphaned SQL Users</a></li></ol></li><li class='history-month'><label for='2013-3'>March</label><input type='checkbox'  id='2013-3' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/t-sql-one-to-one-cant-be-done'>T-SQL One to One Can't Be Done</a></li></ol></li><li class='history-month'><label for='2013-1'>January</label><input type='checkbox'  id='2013-1' /><ol><li class='history-post'><a class='history-post' href='https://www.softwaremeadows.com/posts/test-post-with-code'>Migrating Google Drive</a></li></ol></li></ol></li></ol>
        </div>
        <a href="javascript:void(0);" class="icon" onclick="toggleNav()">&#9776;</a>
      </nav>
    </div>
    <div class="col-right">
      <header>
        <div id="site-image">
          <img src="https://www.softwaremeadows.com/images/header.png" alt="" />
        </div>
        <h1 id="site-name"></h1>
        <div id="site-subtitle">A pleasant walk through computing</div>
      </header>
      <section id="content">
        
              <div class='post'>
                <h2 class='post-title'><a href='https://www.softwaremeadows.com/posts/why_the_repository_pattern_fails_for_legacy_database_like_yours_and_wh'>Why the Repository Pattern Fails for Legacy Databases Like Yours and What to Do About It</a></h2>
                <p class='post-info'><span class='posted-on'>2020-02-13 15:11</span></p>
                <div class='post-content'><p><a href="https://en.wikipedia.org/wiki/File:Repo-Man-Poster.jpg#/media/File:Repo-Man-Poster.jpg"><img src="https://upload.wikimedia.org/wikipedia/en/4/46/Repo-Man-Poster.jpg" alt="Repo-Man-Poster.jpg"></a><br>By Source, <a href="//en.wikipedia.org/wiki/File:Repo-Man-Poster.jpg" title="Fair use of copyrighted material in the context of Repo Man (film)">Fair use</a>, <a href="https://en.wikipedia.org/w/index.php?curid=10827447">Link</a></p>
<h2 id="contents">Contents</h2>
<ul>
<li><a href="#introduction:-a-classic-example-(spot-the-flaw?)">Introduction: A Classic Example (spot the flaw?)</a></li>
<li><a href="#implicit-architecture-rules">Implicit Architecture Rules</a></li>
<li><a href="#the-unnecessary-abstraction">The Unnecessary Abstraction</a></li>
<li><a href="#cutting-out-the-middleman">Cutting Out the Middleman</a></li>
<li><a href="#your-data-sources-will-change...">Your Data Sources Will Change...</a></li>
</ul>
<h2 id="introduction-a-classic-example-spot-the-flaw">Introduction: A Classic Example (spot the flaw?)</h2>
<p>One of the hallmarks of creating a loosely coupled architecture is using the repository pattern to return data. Each model's repository is implemented from an interface, and that interface is injected into, typically, a service.</p>
<pre><code class="language-csharp">namespace Company.Domain.DomainModels
{
    public class Customer
    {
        public int CustomerId {get; set;}
        public string Name {get; set;}
    }
}
</code></pre>
<pre><code class="language-csharp">namespace Company.Domain.DataInterfaces
{
    public interface IRepository&lt;T&gt; where T: class
    {
        T Single(Expression&lt;Func&lt;T, bool&gt; where);
        IEnumerable&lt;T&gt; Many(Expression&lt;Func&lt;T, bool&gt; where);
    }
}
</code></pre>
<p>The concrete implementation, using Entity Framework 6.</p>
<pre><code class="language-csharp">namespace Company.Data
    public class CustomerRepository: IRepository&lt;Customer&gt;
    {
        CompanyDbContext _context = new CompanyDbContext();
        Customer Single(Expression&lt;Func&lt;Customer, bool&gt; where)
        {
            return _context.Customers.SingleOrDefault(where);   
        }
        IEnumerable&lt;Customer&gt; Many(Expression&lt;Func&lt;Customer, bool&gt; where)
        {
            return _context.Customers.Where(where);
        }
    }
}
</code></pre>
<p>The concrete customer service with the repository interface injected.</p>
<pre><code class="language-csharp">namespace Company.Services
{
    public class CustomerService: ICustomerService
    {
        IRepository&lt;Customer&gt; _customerRepository;
        
        public CustomerService(IRepository&lt;Customer&gt; customerRepository)
        {
            _customerRepository = customerRepository
        }
        
        public Customer GetCustomer(int id)
        {
            return _customerRepository.Single(a =&gt; a.CustomerId == id);
        }
        
        public List&lt;Customers&gt; GetCustomers(Expression&lt;Func&lt;Customer, bool&gt;&gt; where)
        {
            return _customerRepository.Many(where);
        }
    }
}
</code></pre>
<p>A unit test. (Note this is a lousy unit test because it's &quot;testing&quot; a data passthrough, but it illustrates the point.)</p>
<pre><code class="language-csharp">using XUnit;
using NSubstitute;
using FluentAssertions;

namespace Company.Tests
{
    public class CustomerService_Should
    {
        [Fact]
        public void Return_one_customer()
        {
            int id = 1;
            Customer expected = new Customer() {CustomerId = 1;}
            var customerRepository = Substitute.For&lt;IRepository&lt;Customer&gt;&gt;();
            var customerService = new CustomerService(customerRepository);
            customerRepository.Single((a =&gt; a.CustomerId == id).Returns(expected);
            var result = customerService.GetCustomer(id);
            result.Should().BeEquivalentTo(expected);
        }
    }
}
</code></pre>
<p>The namespaces indicate where in the<a href="https://jeffreypalermo.com/2008/07/the-onion-architecture-part-1/"> Onion Architecture</a> the classes belong.</p>
<ol>
<li>Core: <code>Customer</code> represents a company customer. It has no behavior.</li>
<li>Core: IRepository is our generic standard for getting data. By injecting this standard into services, we can swap out the database by simply implementing it in a new concrete repository.</li>
<li>Core: ICustomerService is our contract for what a CustomerService should implement</li>
<li>Data: CustomerRepository is the concrete instance that will return models from the database.</li>
<li>Service: CustomerService is the concrete instance that returns models to the client.</li>
</ol>
<blockquote>
<p><strong>Hint</strong> The flaw with the repository pattern is #2 and #4.</p>
</blockquote>
<p><img src="https://i0.wp.com/jeffreypalermo.com/wp-content/uploads/2018/06/image257b0257d255b59255d.png?resize=366%2c259&amp;ssl=1" alt="" />
Image Copyright Jeffrey Palermo</p>
<h2 id="implicit-architecture-rules">Implicit Architecture Rules</h2>
<p>Implicit in the Onion architecture are these rules:</p>
<ol>
<li>Domain Models represent the way the organization really works.</li>
<li>Domain Services return Domain Models. (e.g. CustomerService returns Customer)</li>
<li>Data Services return Data Models (e.g. CustomerRepository returns...Customer, in this case)</li>
<li>APIs return with View Models (MVC Controllers, WebApi return something like CustomerMaintModel)</li>
<li>UIs work with View Models</li>
</ol>
<p>This is a loosely coupled architecture. By using interfaces, it's also highly testable.</p>
<p>So, what's wrong with it?</p>
<blockquote>
<p>The repository expects to return a domain model from the database. And that's not how most databases, especially legacy databases, are designed.</p>
</blockquote>
<p>Let's make sure this is really clear, because it's the flaw in every example I've seen of this architecture. Here's how the domain and database stay loosely coupled.</p>
<ol>
<li>The domain models represent how the organization sees information.</li>
<li>The database models represent how the data is stored.</li>
<li>The domain should have no knowledge of the database.</li>
</ol>
<blockquote>
<p>The mistake I've seen is that organizations' repositories return their <em>data models</em>, not domain models. They then rely on the service to map to the domain models. This means the repositories are tightly coupled to the data model.</p>
</blockquote>
<p>In this light, look at the classic example again. The repository returns a Customer object. Customer is a <em>domain</em> model. This means that, if the database tables aren't one-to-one matches to the domain models, we have two choices in mapping the table model to the domain model.</p>
<ol>
<li><p>Use IRepository<CustFile> and have the CustomerService do the mapping. For instance, the <code>List&lt;Customer&gt; GetCustomers()</code> method would get the data from the CustFileRepository and populate a Customer list.</p>
<blockquote>
<p>This is how I've seen most organizations try to do it. But we've tightly coupled our data model to our domain's IRepository. The data model is now part of the domain model. If we wanted to swap out the database, <em>it would have to have a CustFile table</em>. If it doesn't, we're rewriting the repositories and injecting new interfaces into the services.</p>
</blockquote>
</li>
<li><p>Use IRepository<Customer> and have the CustomerRepository do the mapping. For instance, the <code>IEnumerable&lt;Customer&gt; Many()</code> method would get the data using a data model such as CustFile and populate a Customer list. There's no guarantee CustFile has the same properties as Customer.</p>
<blockquote>
<p>This would be &quot;more right&quot; since there'd be loose coupling to the data. We could supposedly swap out the database. But as you'll see it won't work the way you think, and becomes an unnecessary layer of abstraction.</p>
</blockquote>
</li>
</ol>
<p>Let's try doing the second way. But let's use a more real-world scenario.</p>
<p>The customer data is stored in two Microsoft SQL Server tables that were created over the course of ten years. The extended table was used to handle new columns for the original table. Note the different primary key names and storing name information in a weird way. Also, there's no foreign key for the one-to-zero-one relationship.</p>
<pre><code class="language-txt">CustFile
=========
CustId   int PK
FullName varchar(100)

CustFileExtended
===============
CustomerNumber int PK
Zip5           int
</code></pre>
<p>We need data models specific to these tables.</p>
<pre><code class="language-csharp">namespace Company.Data.DataModels
{
    public class CustFile
    {
        public int CustId { get; set; }
        public string FullName { get; set; }
    }
    
    public class CustFileExtended
    {
        public int CustNumber { get; set; }
        public int Zip5 { get; set; }
    }
}
</code></pre>
<p>To keep the example clear, we'll use an explicit ICustomerRepository. Remember, in order to be loosely coupled, this repository returns a Customer domain model.</p>
<blockquote>
<p>If it returned CustFile and CustFileExtended models, then those data models would have to be part of the Domain. And <em>that</em> would tightly couple the abstract domain model to the concrete data model.</p>
</blockquote>
<pre><code class="language-csharp">namespace Company.Domain.DataInterfaces
{
    public interface ICustomerRepository
    {
        // Create
        Customer Create(Customer entity);

        // Retrieve
        Customer RetrieveSingle(int id);
        IEnumerable&lt;Customer&gt; RetrieveMany();
        IEnumerable&lt;Customer&gt; RetrieveMany(Expression&lt;Func&lt;Customer, bool&gt;&gt; where);

        // Update
        Customer Update(Customer entity);

        // Delete
        void Delete(int id);
    }
}
</code></pre>
<blockquote>
<p>Note the use of Expression. That's coupling to Queryables, which are provider-dependent.</p>
</blockquote>
<p>Now we'll try to implement the repository using Entity Framework. To make the problem clear, we'll only look at the RetrieveMany methods.</p>
<pre><code class="language-csharp">namespace Company.Data
{
    public class CustomerRepository : ICustomerRepository
    {
        private CompanyDbContext _context;
        public CustomerRepository(CompanyDbContext context)
        {
            _context = context;
        }
        
        public IEnumerable&lt;Customer&gt; RetrieveMany()
        {
            // Now what?
        }
        
        public IEnumerable&lt;Customer&gt; RetrieveMany(Expression&lt;Func&lt;Customer, bool&gt;&gt; where)
        {
            // Now what?
        }
    }
}
</code></pre>
<p>We'll assume we can mock the context somehow. But this is where things go awry.</p>
<blockquote>
<p>Many organizations end up adding IRepository and IUnitOfWork to DbSet and DbContext. Patterns on top of patterns. Abstractions on top of abstractions!</p>
</blockquote>
<p>How do we return a collection of Customers? Remember, we're getting the data from two different tables.</p>
<blockquote>
<p><strong>Important</strong> The calls to the database have no knowledge of what a Customer is.</p>
</blockquote>
<pre><code class="language-csharp">public IEnumerable&lt;Customer&gt; RetrieveMany()
{
    List&lt;Customer&gt; customers = new List&lt;Customer&gt;();
    
    // there's no filtering, so get all records. That's right. ALL OF THEM.
    var custFiles = _context.CustFiles.ToList();
    int[] ids = custFiles.Select(a =&gt; a.CustId).ToArray();
    var custFileExtendeds = _context.CustFileExtendeds.Where(a =&gt; ids.Contains(a.CustNumber)).ToList();
    
    customers = custFiles.Select(a =&gt; new Customer()
    {
       CustomerId = a.CustId,
       Name = a.FullName,
       ZipCode = custFileExtendeds.SingleOrDefault(b =&gt; b.CustNumber == a.CustId)?.Zip5
    });
    
    return customers;
}
</code></pre>
<p>We're using a generic repository pattern, which is typically going to include a method such as above because sometimes we <em>do</em> want all the records. But not if there are a hundred million. OK, let's try filtering.</p>
<pre><code class="language-csharp">public IEnumerable&lt;Customer&gt; RetrieveMany(Expression&lt;Func&lt;Customer, bool&gt;&gt; where)
{
    List&lt;Customer&gt; customers = new List&lt;Customer&gt;();
    
    // And...now what?
}
</code></pre>
<p>We have a filter expression that can be examined for its properties and conditions. So at first it <em>seems</em> like all we have to do is</p>
<ol>
<li>Extract the Customer properties</li>
<li>Map them to the CustFile and CustFileExtended properties</li>
<li>Pull out the boolean conditions</li>
<li>Create Expressions from the properties and conditions and apply the filters to the appropriate CustFile or CustFileExtended DbSets.</li>
<li>Build and return the Customer list.</li>
</ol>
<p>That's...actually, a lot of work. And wait...that's not complete, is it? There could be a few more steps after 4.</p>
<ol start="5">
<li>Programmatically handle a CustFile property that's filtering based on a CustFileExtended property. E.g. <code>Customer.Discount == Customer.MaxDiscount</code>. Except in the database it's CustFile.Discount and CustFileExtended.MaxDiscount. How's that going to work?</li>
<li>Programmatically handle nested conditions that go across table properties. Good luck to you.</li>
<li>Hope to heck a Customer property being filtered on isn't made up of two properties from two different tables.</li>
</ol>
<p>and so on until...</p>
<ol start="99">
<li>Build and return the Customer list and pray it's right.</li>
</ol>
<p>OK, so maybe we need custom repository interfaces for each domain model. Then we can make the client supply known filters like customer ids, get our initial datasets down to a managable size, then filter on the domain model.</p>
<pre><code class="language-csharp">//No need for an Expression since List&lt;Customer&gt; is generic.
public IEnumerable&lt;Customer&gt; RetrieveMany(int zipCode, Func&lt;Customer, bool&gt; where)
{
    List&lt;Customer&gt; customers = new List&lt;Customer&gt;();
    var custFileExtendeds = _context.CustFileExtendeds.Where(a =&gt; a.Zip5 == zipCode).ToList();
    //Build the customer list and add the filter at the end.
    return custFileExtendeds.Select(a =&gt; new Customer()
    {
       CustomerId = a.CustNumber,
       ZipCode = a.Zip5,
       Name = _context.CustFiles.Single(a =&gt; a.CustId == a.CustNumber).FullName
    }).Where(where);
}
</code></pre>
<p>And the Service method would look like this:</p>
<pre><code class="language-csharp">public List&lt;Customer&gt; GetCustomers(int zipCode, Func&lt;Customer, bool&gt; where)
{
    return _customerRepository.RetrieveMany(zipCode, where);
}
</code></pre>
<p>Seeing that service method, you're hopefully asking some important questions. Like...</p>
<blockquote>
<p>What if my domain model was being populated by data from multiple databases and maybe a web service?</p>
<p>What's the repository pattern gaining me?</p>
</blockquote>
<h2 id="the-unnecessary-abstraction">The Unnecessary Abstraction</h2>
<p>We've discovered a few things about having separate domain and data models.</p>
<ol>
<li>No matter what, we need to map data models to domain models.</li>
<li>We can't have fully flexible filtering.</li>
<li>The mapping problems using IRepository<Customer> methods are the same as with CustomerService methods. Specifically, the methods need to restrict the data that will come from the database in order for performance to be good.</li>
</ol>
<p>There's one other requirement: whatever data sources are injected into CustomerService need to be mockable.</p>
<p>Whenever you see a passthrough query such as shown above in CustomerService.GetCustomers, it's worth asking, &quot;Can I cut out the middleman?&quot;</p>
<p>The answer here is &quot;Yes.&quot; The repository is just getting in the way. We know the concrete CustomerService will depend on concrete data. The repository is just an abstraction of that data so we can unit test. We've already determined that if we want to swap out the database, we're going to be rewriting something. Why add to our troubles by essentially <em>writing our CustomerService methods twice</em>?</p>
<blockquote>
<p><strong>Solution</strong> Inject the mockable data source directly into the service</p>
</blockquote>
<p>If the data source uses an interface, great. If there are multiple data sources, do whatever it takes to make them mockable. But don't use a repository abstraction. It just adds complexity for no gain.</p>
<h2 id="cutting-out-the-middleman">Cutting Out the Middleman</h2>
<p>Here's how our CustomerService example looks with the repository removed, organized by onion layers. These could be different assemblies.</p>
<p><strong>Domain</strong></p>
<pre><code class="language-csharp">namespace Company.Domain.DomainModels
{
    public class Customer
    {
        public int CustomerId { get; set; }
        public string Name { get; set; }
        public int ZipCode { get; set; }

    }
}
</code></pre>
<pre><code class="language-csharp">namespace Company.Domain.ServiceInterfaces
{
    public interface ICustomerService
    {
        //Create
        Customer Create(Customer customer);

        //Retrieve
        Customer RetrieveSingleById(int id);
        Customer RetrieveSingleByName(string name);
        List&lt;Customer&gt; RetrieveManyByIds(int[] ids);
        List&lt;Customer&gt; RetrieveManyByPartialName(string partialName);
        List&lt;Customer&gt; RetrieveManyByZipCode(int zipCode, Func&lt;Customer, bool&gt; where);

        //Update
        Customer Update(Customer customer);

        //Delete
        void Delete(int id);

    }
}
</code></pre>
<p><strong>Data</strong></p>
<pre><code class="language-csharp">namespace Company.Data.DataModels
{
    public class CustFile
    {
        public int CustId { get; set; }
        public string FullName { get; set; }
    }
    
    public class CustFileExtended
    {
        public int CustNumber { get; set; }
        public int Zip5 { get; set; }
    }
}
</code></pre>
<pre><code class="language-csharp">namespace Company.Data.SqlDatabase
{
    public class SqlDbContext : DbContext
    {
        public IDbSet&lt;CustFile&gt; CustFiles { get; set; }
        public IDbSet&lt;CustFileExtended&gt; CustFileExtendeds {get;set;}

        public SqlDbContext(string nameOrConnectionString) : base(nameOrConnectionString) { }
        
        //This constructor is used by Effort in unit testing
        public SqlDbContext(DbConnection existingConnection) : base(existingConnection, true) { }

        protected override void OnModelCreating(DbModelBuilder modelBuilder)
        {
            modelBuilder.Entity&lt;CustFile&gt;()
                .HasKey(a =&gt; a.CustId);

            modelBuilder.Entity&lt;CustFileExtended&gt;()
                .HasKey(a =&gt; a.CustNumber);
        }
    }
}

</code></pre>
<p><strong>Services</strong></p>
<p>This is only showing one method.</p>
<pre><code class="language-csharp">namespace Company.Services
{
    public class CustomerService : ICustomerService
    {
        SqlDbContext _context = new EF6Context(&quot;SqlDb&quot;);

        public CustomerService(SqlDbContext context)
        {
            _context = context;
        }

        public List&lt;Customer&gt; RetrieveManyByZipCode(int zipCode, Func&lt;Customer, bool&gt; where)
        {
            var custFileExtendeds = _context.CustFileExtendeds.Where(a =&gt; a.Zip5 == zipCode).ToList();
            return GetCustomers(custFileExtendeds)
                .Where(where).ToList();
        }
        
        // Helpers for mapping
        private List&lt;Customer&gt; GetCustomers(List&lt;CustFile&gt; custFiles)
        {
            List&lt;Customer&gt; customers = new List&lt;Customer&gt;();
            var custFileExtendeds = _context.CustFileExtendeds
                .Where(a =&gt; customers.Select(b =&gt; b.CustomerId).ToList().Contains(a.CustNumber)).ToList();

            customers.AddRange(custFiles.Select(a =&gt;
            {
                var custFileExtended = custFileExtendeds.Single(b =&gt; b.CustNumber == a.CustId);
                return new Customer()
                {
                    CustomerId = a.CustId,
                    Name = a.FullName,
                    ZipCode = custFileExtended.Zip5
                };
            }));

            return customers;
        }

        private List&lt;Customer&gt; GetCustomers(List&lt;CustFileExtended&gt; custFileExtendeds)
        {
            int[] ids = custFileExtendeds.Select(a =&gt; a.CustNumber).ToArray();
            var custFiles = _context.CustFiles.Where(a =&gt; ids.Contains(a.CustId)).ToList();
            return GetCustomers(custFiles);
        }
    }
}
</code></pre>
<p><strong>Test</strong></p>
<p>There are various ways to mock Entity Framework. I like <a href="https://entityframework-effort.net/overview">Effort</a> because you don't need to add interfaces to your DbContext, you just need a particular constructor.</p>
<pre><code class="language-csharp">//other usings above, these are the testing dependencies
using Company.Data;
using Company.Data.DataModels;
using Company.Domain.DomainModels;
using Company.Domain.ServiceInterfaces;
using Company.Services;
using Xunit;
using Effort;
using FluentAssertions;

namespace DealingWithData.Tests
{
    public class CustomerService_Should
    {
        SqlDbContext _context;
        ICustomerService _customerService;

        public CustomerService_Should()
        {
            //This is what makes Effort the in-memory database
            _context = new SqlDbContext(DbConnectionFactory.CreateTransient());
            _customerService = new CustomerService(_context);
        }

        ~CustomerService_Should() 
        {
            _context.Dispose();
        }

        [Fact]
        public void Return_a_single_customer_by_id()
        {
            // arrange
            Customer expected = new Customer()
            {
                CustomerId = 1,
                Name = &quot;Herbert&quot;,
                ZipCode = 12345
            };
            // mock the data the service works with
            _context.CustFiles.Add(new CustFile() { CustId = 1, FullName = &quot;Herbert&quot; });
            _context.CustFileExtendeds.Add(new CustFileExtended() { CustNumber = 1, Zip5 = 12345 });
            _context.SaveChanges();

            // act
            var actual = _customerService.RetrieveSingleById(expected.CustomerId);

            // assert
            actual.Should().BeEquivalentTo(expected);
        }
    }
}
</code></pre>
<p>If...when...we have changes in our data sources, we'll have to update the service and the unit tests. That's OK. Before, we'd have been updating repositories and unit tests. This removes the repository pattern dead weight.</p>
<h2 id="your-data-sources-will-change">Your Data Sources Will Change...</h2>
<p>Sometimes radically. Your domain model will change, too, but it shouldn't be driven by the backend data. You should be able to code and unit test without <em>any</em> concrete dependencies, and it shouldn't be painful.</p>
<p>Do you really need the Repository pattern? Probably not.</p>
</div>
              </div>
              
        <p id="comment">
          Comment for me? Send an <a href="mailto:charles@tfhome.us?subject=Comment on Why The Repository Pattern Fails For Legacy Databases Like Yours And What To Do About It | Software Meadows">email</a>. I might even update the post!
        </p>
        

      </section>
      <!-- posts only appear in home index -->
      <section id="posts">
         
      </section>
      <footer><p>All original content copyright (c) Charles L Flatt</p>
</footer>
    </div>
  </div>
  
  <script>
    function toggleNav() {
      var x = document.getElementById("nav");
      if (x.className === "nav") {
        x.className += " responsive";
      } else {
        x.className = "nav";
      }
    }</script>

  

</body>

</html>