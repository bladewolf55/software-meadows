<!DOCTYPE html>
<html>
  <head>
    <title>IdentityServer3 with PKCE Part 2 - Protected Resource Server</title>
    <link rel="stylesheet" type="text/css" href="/css/default.css">
  </head>
  <body>
    <header>Goat Blog</header>
    <nav>
      <ul>
        <li><a href="/">Home</a></li>
        <li class="dropdown">
          <a href="/about">About</a>
          <div class="dropdown-content">
            <a href="/about/contact">Contact Us</a>
            <a href="/about-team">Our Team</a>
          </div>
        </li>
      </ul>
    </nav>
   	<aside id="sidebar">
	   <div id="recent">
       <p><strong>History</strong></p>
       <ol class='tree'><li class='history-year'><label for='2017'>2017</label><input type='checkbox'  id='2017' /><ol><li class='history-month'><label for='2017-8'>August</label><input type='checkbox'  id='2017-8' /><ol><li class='post'><a class='post' href='/posts/dont-use-data-prefix-in-angularjs'>Don't use "data" prefix in AngularJS</a></li></ol></li><li class='history-month'><label for='2017-7'>July</label><input type='checkbox'  id='2017-7' /><ol><li class='post'><a class='post' href='/posts/angularjs-service-with-var-declarations'>AngularJS service with var declarations instead of this. assignments</a></li></ol></li><li class='history-month'><label for='2017-6'>June</label><input type='checkbox'  id='2017-6' /><ol><li class='post'><a class='post' href='/posts/factory-resetting-android-without'>Factory Resetting Android Without Losing Your Life (Metaphorically)</a></li></ol></li><li class='history-month'><label for='2017-5'>May</label><input type='checkbox'  id='2017-5' /><ol><li class='post'><a class='post' href='/posts/identityserver3-with-pkce-part-4'>IdentityServer3 with PKCE Part 4 - Persisting User Data</a></li><li class='post'><a class='post' href='/posts/identityserver3-with-pkce-part-3'>IdentityServer3 with PKCE Part 3 - Persist IdentityServer Configuration</a></li><li class='post'><a class='post' href='/posts/identityserver3-with-pkce-part-2'>IdentityServer3 with PKCE Part 2 - Protected Resource Server</a></li><li class='post'><a class='post' href='/posts/identityserver3-with-pkce-part-1-simple'>IdentityServer3 with PKCE Part 1 - Simple OAuth2 Server</a></li></ol></li><li class='history-month'><label for='2017-3'>March</label><input type='checkbox'  id='2017-3' /><ol><li class='post'><a class='post' href='/posts/tfs-continuous-integration-walk-through'>TFS Continuous Integration Walk Through Part 5c - Multiple Solutions: Dependencies</a></li><li class='post'><a class='post' href='/posts/sane-database-schema-conventions'>Sane Database Schema Conventions</a></li></ol></li></ol></li></ol>
      </div>
	    <div id="tags"></div>
	  </aside>
    <section id="content"><div class='post-title'>
                <a href='https://bladewolf55.gitlab.io/posts/identityserver3-with-pkce-part-2'><h1>IdentityServer3 with PKCE Part 2 - Protected Resource Server</h1></a>
                <p class='post-info'>2017-05-08 10:07</p>
            </div><p>This series simulates a native application accessing a protected Web API resource, using OAuth2 via <a href="https://github.com/IdentityServer/IdentityServer3">IdentityServer3</a>. It demonstrates using Proof Key for Code Exchange (PKCE), and is in four parts:</p>
<ol>
<li><a href="http://www.softwaremeadows.com/2017/05/identityserver3-with-pkce-part-1-simple.html">Build a simple authorization server, consumed by native application</a>.</li>
<li><a href="http://www.softwaremeadows.com/2017/05/identityserver3-with-pkce-part-2.html">Build a protected resource</a>.</li>
<li><a href="http://www.softwaremeadows.com/2017/05/identityserver3-with-pkce-part-3.html">Persist server configuration to database</a>.</li>
<li><a href="http://www.softwaremeadows.com/2017/05/identityserver3-with-pkce-part-4.html">Persist user data to database using Microsoft.Identity and SQL Server</a>.</li>
</ol>
<blockquote>
<p><strong>Important</strong><br />
This series does <em>not</em> create an OpenID Connect (OIDC) server. It is OAuth-only, since the PKCE specification doesn't require OIDC.</p>
</blockquote>
<h1 id="where-were-at">Where We're At</h1>
<p>We can get a token, but there's nothing to use it on. We've configured IdentityServer with information about our client application (PretendMobile), and we used that information (Client ID, etc) to get a token.</p>
<p>Now we'll add a Web API with a protected method that just returns some claim data. It will be configured to:</p>
<ol>
<li>Accept the access token our pretend mobile app gets from the authorization server.</li>
<li>Validate that token against the authorization server.</li>
</ol>
<p>We'll use the same project as the authorization server, but it's important to know that the Web API could be in a completely separate project.</p>
<h2 id="web-api">Web API</h2>
<p><strong>References</strong><br />
<a href="https://identityserver.github.io/Documentation/docsv2/overview/simplestOAuth.html">Simplest OAuth Server</a><br />
<a href="https://github.com/IdentityServer/IdentityServer3.Samples/tree/master/source/Simplest%20OAuth2%20Walkthrough">Simplest OAuth2 Walkthrough Code</a></p>
<p>Install the packages for Web API, and being able to accept the IdentityServer tokens. Note IdentityModel version, which is latest for .Net 4.6 (2.x is for .Net Core).</p>
<div class="sourceCode"><pre class="sourceCode csharp"><code class="sourceCode cs">Install-Package Microsoft.<span class="fu">AspNet</span>.<span class="fu">WebApi</span>.<span class="fu">Client</span> -Version <span class="fl">5.2</span>.<span class="fu">3</span> -Project AuthAndApi
Install-Package Microsoft.<span class="fu">AspNet</span>.<span class="fu">WebApi</span>.<span class="fu">Owin</span> -Version <span class="fl">5.2</span>.<span class="fu">3</span> -Project AuthAndApi
Install-Package IdentityModel -Version <span class="fl">1.9</span>.<span class="fu">2</span> -Project AuthAndApi
Install-Package IdentityServer3.<span class="fu">AccessTokenValidation</span> -Version <span class="fl">2.15</span>.<span class="fu">0</span> -Project AuthAndApi</code></pre></div>
<p>Add two things to the OWIN pipeline: accepting access tokens, and using WebApi.</p>
<p><strong>Updated Startup.cs</strong></p>
<div class="sourceCode"><pre class="sourceCode csharp"><code class="sourceCode cs"><span class="kw">using</span> System;
<span class="kw">using</span> System.<span class="fu">Collections</span>.<span class="fu">Generic</span>;
<span class="kw">using</span> System.<span class="fu">Linq</span>;
<span class="kw">using</span> System.<span class="fu">Web</span>;
<span class="co">//Added</span>
<span class="kw">using</span> IdentityServer3.<span class="fu">Core</span>.<span class="fu">Configuration</span>;
<span class="kw">using</span> Owin;
<span class="kw">using</span> AuthAndApi.<span class="fu">IdOptions</span>;
<span class="kw">using</span> AuthAndApi.<span class="fu">IdUsers</span>;
<span class="kw">using</span> System.<span class="fu">Web</span>.<span class="fu">Http</span>;
<span class="kw">using</span> IdentityServer3.<span class="fu">AccessTokenValidation</span>;

<span class="kw">namespace</span> AuthAndApi
{
    <span class="kw">public</span> <span class="kw">class</span> Startup
    {
        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Configuration</span>(IAppBuilder app)
        {
            <span class="co">//Configure IdentityServer for issuing authentication tokens</span>
            <span class="dt">var</span> options = <span class="kw">new</span> IdentityServerOptions
            {
                Factory = <span class="kw">new</span> <span class="fu">IdentityServerServiceFactory</span>()
                .<span class="fu">UseInMemoryClients</span>(Clients.<span class="fu">Get</span>())
                .<span class="fu">UseInMemoryScopes</span>(Scopes.<span class="fu">Get</span>())
                .<span class="fu">UseInMemoryUsers</span>(Users.<span class="fu">Get</span>()),
                <span class="co">//SSL MUST be used in production</span>
<span class="kw">#if</span> DEBUG
                RequireSsl = <span class="kw">false</span>
<span class="kw">#endif</span>
            };
            app.<span class="fu">UseIdentityServer</span>(options);

            <span class="co">// Configure Web API to accept access tokens from IdentityServer, and require a scope of &#39;email&#39;</span>
            app.<span class="fu">UseIdentityServerBearerTokenAuthentication</span>(<span class="kw">new</span> IdentityServerBearerTokenAuthenticationOptions
            {
                <span class="co">//In this case, the authorization server is also the Web API server</span>
                Authority = <span class="st">&quot;http://localhost:27230&quot;</span>,
                ValidationMode = ValidationMode.<span class="fu">ValidationEndpoint</span>,
                RequiredScopes = <span class="kw">new</span>[] { <span class="st">&quot;email&quot;</span> }
            });

            <span class="co">//Configure Web API</span>
            <span class="dt">var</span> config = <span class="kw">new</span> <span class="fu">HttpConfiguration</span>();
            config.<span class="fu">MapHttpAttributeRoutes</span>();
            app.<span class="fu">UseWebApi</span>(config);
        }
    }
}</code></pre></div>
<p>Add a Controllers folder, and a controller named Test.</p>
<p><a href="images/2017-05-06_114024_thumb"><img src="images/2017-05-06_114024_thumb" title="2017-05-06_114024" alt="2017-05-06_114024" width="699" height="422" /></a><a href="images/2017-05-06_114144_thumb1"><img src="images/2017-05-06_114144_thumb1" title="2017-05-06_114144" alt="2017-05-06_114144" width="714" height="442" /></a><a href="images/2017-05-06_114210_thumb"><img src="images/2017-05-06_114210_thumb" title="2017-05-06_114210" alt="2017-05-06_114210" width="600" height="134" /></a></p>
<p>Create an API method that requires authorization. The method checks for evidence a user authorized (and not just the application).</p>
<blockquote>
<p><strong>Note</strong><br />
Code shamelessly stolen from the IdentityServer samples</p>
</blockquote>
<p><strong>TestController.cs</strong></p>
<div class="sourceCode"><pre class="sourceCode csharp"><code class="sourceCode cs"><span class="kw">using</span> System;
<span class="kw">using</span> System.<span class="fu">Collections</span>.<span class="fu">Generic</span>;
<span class="kw">using</span> System.<span class="fu">Linq</span>;
<span class="kw">using</span> System.<span class="fu">Net</span>;
<span class="kw">using</span> System.<span class="fu">Net</span>.<span class="fu">Http</span>;
<span class="kw">using</span> System.<span class="fu">Web</span>.<span class="fu">Http</span>;
<span class="co">//Added</span>
<span class="kw">using</span> System.<span class="fu">Security</span>.<span class="fu">Claims</span>;

<span class="kw">namespace</span> AuthAndApi.<span class="fu">Controllers</span>
{
    [<span class="fu">Route</span>(<span class="st">&quot;test&quot;</span>)]
    [Authorize]
    <span class="kw">public</span> <span class="kw">class</span> TestController : ApiController
    {
        <span class="kw">public</span> IHttpActionResult <span class="fu">Get</span>()
        {
            <span class="dt">var</span> user = User <span class="kw">as</span> ClaimsPrincipal;

            <span class="dt">var</span> subjectClaim = user.<span class="fu">FindFirst</span>(<span class="st">&quot;sub&quot;</span>);
            <span class="kw">if</span> (subjectClaim != <span class="kw">null</span>)
            {
                <span class="kw">return</span> <span class="fu">Json</span>(<span class="kw">new</span>
                {
                    message = <span class="st">&quot;OK user&quot;</span>,
                    client = user.<span class="fu">FindFirst</span>(<span class="st">&quot;client_id&quot;</span>).<span class="fu">Value</span>,
                    subject = subjectClaim.<span class="fu">Value</span>,
                    email = user.<span class="fu">FindFirst</span>(<span class="st">&quot;email&quot;</span>).<span class="fu">Value</span>
                });
            }
            <span class="kw">else</span>
            {
                <span class="kw">return</span> <span class="fu">Json</span>(<span class="kw">new</span>
                {
                    message = <span class="st">&quot;User claim not found for this client_id&quot;</span>,
                    client = user.<span class="fu">FindFirst</span>(<span class="st">&quot;client_id&quot;</span>).<span class="fu">Value</span>
                });
            }
        }
    }
}</code></pre></div>
<p>The API server now has a protected resource. Let's prove it requires authorization. Run the application. The console will still get an access token, but we're not doing anything with it, yet. Leave the project running and manually enter this URL into a browser to try to access the protected resource.</p>
<p><code>http://localhost:27230/test</code></p>
<p>The server will return something like this:</p>
<div class="sourceCode"><pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;Error&gt;</span>
  <span class="kw">&lt;Message&gt;</span>Authorization has been denied for this request.<span class="kw">&lt;/Message&gt;</span>
<span class="kw">&lt;/Error&gt;</span></code></pre></div>
<h2 id="pretend-mobile-app---access-protected-resource">Pretend Mobile App - Access Protected Resource</h2>
<p>In the PretendMobile project, add and call a method that access the protected Web API resource. The token is added to the request in the Authorization header.</p>
<div class="sourceCode"><pre class="sourceCode csharp"><code class="sourceCode cs">        <span class="kw">static</span> <span class="dt">void</span> <span class="fu">Main</span>(<span class="dt">string</span>[] args)
        {
            <span class="co">//get token</span>
            <span class="dt">var</span> response = <span class="fu">GetAccessToken</span>();
            Console.<span class="fu">WriteLine</span>(<span class="st">&quot;Access Token: &quot;</span> + response.<span class="fu">AccessToken</span>);
            <span class="co">//use token</span>
            <span class="fu">CallProtectedApiResource</span>(response.<span class="fu">AccessToken</span>);
            Console.<span class="fu">ReadLine</span>();
        }

        <span class="kw">static</span> <span class="dt">void</span> <span class="fu">CallProtectedApiResource</span>(<span class="dt">string</span> access_token)
        {
            <span class="dt">var</span> client = <span class="kw">new</span> <span class="fu">HttpClient</span>();
            client.<span class="fu">SetBearerToken</span>(access_token);
            Console.<span class="fu">WriteLine</span>(client.<span class="fu">GetStringAsync</span>(<span class="st">&quot;http://localhost:27230/test&quot;</span>).<span class="fu">Result</span>);
        }</code></pre></div>
<p>Run the solution. After authorizing, the application successfully gets the protected resource's data.</p>
<p><a href="images/2017-05-06_121035_thumb1"><img src="images/2017-05-06_121035_thumb1" title="2017-05-06_121035" alt="2017-05-06_121035" width="749" height="99" /></a></p>
<h1 id="wrap-up">Wrap Up</h1>
<p>We now have a fully functioning mobile application! Next up, persisting the IdentityServer configuration.</p>
</section>
    
    <footer><p>Copyright &copy; Charles L Flatt</p></footer>
  </body>
</html>
